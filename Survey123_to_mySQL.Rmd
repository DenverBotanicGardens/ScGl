---
title: "Survey123_to_mySQL"
author: "Michelle DePrenger-Levin"
date: "2024-06-12"
output: html_document
---

```{r}
rm(list=ls())

library(ggplot2)
library(tidyr)
library(dplyr)
library(stringr)

library(tidyverse)
library(sf)
library(mapview)
library(leaflet)

# library(remotes)
# remotes::install_github("r-spatial/mapview@429-update-to-webshot2")
```



2024 was the first year we collected data using a Survey123 form. The data needs to be reformatted to ingest by the PHP mySQL database.   
```{r}

currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))



## Transect and Site, 
demo2024 <- read.csv("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/Sclerocactus_glaucus_DemographicMonitoring_0.csv")

plants2024 <- read.csv("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/plantData_1.csv") 

sitesTransID <- read.csv("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/SitesTransectsDate.csv")

## Column names for annual data direct entry into dbg-research-db  
scgl_data_columns <- read.csv("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/_scgl_data.csv")
scgl_tags_columns <- read.csv("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/_scgl_tags.csv")

```



## Needed edits 
ScGl_tag_id  Site    transect    Site
528          5	     19	         Atwell Gulch - 108      should be 377 as Tag and the rest zero, add the tag_id

```{r}
plants2024$ScGl_tag_id[plants2024$Height == 377 & !is.na(plants2024$Height)] <- "528"
plants2024$Tag[plants2024$Height == 377 & !is.na(plants2024$Height)] <- "377"
plants2024$Height[plants2024$Tag == 377 & !is.na(plants2024$Height)] <- 0

plants2024 %>%
  filter(ScGl_tag_id == 528)


plants2024$Tag[plants2024$ObjectID == 3] <- 185.07

## A second measurement of the same plant
plants2024 <- plants2024 %>%
  filter(ObjectID != 1183)

## All NAs
plants2024 <- plants2024 %>%
  filter(ObjectID != 147)

## Plant 280.2 assigned to the wrong tag, should be new, not existing 
plants2024 <- plants2024 %>%
  mutate(Tag = case_when(ObjectID == 69 ~ "280.02",
                         TRUE ~ Tag)) 

```



# Option 1 - direct upload into the PHP MySQL database       

Remaining questions:    
      1. how to deal with the ScGl_data_id?     
      2. Note that "PhotoNumber" is now used to record the number of flowers or fruits     
      3. How to update (instead of add on) any changes to X, Y, or location, or tag number?   
      4. What happens to the old_tag_id... through duplicate_tag_id_2?
          Can update column by column so only need affected ones
      5. Save an update file with old location, the proposed new location, and the comments. Do quality control on the proposed new location, then upload to update. 
      6. Need a way to check that the update does what we think it's doing. Check that it matches. 
```{r}

data2QAQC <- plants2024 %>%
  left_join(demo2024, by = c("ParentGlobalID" = "GlobalID")) %>%
  left_join(sitesTransID, by = c("transect" = "TransectID")) %>%
  select(c(ObjectID.x, Site, Tag, x, y, Height:ScGl_tag_id, site:transect))

## Quality control, some errors in data entry  
## I assume if there was no ScGl_tag_id that the Tag is new
plants2024 %>%
  left_join(demo2024, by = c("ParentGlobalID" = "GlobalID")) %>%
  left_join(sitesTransID, by = c("transect" = "TransectID")) %>%
  select(c(Tag:ScGl_tag_id, site:transect, Site)) %>%
  write.csv(  file = paste("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/ScGl/datasets/annualdata2qualitycheck_", currentyr, ".csv", sep=""))


plants2024 %>%
  left_join(demo2024, by = c("ParentGlobalID" = "GlobalID")) %>%
  left_join(sitesTransID, by = c("transect" = "TransectID")) %>%
  select(c(Tag:ScGl_tag_id, site:transect, Site)) %>%
  filter(Tag == "" & !is.na(Height))

```



# 62 are Either NEW or errors
With data2QAQC I have a few duplicates!    
There are 254 without duplicates    
There are 198 without duplicates and only having tag information   
There are 187 that have height info but no ID (new??)   

Some with X and Y coordinates must be new tags. 
```{r}
data2QAQC %>%
  filter(is.na(ScGl_tag_id)) %>%
  # filter(Tag != "" & !is.na(Tag)) %>%
  filter(Height > 0) %>%
  distinct(ObjectID.x, .keep_all = TRUE) 
# %>%
#   summarize(n= n())

## 15 new ones? Or 15 needing x and y
data2QAQC %>%
  filter(is.na(ScGl_tag_id)) %>%
  filter(Height > 0) %>%
  distinct(ObjectID.x, .keep_all = TRUE) %>%
  # filter(grepl("Y ", Comments))
  filter(grepl(paste(c("Y ", "y ", "X ", "x "), collapse = "|"),
              Comments))


## Need to pull these out to replace the X and Y data


```


Notes:
ObjectID.x == 312; tag 762 is at Pond (id = 7); says X 23, Y 4.63. X is wrong. Should it be 0.23? 
    1171 X 0.44, Y 5.19. 
```{r}
data2QAQC %>%
  filter(Tag >= 1171 & Tag < 1172)
```




## Match formatting for the annual data  
## Setting to NULL acts to delete the column 
```{r}
toupload <- plants2024 %>%
  mutate(year = currentyr) %>%
  mutate(old_tag_id = NA) %>% 
  mutate(old_tag_id_2 = NA,
         old_pond_tag_id = NA,
         old_pond_transect_id = NA,
         duplicate_tag_id = NA,
         duplicate_tag_id_2 = NA) %>%
  select(c(ScGl_tag_id, year, Height, Width, Flowering, Browsing, X..Minis, Photo.Number, Comments, 
           old_tag_id:duplicate_tag_id_2))

## Make all NAs NULL - that's not so easy to do!
# toupload %>%
#   left_join()
#   write.csv(  file = paste("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/ScGl/datasets/annualdata2upload_", currentyr, ".csv", sep=""))

## Need to remove any tag information out of comments and move to location in tags

```


Quality control for the Individual plant location information task in the spreadsheet and the X and Y. I'm going to make a data frame with the old location information, the as is comments, and the proposed location information. I will attempt to automate the extraction of tag information from the comments and X and Y updates from the comments. 

```{r}



```


______________________________________________________________________________________________________________
# Option 2 - format to the paper upload   
Work site by site, then can have NEW 

To upload to MySQL through the PHP through the web format       

Step 1   
   download current year csv from database, save as ToEnter_2024     
Step 2   
   push to git
```{r}
## Add year to each data column 

## Needs to skip 3 non-blank rows to get to headers
headers <- read.csv(paste0("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/ToEnter_", currentyr, ".csv"), 
                    skip = 3,
                    header = FALSE, nrows = 1, as.is = TRUE)
# Only skip 4, it will ignore the top 3 blank rows
df2enter <- read.csv(paste0("https://raw.githubusercontent.com/DenverBotanicGardens/ScGl/master/datasets/ToEnter_", currentyr, ".csv"),, skip = 4, header = FALSE)

# Match gives first time it matches
headers[,match("Height (cm)", headers)] <- paste0("Height (cm)", currentyr - 2)
headers[,match("Width (cm)", headers)] <- paste0("Width (cm)", currentyr - 2)

headers[,match("Height (cm)", headers)] <- paste0("Height (cm)", currentyr - 1)
headers[,match("Width (cm)", headers)] <- paste0("Width (cm)", currentyr - 1)

headers[,"Comments" == headers][2] <- paste0("Comments", currentyr)

## remove all white space and special characters
headersNowhite <- sapply(headers, function(x) gsub(" ", "", x))
headersNospch <- sapply(headersNowhite, function(x) str_replace_all(x, "[^[:alnum:]]", ""))

colnames(df2enter) <- headersNospch


## Use NA to advantage to remove rows without Transect info
df2enter <- df2enter %>%
  select(TagIdignoreforupload:Comments) %>%
  mutate(Transect = as.numeric(as.character(Transect))) %>%
  filter(!is.na(Transect) & Transect > 0) %>%
  mutate(across(TagIdignoreforupload:Minis, as.numeric))

str(df2enter)
```

## make edits to columns (same as above) to cut and paste into upload csv
```{r}

data2QAQC <- plants2024 %>%
  mutate(Tag = as.numeric(Tag)) %>%
  left_join(demo2024, by = c("ParentGlobalID" = "GlobalID")) %>%
  left_join(sitesTransID, by = c("transect" = "TransectID")) %>%
  left_join(df2enter, by = c("Tag" = "Tag", 
                             "transect" = "MySQLTransectID")) %>%
  mutate(ScGl_tag_id = as.numeric(ScGl_tag_id)) %>%
  select(c(ObjectID.x,  Site, TagIdignoreforupload, Tag, transect, 
           transect,  Xcoordm, Ycoordm, Height:ScGl_tag_id, site:transect)) %>%
  distinct(Tag, Height, Width, Flowering, .keep_all = TRUE)

## Did I run the 'Needed edits' ca. lines 83 on?  Should be 377 for Tag
plants2024 %>%
  filter(ScGl_tag_id == 528)

## 15 needed new x and y from data2QAQC  
data2QAQC %>%
  filter(is.na(ScGl_tag_id)) %>%
  filter(Height > 0) %>%
  distinct(ObjectID.x, .keep_all = TRUE) %>%
  filter(grepl(paste(c("Y ", "y ", "X ", "x "), collapse = "|"),
              Comments.x))

## plants2024$ScGl_tag_id  missing from some, don't know why; 21 like this; 20 after deleting ObjectID 1183, a duplicate measurement
# A tagID in the database but that didn't connect in the Survey123   
## These all look good
data2QAQC %>%
  filter(is.na(ScGl_tag_id) & !is.na(TagIdignoreforupload)) %>%
  arrange(TagIdignoreforupload)

```

Tags that have a tagID in the database but no matching Scgl_tag_id in Survey123  
3723 is in twice with different Height and widths, maybe accidentally measured it twice: keep first ObjectID 1164 and delete 1183    


Assign ScGl_tag_id when it occurs in TagIdignoreforupload      
```{r}

dataWQAQC <- data2QAQC %>%
  mutate(ScGl_tag_id = case_when( (is.na(ScGl_tag_id) & !is.na(TagIdignoreforupload)) ~ TagIdignoreforupload,
                                  TRUE ~ ScGl_tag_id))

## New seedlings or new to us measurements
dataWQAQC %>%
  filter(is.na(ScGl_tag_id))

dataWQAQC_v2 <- dataWQAQC %>%
  filter(ObjectID.x != 158) %>%
  mutate(TagIdignoreforupload = as.character(TagIdignoreforupload)) %>%
  mutate(TagIdignoreforupload = case_when(is.na(ScGl_tag_id) ~ "NEW",
                                          TRUE ~ TagIdignoreforupload))

```
objectID 147 needs to be deleted
ObjectID 75 is the same plant recorded elsewhere    
   
   180 = X 0.81, Y 12.5      
   
     180: tag 12 cm SW (TagID 437) Years: 2009:2016   
     180.01: tag 5cm W (TagID 3641) Years: 2021-2022   
     180.02: tag 9 cm SW (TagID 3642) Years: 2021-2022    
     ObjectID 69 should be assigned to tag 180.03 NEW
     
   280 = X 0.9, Y 12.86 (ObjectID 75)    
   
     280.02: tag 30cm S (TagID 467) Years: 2011:2023     


```{r}
dataWQAQC %>%
  filter(ObjectID.x == 75)

dataWQAQC %>%
  filter(TagIdignoreforupload == 437)

plants2024 %>%
  filter(ObjectID == 69)


```

## Check that all additional off a tag have same X and Y    



# Will update myPHPAdmin to match data collected in the field from Survey123
#### 19 plants that have a ScGl_tag_id from plants2024 in the Survey123 but no similar record in the phpMyAdmin database   


454 was big, saw dead spines, 445 not in transect 21 at Atwell Gulch, IS in transect 20   
3829 need to update X and Y   
3903 is in transect 21 in Survey123 but 20 in database   
3905 ""   
442 ""    
3639 ""   
473 ""   
443 ""   
472, 493, 474, 444, 2583, 2961. 3266 ""   
3925 is in 76 in the Survey123 but in 77 in the database.   
3926, 3927, 3930    
3927 is repeated for tag 263.03 and 263.02; is with 263.02 in database. maybe 263.03 is NEW? No, was just under 77
3930 is associated with tag number 263.05 in the database     
    3925: 263   
    3926: 263.01   
    3927: 263.02   
    3928: 263.03   
    3929: 263.04    
    3930: 263.05   



## New plants?     
```{r}


data2QAQC %>%
  filter(is.na(TagIdignoreforupload) & !is.na(ScGl_tag_id))
```



## Make a new to enter data frame with new X and Y if needed and updates to Individual Plant Location from comments  

```{r}

```


New:
368.12 - 368.13 (should be 368.11 and 368.12) transect 18
376.01-376.02 trans 18
439.03-439.06, trans 18
694.05-694.07, trans 18
332.03, trans 17


Duplicates:
ScGl_tag_id 2254 and 2476 for 628.01; 2476 no more data with it ** Deleted from MySQL database **

            





```{r}

m <- demo2024 %>%
  left_join(sitesTransID, by = c("transect" = "TransectID")) %>%
  mapview(  xcol = 'x', ycol = 'y', crs = 4269, grid = FALSE,
            zcol = 'Site')

mapshot(m, file = "C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/DemographicSitesMap.png")
```



Merge current year data
```{r}

demo2024 %>%
  select(c(GlobalID:transect, EditDate)) %>%
  left_join(plants2024, by = c("GlobalID" = "ParentGlobalID")) %>%
  select(c(Tag, transect, Height:Comments))   

## Need to move any tag information from "Comments" to the "Individual Plant Location" 
df2enter %>%
  unite(IndividPlLoc_comments, c("IndividualPlantLocation", "Comments"))
  # mutate(IndividualPlantLocation = case_when(grepl("tag", Comments) ~ 
  #                                                  paste(IndividualPlantLocation , Comments, sep = " New: "),
                                                 TRUE ~ IndividualPlantLocation ))


```

