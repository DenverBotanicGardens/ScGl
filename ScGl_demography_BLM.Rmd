---
title: "ScGl_demography_BLM"
author: "Michelle DePrenger-Levin"
date: "Monday, October 05, 2015"
output: html_document
---

*** Are you not Michelle DePrenger-Levin?? -->   
    Set userpath to "C:/Users/<yourname>/" in the first chunk to run code as is. 
The repository is named "ScGl"   
Will need: git push ScGl master   

2015: uploaded "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Raw Data/2015 Datasheets/DataEntry2015_10.13.15.csv"
```{r}
#if I need it!
rm(list=ls())
```

```{r, echo=FALSE}
library(ggplot2)
library(patchwork)
# library(plyr)
library(dplyr)
library(tidyr)
library(devtools)
#library(multcompView)
library(reshape2)
library(raster)
library(prism)
library(RCurl)
# library(psych)
library(Rmisc)
require(AICcmodavg)
#Set wd for prism data if not already
# options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")
# library(multcompView)
library(magrittr)
```


```{r}
#Some global variables
currentYr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))

#count pva
# x = Year, y = count
CountPVA <- function(x,y){
  
  LM.table <- c()
  
  for(yrs in 3:length(unique(x))){		# gives 2 transitions before the first Count PVA calculation
		rsq <- c(); PVA.lm <- list()
  
    y.count <- y[1:yrs] #Annual count for site
    x.years <- x[1:yrs] #Years of counts (can have missing years)
    ySpecies <- log10(y.count[-1]/y.count[-length(y.count)])
    yr <- sqrt(x.years[-1]-x.years[-length(x.years)])
    
		PVA.lm <- lm(ySpecies ~ -1 + yr)
		mu_sp <- predict(PVA.lm, level= 0.95,
		                 interval = "confidence",
		                 se.fit = T)$fit[1,]
    rsq <- c(rsq, R2 = summary(PVA.lm)$adj.r.squared)	# pull R squared values from each year interval 
    LM.table <- rbind(LM.table,data.frame(rsq,RangeStart=min(x),RangeEnd=x[yrs],t(mu_sp)))    
	}
	Year1 <- x.years[-length(x.years)]
	Year2 <- x.years[-1]
	PVA.table <-data.frame(yr,ySpecies,Year1,Year2)
  
  list(PVA = PVA.table,LM = LM.table)
}

userpath <-"C:/Users/deprengm/" 
```


Need to calculate individuals from 2008 data seperate from following due to lack of measuring hight and width. Will need to get the total tagged individuals for number alive instead of number of individuals with a heigth > 0 from 2009 on. <https://research.botanicgardens.org/admin/>      

In 2012 we switched from measuring the height and width individuals under 0.5 cm in width to counting them as "minis". 

2008-currentYr data  
```{r}

sg <- read.csv(paste(userpath,"Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/2008-currentyr_Sclerocactus_glaucus_R_tables/RawData_scgl_", currentYr, ".csv", sep=""))
names(sg)

table(sg$Site,sg$Year)
sg[which(sg$Width.cm. > 15),]
sg$Width.cm.[which(sg$Width.cm. > 18)] <- sg$Width.cm.[which(sg$Width.cm. > 18)]/10


#Remove rows where Site is blank, if any
sg[which(sg$Site == ""),]
if(nrow(sg[-which(sg$Site == ""),])>0){
  sg <- sg[-which(sg$Site == ""),]
  }

# Vol calculated at pi*r^2*h
sg$Vol <- pi*((sg$Width.cm./2)^2)*sg$Height.cm.

nrow(sg[sg$Year == 2008,]) ## 185
sg$Site <- factor(sg$Site) ## 15 levels with (old)
sg$Minis[sg$Minis > 1000 & !is.na(sg$Minis)] <- NA ## two have photo numbers instead of mini number


## Will only work for Michelle DePrenger-Levin - set to my OneDrive
if(grepl("deprengm",userpath)){
  write.table(sg, file=paste(userpath,"OneDrive - Denver Botanic Gardens/P drive/hackathon/ScGl/datasets/sg",currentYr,".csv",sep=""), sep=",")
}

```


##Summarize old and new data by number of individuals    
Need to split by Site - Atwell Gulch needs to be together:  
       `Atwell Gulch_108` and `Atwell Gulch_165` are Atwell Gulch with Ycoord < 30
       Road T-West (old) vs. T-Junction
       Oil Pad and Oil Pad (old)
       Pond and Pond (old)
     
summarize 2008  
```{r}
scgl08 <- read.delim(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/2008-currentyr_Sclerocactus_glaucus_R_tables/All2008.txt", sep=""),sep=",")

sg_summary08 <- ddply(scgl08,  
                    .(SiteName,Year), summarise,
                    X = sum(CountofHeight),
                    Rep = sum(SumFlowered),
                    Brs = sum(SumBrowsed),
                    avgH = NA,
                    sdH = NA,
                    avgW = NA,
                    sdW = NA,
                    avgVol = NA,
                    sdVol = NA)


sg$Fl <- as.character(sg$Fl)
sg$Br <- as.character(sg$Br)

sg$Fl[sg$Fl == "n"] <- "0"
sg$Fl[sg$Fl == "y"] <- "1"

sg$Br[sg$Br == "n"] <- "0"
sg$Br[sg$Br == "y"] <- "1"

sg$Fl <- as.numeric(sg$Fl)
sg$Br <- as.numeric(sg$Br)

table(sg$Year, sg$Site)

# Pond was not finished in 2015
# Some data was entered but should be removed from the count data and trend analyses unless it is for individuals that were measured in 2015
# No data was collected in 2020 due to COVID-19, SARS-CoV-2

```

 
Starting in 2019 we use the photoNumber column to track the number of flowers per plant
```{r}

sg$FlNum <- ifelse(sg$Year >= 2019, as.numeric(sg$PhotoNumber), NA)

ggplot(sg[sg$Year > 2018,], aes(FlNum, Site, fill = Site, group = Site))+
  geom_point(position = position_jitterdodge())+
  geom_boxplot()+ 
  # scale_y_discrete(labels = label_wrap(3))+
  facet_wrap(~Year)

```



#Old and New data     
Atwell Gulch old is everything with a Y less than 30    
Atwell Gulch new is everything Atwell Gulch    
Rename Sites for Atwell old and new
```{r}
# Add a level to the Site factor field
sg$Site <- factor(sg$Site, 
                  levels = c("Atwell Gulch", "Atwell Gulch (old)",levels(sg$Site)))

# Rename all Atwell Gulch
sg[grep("Atwell", sg$Site),"Site"] <- "Atwell Gulch"

sg[sg$X.coord.m. > 1.1 & !is.na(sg$X.coord.m.) & sg$Site == "Atwell Gulch",]
sg$X.coord.m.[sg$Tag == 251 & sg$Site == "Atwell Gulch"] <- 0

```

#2016 on    
No more "Old" versions. Need to remove these data - tags that were in both versions are still reported. 
Stop Pond old in 2015
Keep Atwell old and new
Fram no data in 2015
```{r}
#Road T-East
sg <- sg[grep("Road T-East", sg$Site, invert=TRUE),]


#No "old" 2016 on
sg <- sg[-intersect(grep("old", sg$Site),which(sg$Year>2015)),]

#No Pond in 2015╣
sg <- sg[-intersect(grep("Pond", sg$Site), which(sg$Year==2015)),]

#Add back Atwell duplicated for old and new
sg <- do.call(rbind,list(sg[grep("Atwell", sg$Site, invert = TRUE),],atwell.new,atwell.old))
length(levels(sg$Site))
sg$Site <- droplevels(sg$Site)
levels(sg$Site)

table(sg$Site,sg$Year)

sg$SiteSame <- sg$Site
sg$SiteSame[sg$Site %in% unique(grep(paste("Atwell",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "Atwell Gulch"

sg$SiteSame[sg$Site %in% unique(grep(paste("Pond",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "Pond"

sg$SiteSame[sg$Site %in% unique(grep(paste("Oil",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "Oil Pad"

sg$SiteSame[sg$Site %in% unique(grep(paste("T-",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "T-Junction"


# Assign genetic regions
sg$NS <- "North"
southsites <- c("Bridgeport","Escalante Canyon","Picnic Site","Powerline","Fram")
sg$NS[sg$Site %in% southsites] <- "South"

## 2008 has Escalante Canyon, Picnic Site, Powerline, and Pyramid Rock
sg_summary08$SiteSame <- sg_summary08$Site

# Assign genetic regions
sg_summary08$NS <- "North"
southsites <- c("Bridgeport","Escalante Canyon","Picnic Site","Powerline","Fram")
sg_summary08$NS[sg_summary08$SiteName %in% southsites] <- "South"

# to match sg_summary later
sg_summary08 <- sg_summary08[,c(1,12:13,2:11)]
```

#Data checks
```{r}
ggplot(sg[sg$Site == "Picnic Site",], aes(Transect,Height.cm.))+
  geom_point()

table(sg$Site[which(sg$Height.cm. > 10 )])

sg[which(sg$Height.cm. > 7.5 & sg$Site == "Picnic Site"),]
unique(sg$Comments[sg$Site == "Picnic Site" & is.na(sg$Height.cm.)]) ## Some are dead, some might be seedlings <0.5cm

sg[which(sg$Height.cm. > 7.5 & sg$Site == "Pond"),] 
unique(sg$Comments[sg$Site == "Pond" & is.na(sg$Height.cm.)])

```



2008 is a summary already, need to summarize rest before combining with 2008. 
```{r}
# One copy of all Atwell Gulch 2012 on for new (after three transects were extended)
atwell.new <- sg[intersect(grep("Atwell",sg$Site),which(sg$Year>2011)),]

atwell.old <- sg[intersect(grep("Atwell",sg$Site),which(sg$Y.coord.m.<30)),] 
atwell.old$Site <- "Atwell Gulch (old)"

ggplot(atwell.old, aes(X.coord.m., Y.coord.m., color = as.factor(Year)))+
  geom_point(position = position_dodge(width = 0.01))+
  facet_wrap(~ Transect, nrow = 2)


## remove atwell and add in later
sg_summary <- sg %>%
  filter(Year > 2008) %>%
  filter(!(Site %in% c("Atwell Gulch","Atwell Gulch (old)"))) %>%
  group_by(Site,SiteSame,NS,Year) %>%
  dplyr::summarise(.groups = "keep",
                   ## the number of individuals should include minis
                   X = length(Tag[Height.cm. >0]) + sum(Minis, na.rm = TRUE),
                   Rep = sum(Fl, na.rm = TRUE),
                   Brs = sum(Br, na.rm = TRUE),
                   avgH = mean(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                   sdH = sd(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                   avgW = mean(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                   sdW = sd(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                   avgVol = mean(Vol, na.rm = TRUE),
                   sdVol = sd(Vol, na.rm = TRUE))


atwell_summary <- bind_rows(atwell.old, atwell.new) %>%
  group_by(Site,SiteSame,NS,Year) %>%
  dplyr::summarise(.groups = "keep",
                   X = length(Tag[Height.cm. >0] + sum(Minis, na.rm = TRUE)),
                Rep = sum(Fl, na.rm = TRUE),
                    Brs = sum(Br, na.rm = TRUE),
                    avgH = mean(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                    sdH = sd(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                    avgW = mean(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                    sdW = sd(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                    avgVol = mean(Vol, na.rm = TRUE),
                    sdVol = sd(Vol, na.rm = TRUE))

                           
```

#Data summary
Combine 2008 (with no height or width data) and remaining years 
```{r}
names(sg_summary08) <- names(sg_summary)
sg_sum <- do.call(rbind, list(sg_summary08,sg_summary, atwell_summary))
```

Report Tables_current year
Table 2: Summary data of Sclerocactus glaucus demographic monitoring in western Colorado (2008-2015).
```{r}

# total area from table 2
unique(sg_sum$Site)
sg_sum$area[sg_sum$Site == "Escalante Canyon"] <- 180
sg_sum$area[sg_sum$Site == "Bridgeport"] <- 400
sg_sum$area[sg_sum$Site == "Atwell Gulch"] <- 390
sg_sum$area[sg_sum$Site == "Atwell Gulch (old)"] <- 300
sg_sum$area[sg_sum$Site == "Fram"] <- 1300
sg_sum$area[sg_sum$Site == "Oil Pad (old)"] <- 672
sg_sum$area[sg_sum$Site == "Oil Pad"] <- 120
sg_sum$area[sg_sum$Site == "Picnic Site"] <- 160
sg_sum$area[sg_sum$Site == "Pond"] <- 36
sg_sum$area[sg_sum$Site == "Pond (old)"] <- 235.6
sg_sum$area[sg_sum$Site == "Powerline"] <- 40
sg_sum$area[sg_sum$Site == "Pyramid Rock"] <- 100
sg_sum$area[sg_sum$Site == "Road T-West (old)"] <- 2212
sg_sum$area[sg_sum$Site == "T-Junction"] <- 130

sg_sum$Density <- sg_sum$X/sg_sum$area
```


All sites 
```{r}
ggplot(sg_sum, aes(Year,Density,colour=Site))+
  geom_point(size=3)+
  geom_line()+
  xlim(c(2008, 2024))+
  ylab("individuals per square meter") +
  theme_classic()+
  scale_colour_discrete(guide = "none")+
  # annotate("text", x = aggregate(Year ~ Site, sg_sum, max)$Year + 1.5,
  #          y = aggregate(Density ~ Site, sg_sum, FUN = tail, n = 1)$Density,
  #          label = paste(unique(sg_sum$Site[sg_sum$Density %in% aggregate(Density ~ Site,sg_sum, 
  #                                             FUN = tail, n = 1)$Density &
  #                       sg_sum$Year %in% aggregate(Year ~ Site, sg_sum, max)$Year])))
  facet_wrap(~NS, nrow = 2, scales = "free")

```


All sites separate plots
```{r}
ggplot(sg_sum, aes(Year,Density,colour=Site))+
  geom_point()+
  geom_line()+
  facet_wrap(~SiteSame, scales = "free")+
  ylab("Density")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

All the new ones
```{r}
ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  ylab("Total individuals")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_continuous(breaks = seq(2008, currentYr, 2))
```


```{r}
sg_sum$Site <- as.factor(sg_sum$Site)

ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], aes(Year,X,colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg_sum$Site[grep("old",sg_sum$Site,invert=TRUE)]))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")+
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 2))
```


All the old ones
```{r}
ggplot(sg_sum[grep("old",sg_sum$Site),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_grid(~Site)+
  ylab("Total individuals")+
  theme_bw()
```

```{r}
ggplot(sg_sum[grep("old",sg_sum$Site),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```


old and new
```{r}
oldnew <- c("Oil","Pond","T-","Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")+
  theme_bw()
```


#Pond
```{r}
oldnew <- c("Pond")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") 
```

Is T-Junction missing some - should be finding more individuals
#T-Junction
```{r}
oldnew <- c("T-")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

#Oil Pad
```{r}
oldnew <- c("Oil")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

#Atwell
```{r}
oldnew <- c("Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```


Summary tables
```{r}

tableout <- sg_sum %>%
  dplyr::select(Year, Site, X:area) %>%
  group_by(Year,Site) %>%
  mutate(TotInd = X, IndSqM = round(X/area,2), PercRepro = paste0(round(100*Rep/X, 1), "%"),
         AvgHeight = paste(round(avgH,2), " (", round(sdH,2), ")", sep=""),
         AvgWidth = paste(round(avgW,2), " (", round(sdW,2), ")", sep = ""),
         PercBr = paste0(round(100*Brs/X, 2), "%")) %>%
  dplyr::select(Site:Year, area, TotInd, IndSqM, Rep, PercRepro, AvgHeight, AvgWidth, Brs, PercBr)


```



```{r}
new <- c("Atwell Gulch","Oil Pad","Pond","T-Junction")
poststand <- tableout[tableout$Year == currentYr & tableout$Site %in% new,]

prestand <- tableout[tableout$Year == currentYr & !(tableout$Site %in% new),]

## All years with minis added to count
# poststand <- tableout %>%
#   filter(Site %in% new) %>%
#   arrange(Year,Site) 
# 
# prestand <- tableout %>%
#   filter(!Site %in% new) %>%
#   arrange(Year,Site)

write.table(poststand, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_poststand.csv", sep=""), sep=",", row.names=FALSE, col.names = TRUE)


write.table(prestand, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_prestand.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)

```

# Results: Reproduction
```{r}

## Size at reproduction
## don't double up the individuals that are in both old and new designs
sizeRep <- sg %>%
  drop_na(Width.cm.,Fl) %>%
  distinct(Tag, SiteSame, .keep_all = TRUE) %>%
  dplyr::group_by(NS,Site, Fl) %>%
  dplyr::summarise(.groups = "keep", 
                   SizeMin = min(Width.cm., na.rm = TRUE), 
                   SizeMean = mean(Width.cm., na.rm = TRUE),
                   SizeMedian = median(Width.cm., na.rm = TRUE),
                   SizeMax = max(Width.cm., na.rm = TRUE))

as.data.frame(sizeRep)
sizeRep %>%
  filter(Fl == 1) %>%
  group_by(NS) %>%
  dplyr::summarise(minSz = mean(SizeMin), meanSz = mean(SizeMean), medianSz = median(SizeMedian),
                   .groups = "keep")

ggplot(sg[which(sg$Width.cm. > 0 & !duplicated(sg[,c("Tag","SiteSame")])),], aes(Site,Width.cm., color = as.factor(Fl)))+
  geom_boxplot()+
  ylim(c(0,17))+
  geom_point(position = position_jitterdodge(jitter.height = 0))+
  facet_wrap(~NS,nrow = 2, scales = "free")+
  scale_x_discrete(labels = label_wrap(5))

## all sites
### Double counting the Atwell Gulch ones and some Pond, Oil Pad, and T-Junction ones
rep_site.all <- sg_sum %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "all")


## Pre-standardized after 2012, NOT the new ones, the Old ones 
# [1] "Atwell Gulch" "Oil Pad"      "Pond"         "T-Junction"
sg_sum %>%
  filter(Year >= 2012) %>%
  filter(!(Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  summarise(Mean = mean(MeanRep), SD = sd(SDRep)) %>%
  mutate(Group = "pre2012on")

## all years
rep_site <- sg_sum %>%
  filter(!(Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "pre")


whichsites <- sg_sum %>%
  filter(!(Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep")
table(whichsites$Site, whichsites$Year)

ggplot(rep_site, aes(Year, MeanRep))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin = MeanRep - SDRep, ymax = MeanRep + SDRep), width = 0.2)

##Average percent repro >= 2012 pre-standard
rep_site %>% 
  summarise(Mean = mean(MeanRep), SD = sd(SDRep))


# the ones that changed 
rep_site.post <- sg_sum %>%
  filter(Year >= 2012) %>%
  filter((Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "post")

rep_site.post %>%
  summarise(Mean = mean(MeanRep), SD = sd(SDRep))

compareall <- bind_rows(rep_site,rep_site.all, rep_site.post)
ggplot(compareall, aes(Year, MeanRep, color = Group))+
  geom_point(position = position_dodge(width = 0.5))+
  geom_line(position = position_dodge(width = 0.5))+
  geom_errorbar(aes(ymin = MeanRep - SDRep, ymax = MeanRep + SDRep), width = 0.2,
                position = position_dodge(width = 0.5))

### Are larger non-reproductive individuals dying?
table(sg$Comments[which(sg$Width.cm. > 6.5 & sg$Fl == 0)])


# Atwell gulch: reproduction detected in new vs. old design
Atwell.oldPR <- sg_sum %>%
  filter(SiteSame == "Atwell Gulch") %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "atwell")

###
tRepAtwell <- t.test(AtwellRep[[1]],AtwellRep[[2]])
tRepAtwell
diff(tRepAtwell$estimate)

# Average reproduction of each site
sg_sum %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Site) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "all") %>%
  arrange(desc(MeanRep))

sg_sum <- sg_sum %>%
  mutate(PRep = Rep/X)

```

AIC for reproduction below after loading climate


Climate directly from PRISM   
### update only the previous year each year  
```{r}
#devtools::install_github("ropensci/prism")

# Set wd for prism
# options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")
options(prism.path = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")

```


# Precip Total precipitation (rain and snow)
```{r}
#get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = 1986:currentYr)
```

#Update last year and get this year 
Delete previous year from folder first, then update    
       search for previous year in File Explorer         
       select all (provisional and stable) and delete     
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)
```

Pick up any that didn't download
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon=3, keepZip = FALSE, years = 1995)
get_prism_monthlys(type="ppt", mon=5, keepZip = FALSE, years = 1988)
get_prism_monthlys(type="ppt", mon=10, keepZip = FALSE, years = 2001)
get_prism_monthlys(type="ppt", mon=11, keepZip = FALSE, years = 2004)
get_prism_monthlys(type="ppt", mon=7, keepZip = FALSE, years = 2007)
get_prism_monthlys(type="ppt", mon=12, keepZip = FALSE, years = 2009)
```


Lat longs for 10 sites   
39.1969Â°N, 108.1298Â°W Atwell    
38.8491Â°N, 108.3717Â°W Bridgeport   
38.6593Â°N, 108.3466Â°W Escalante     
39.0612Â°N, 108.3799Â°W Fram        
39.3446Â°N, 108.3102Â°W Oil Pad    
38.6701Â°N, 108.3286Â°W Picinic    
39.3606Â°N, 108.3136Â°W Pond    
38.7291Â°N, 108.1770Â°W Powerline   
39.3069Â°N, 108.2755Â°W Pyramid Rock   
39.3544Â°N, 108.3286Â°W T-Junciton   
```{r}
latlong <- data.frame(rbind(c(39.1969, -108.1298, "Atwell Gulch"),
                           # c(39.1969, -108.1298, "Atwell Gulch (old)"),
                            c(38.8491, -108.3717, "Bridgeport"),   
                            c(38.6593, -108.3466, "Escalante Canyon"),
                            c(39.0612, -108.3799, "Fram"),
                            c(39.3446, -108.3102, "Oil Pad"),
#                            c(39.3446, -108.3102, "Oil Pad (old)"),
                            c(38.6701, -108.3286, "Picnic Site"),
                            c(39.3606, -108.3136, "Pond"),
#                            c(39.3606, -108.3136, "Pond (old)"),
                            c(38.7291, -108.1770, "Powerline"),
                            c(39.3069, -108.2755, "Pyramid Rock"),
                            c(39.3544, -108.3286, "T-Junction")))
#,
#                            c(39.3544, -108.3286, "Road T-West (old)")))   
names(latlong) <- c("Lat","Long","Site")
latlong[,1:2] <- sapply(latlong[,1:2], function(x) as.numeric(as.character(x)))
```

# Go into folder "Q:\Research\All_Projects_by_Species\Sclerocactus SPECIES\Sclerocactus_glaucus\ScGl_climate\PRISM_ppt_provisional_4kmM3_201601_bil" and delete the provisional ones from last year    
Put into AsMi instead so only one copy of everything climate

Max temp   
16 years 2000:currentYr
Min temp   
16 years 2000:currentYr
```{r, eval=FALSE}

m.ppt <- prism_archive_subset("ppt", "monthly", years = 1986:currentYr)
m.ppt2 <- lapply(m.ppt, function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]),
             date = x, Site = latlong$Site)
})


m.tmax <- lapply(prism_archive_subset("tmax","monthly",years = 1986:currentYr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]),
             date = x, Site = latlong$Site)
})

m.tmin <- lapply(prism_archive_subset("tmin","monthly",years = 1986:currentYr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]),
             date = x, Site = latlong$Site)
})
```

PRISM_ppt_stable_4kmM3_201512_bil

# Combine climate data from library(prism)   

Strip off the last bit after the last underscore    

     scgl.temps$date <- sapply(scgl.temps$date, function(x){
       unlist(strsplit(x, "_\\s*(?=[^_]+$)", perl=TRUE))[[1]]
       })  
       
```{r, eval=FALSE}
scgl.climate <- rbind(do.call(rbind, m.tmin), 
                    do.call(rbind, m.tmax),
                    do.call(rbind, m.ppt2))

save(scgl.climate, file=paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"climate.Rdata", sep=""))

```



###### Load once made
```{r}
load(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"climate.Rdata", sep=""))


scgl.climate$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl.climate$NS[scgl.climate$Site %in% southsites] <- "South"

scgl.climate.monthly <- scgl.climate %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to May survey)
         Prev12 = ifelse(Month > 5, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1,2,12) ~ "winter",
                            Month>5 & Month<9 ~ "summer",
                            Month>8 & Month<12 ~ "fall",
                            Month>2 & Month<6 ~ "spring"))

scgl.c <- scgl.climate.monthly %>%
  pivot_wider(names_from = Variable, values_from = data)

scgl.climate.season.ppt <- scgl.climate.monthly %>%
  filter(Variable == "ppt") %>%
  group_by(Variable, Site, NS, season, Prev12) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep") 
  

scgl.climate.season.temp <- scgl.climate.monthly %>%
  filter(Variable != "ppt") %>%
  group_by(Variable, Site, NS, season, Prev12) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")
  
scgl.season <- bind_rows(list(scgl.climate.season.ppt, scgl.climate.season.temp))
scgl.season.wide <- scgl.season %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value)

scgl.annual.ppt <- scgl.climate.monthly %>%
  filter(Variable == "ppt") %>%
  group_by(Variable, Site, NS, Prev12) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")
  
scgl.annual.temp <- scgl.climate.monthly %>%
  filter(Variable != "ppt") %>%
  group_by(Variable, Site, NS, Prev12) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")

scgl.annual <- do.call(rbind, list(as.data.frame(scgl.annual.ppt),
                                   as.data.frame(scgl.annual.temp)))

ggplot(scgl.annual, aes(Prev12, Value))+
  geom_point()+
  stat_smooth(se = FALSE)+
  facet_grid(Variable ~ Site, scales = "free")

## a column for each variable instead of long
scgl.annual.wide <- scgl.annual %>%
  pivot_wider(names_from = Variable, values_from = Value) 

```

scgl.c is now:
> scgl.c
# A tibble: 4,370 x 8
   Site              Year Month Prev12 season  tmin  tmax   ppt
   <chr>            <dbl> <dbl>  <dbl> <chr>  <dbl> <dbl> <dbl>
 1 Atwell Gulch      2021    12   2022 winter -5.86  5.79  37.3
 2 Bridgeport        2021    12   2022 winter -5.45  6.85  31.5
 3 Escalante Canyon  2021    12   2022 winter -4.90  6.13  28.5
 4 Fram              2021    12   2022 winter -4.38  6.59  30.2
 5 Oil Pad           2021    12   2022 winter -4.68  5.34  39.2
 6 Picnic Site       2021    12   2022 winter -4.90  6.13  28.5
 7 Pond              2021    12   2022 winter -5.69  5.08  47.8
 8 Powerline         2021    12   2022 winter -6.19  7.32  15.3
 9 Pyramid Rock      2021    12   2022 winter -5.19  5.83  29.4

Pre 2022 dplyr/tidyr version:
          Site Precip  tmin tmax Year Month Prev12 season
1 Atwell Gulch  54.37 -10.1  2.0 1895     1   1895 winter
2 Atwell Gulch  26.50 -10.0  4.0 1895     2   1895 winter
3 Atwell Gulch  23.35  -4.1 11.1 1895     3   1895 spring
4 Atwell Gulch  12.97   0.5 19.3 1895     4   1895 spring
5 Atwell Gulch  31.98   4.9 23.5 1895     5   1895 spring
6 Atwell Gulch  19.17   7.4 26.8 1895     6   1896 summer
> names(scgl.c)
[1] "Site"   "Precip" "tmin"   "tmax"   "Year"   "Month"  "Prev12" "season"

####Summarize climate data
Climate of the previous 12 month to the May data collection

###PCA for climate factors
calculate seasonal climate averages    
summer: June-August (6-8)
fall: September-November (9-11)
winter: December-February (12, 1-2)
spring: March-May (3-5)

summary statistics
```{r}
# t.test for north compared to south
t.test(ppt~NS, data = scgl.annual.wide)
t.test(tmax~NS, data = scgl.annual.wide)
t.test(tmin~NS, data = scgl.annual.wide)

```


# forcing variables (climate drivers) of growth, survival, and reproduction 1987 through current year
Ditch anything 50% or more correlated of the pair that explains less variation, get r^2 values
```{r}

#keep the one with bigger r2 from var1 and var2 when Freq is > 50% 
cor.level <- .5 

cor.table86.current<-cor(scgl.season.wide[complete.cases(scgl.season.wide),-c(1:3)])
data86.current <- as.data.frame(as.table(cor.table86.current))
data86.current[abs(data86.current$Freq) >= 0.5,]
corrforcing <- data86.current[abs(data86.current$Freq) >= 0.5 & data86.current$Freq < 1,]

## 
corrforcing[order(corrforcing$Var1),]
corrforcing[!duplicated(corrforcing$Freq),]

toexclude <- corrforcing$Var1[!duplicated(corrforcing$Freq)]
colexclude <- which(names(scgl.season.wide) %in% toexclude)

# Climatic variables used in PCA 1986-current year
names(scgl.season.wide[,-colexclude])
cc.season.notcor <- scgl.season.wide[,-colexclude]

```

#Table 3a)    
```{r}

Table3acor <-cor(scgl.season.wide[complete.cases(scgl.season.wide),-c(1:2)])
Table3a <- as.data.frame(as.table(Table3acor))

Table3a <- Table3a[abs(Table3a$Freq)>cor.level&Table3a$Freq<1,]

# To get rid of duplicated correlations
write.table(Table3a[!duplicated(Table3a$Freq),], file=paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Table3a.csv", sep=""), 
            sep=",", row.names=FALSE, col.names = TRUE)
```

#### Figure 2: a) Number of Sclerocactus glaucus individuals per square meter in the northern genetic region (North) and the southern genetic region (South), and b) Average size of individuals per site. 

# Results: Reproduction
```{r}
sg_season <- merge(sg, scgl.season.wide, by.x = c("Year","Site","NS"), by.y = c("Prev12","Site","NS"))
scgl_season <- merge(sg_sum, scgl.season.wide, 
                     by.x = c("Year","Site","NS"), by.y = c("Prev12","Site","NS"))


#Reproductive individuals with average width of plants
#See also "#Reproduction" below; should match this
summary(lm(PRep~avgW * NS, data=scgl_season))
ggplot(scgl_season, aes(avgW, PRep, color = NS)) +
  geom_point()+
  stat_smooth(method = "lm")

summary(glm(Fl~Width.cm. * NS, data = sg_season, family = binomial(link = "logit")))
ggplot(sg_season, aes(Width.cm., Fl, color = NS))+
  geom_point()+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE)

```

# 2021 ESA SSA delisting recommendation. Density across south and north for BLM
```{r}

ggplot(sg_sum, aes(Density, SiteSame, fill = NS))+
  geom_boxplot() 

write.csv(sg_sum, paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/ScGl_density.csv", sep=""))

```



####Figure 6: The plot design for four ScGl sites were changed in 2012...   
```{r}
# old and new
oldnew <- c("Oil","Pond","T-","Atwell")

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig6.jpg", sep=""),

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") +
  facet_wrap(~SiteSame)+
  theme_bw()+
  scale_x_continuous(breaks = seq(2009, currentYr, 2)),

 width=200, height=125, units="mm", dpi=300)


```

#Reproduction   

Density dependence? 
```{r}
## t = y, t+1 = x
sg_lagged <- subset(merge(sg_sum, sg_sum, by = c("Site")), Year.x == Year.y + 1)

## Really want growth rate on Y as a function of density
ggplot(sg_lagged, aes(X.y, X.x))+
  geom_point()+
  stat_smooth()

```



```{r}


ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], 
       aes(Year, Prepro, group = Site, colour = Site)) +
  geom_point()+
  geom_line()+
  ylab("Percent reproductive") +
  facet_wrap(~NS+Site,ncol = 5) +
  theme_bw()
```

# AICc climate and width on Reproduction   
Largest proportion of reproductive individuals over all years   
```{r}
sg_sum[sg_sum$Site=="Pond",]

summarySEreproductive <- summarySE(sg_sum, measurevar = "Prepro", groupvars=c("Site"))

summarySEreproductive[with(summarySEreproductive, order(Prepro)),]


#Is percent reproductive explained by width, height, or both: volume?
summary(lm(Prepro~(avgW+avgVol)^2, data=sg_sum))

# Which is the better predictor of percent reproductive
summary(lm(Prepro~avgVol, data=sg_sum))
summary(lm(Prepro~avgW, data=sg_sum))
summary(lm(Prepro~avgH, data=sg_sum))
```

```{r}
head(sg_sum)
sort(sg_sum$Prepro) ## Never zero, never 1

library(betareg)
## Should be beta regression
lm1 <- betareg(Prepro~avgVol, sg_sum) ## If used weights should be scaled such that sum(weights) corresponds to number of independent observations
lm2 <- glm(Prepro~avgW, family = "binomial",sg_sum, weights = X)
lm3 <- glm(Prepro~avgH, family = "binomial",sg_sum, weights = X) 
lm4 <- glm(Prepro~avgVol*Site,family = "binomial", sg_sum, weights = X)
lm5 <- glm(Prepro~avgW*Site, family = "binomial",sg_sum, weights = X)
lm6 <- glm(Prepro~avgH*Site, family = "binomial",sg_sum, weights = X) 
lm7 <- glm(Prepro~avgVol*NS,family = "binomial", sg_sum, weights = X)
lm8 <- glm(Prepro~avgW*NS, family = "binomial",sg_sum, weights = X)
lm9 <- glm(Prepro~avgH*NS, family = "binomial",sg_sum, weights = X) 

lm.list <- list(lm1,lm2, lm3, lm4, lm5, lm6, lm7, lm8,lm9)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

# more percent reproductive with avg width
summary(lm2)
sjPlot::plot_model(lm8, type = "int", show.data = T) ## no interactions

# library(sjPlot)
effectsize::standardize(lm2) %>% summary()
sjPlot::plot_model(lm2, type = "est", show.values = T)
sjPlot::tab_model(lm2)
```


# What describes reproduction
### Is percent reproductive explained by climate variables?   
Figure 5 (was figure 4 before adding survival interaction plots)   
```{r}
# +ppt.spring +tmax.spring +ppt.summer+ ppt.winter+ tmax.winter

lm10 <- glm(Prepro~avgW*data.ppt,
            family = "binomial", sg_sum, weights = X)
lm11 <- glm(Prepro~avgW*data.ppt*data.tmax,
            family = "binomial", sg_sum, weights = X)
lm12 <- glm(Prepro~avgW*data.tmin,
            family = "binomial", sg_sum, weights = X)
lm13 <- glm(Prepro~avgW*data.tmin*data.ppt,
            family = "binomial", sg_sum, weights = X)
  # lm1 <- glm(Prepro~avgW*data.tmin*data.tmax*data.ppt,
  #          family = "binomial", sg_sum, weights = X)
lm2 <- glm(Prepro~avgW*data.tmax, 
           family = "binomial",sg_sum, weights = X)
lm3 <- glm(Prepro~NS*avgW*data.ppt,
            family = "binomial", sg_sum, weights = X)

#######################################################
lm4 <- glm(Prepro~NS*avgW*data.tmax*data.ppt,
            family = "binomial", sg_sum, weights = X)
lm6 <- glm(Prepro~NS*avgW*data.tmin*data.ppt,
            family = "binomial", sg_sum, weights = X)
#######################################################

lm5 <- glm(Prepro~NS*avgW*data.tmin,
            family = "binomial", sg_sum, weights = X)
  # lm7 <- glm(Prepro~NS*avgW*data.tmin*data.tmax*data.ppt,
  #          family = "binomial", sg_sum, weights = X)
lm8 <- glm(Prepro~NS*avgW*data.tmax, 
           family = "binomial",sg_sum, weights = X)

# lm1,lm7,
lm.list <- list(lm2,lm3,lm4,lm5,lm6,lm8, lm10,lm11,lm12,lm13)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
print(evidence(aic.table = lm.results),
      digits = 2)
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

# more percent reproductive with avg width
### Best are 4 and 6
effectsize::standardize(lm6) %>% summary()
effectsize::standardize(lm4) %>% summary()

sjPlot::plot_model(lm6, type = "eff", show.data = T) 
## meansd : mean value +/- one SD
# "int" for continuous variables the min and max are chosen as grouping levels
```

```{r}

sjPlot::set_theme(base = theme_bw())


p2 <- sjPlot::plot_model(lm4, type = "int", mdrt.values = "meansd")
 # sjPlot::plot_model(lm4, type = "int",  mdrt.values = "meansd")
                    # terms = c("avgW [all]", "data.ppt [meansd]","data.tmax [meansd]")) 
p1 <- sjPlot::plot_model(lm6, type = "int", mdrt.values = "meansd")
## Change facet order to mean-SD, mean, mean+SD
for(i in 1:3){
  p1[[11]][[i]]$data$facet <- factor(p1[[11]][[i]]$data$facet,
                                      levels = c(levels(p1[[11]][[i]]$data$facet)[2],
                                                 levels(p1[[11]][[i]]$data$facet)[1],
                                                 levels(p1[[11]][[i]]$data$facet)[3]))
  ## Change facet labels
  levels(p1[[11]][[i]]$data$facet) <- gsub(pattern = "data.tmin", 
                                            replacement = "Min Temp",
                                            levels(p1[[11]][[i]]$data$facet) )
}

p1[[11]][[1]]$labels$title <- gsub("Prepro", "\n% reproduction", p1[[11]][[1]]$labels$title)

for(i in 1:3){
  p1[[11]][[i]]$labels$subtitle <- gsub("data.ppt","ppt", p1[[11]][[i]]$labels$subtitle)
}

p1[[11]][[1]]$labels$y <- "Probability of Reproduction"
for(i in 2:3){
  p1[[11]][[i]]$labels$y <- ""
}


# No size but region, ppt, and tmin
# Facet order
p1[[9]]$data$facet <- factor(p1[[9]]$data$facet,
                                    levels = c(levels(p1[[9]]$data$facet)[2],
                                               levels(p1[[9]]$data$facet)[1],
                                               levels(p1[[9]]$data$facet)[3]))
## Change facet labels
levels(p1[[9]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p1[[9]]$data$facet) )

p2[[9]]$data$facet <- factor(p2[[9]]$data$facet,
                                    levels = c(levels(p2[[9]]$data$facet)[2],
                                               levels(p2[[9]]$data$facet)[1],
                                               levels(p2[[9]]$data$facet)[3]))
## Change facet labels
levels(p2[[9]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p2[[9]]$data$facet) )


p1[[8]]$data$facet <- factor(p1[[8]]$data$facet,
                                    levels = c(levels(p1[[8]]$data$facet)[2],
                                               levels(p1[[8]]$data$facet)[1],
                                               levels(p1[[8]]$data$facet)[3]))
## Change facet labels
levels(p1[[8]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p1[[8]]$data$facet) )

# Fig4_a_reproduction <- p1[[8]]+
#   # ggtitle("Predicted probablities of % reproduction")+
#   ggtitle("a)")+
#   scale_colour_discrete("Size")+
#   xlab("Region")+
#   ylab("% reproduction")+
#   theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1))
## For other competitive model lm4
## Change facet order to mean-SD, mean, mean+SD
for(i in 1:3){
  p2[[11]][[i]]$data$facet <- factor(p2[[11]][[i]]$data$facet,
                                      levels = c(levels(p2[[11]][[i]]$data$facet)[2],
                                                 levels(p2[[11]][[i]]$data$facet)[1],
                                                 levels(p2[[11]][[i]]$data$facet)[3]))
## Change facet labels
  levels(p2[[11]][[i]]$data$facet) <- gsub(pattern = "data.tmax", 
                                            replacement = "Max Temp",
                                            levels(p2[[11]][[i]]$data$facet) )
}

p2[[11]][[1]]$labels$title <- gsub("Prepro", "\n% reproduction", p2[[11]][[1]]$labels$title)

for(i in 1:3){
  p2[[11]][[i]]$labels$subtitle <- gsub("data.ppt","ppt", p2[[11]][[i]]$labels$subtitle)
}

p2[[11]][[1]]$labels$y <- "Probability of Reproduction"
for(i in 2:3){
  p2[[11]][[i]]$labels$y <- ""
}

  
```

```{r}
## Break it down into parts lm6 tmin
p1[[11]]$labels$colour <- "Size"
p2[[11]]$labels$colour <- "Size"

Fig4_b_reproduction <- p1[[9]]+
  # ggtitle("Predicted probablities of % reproduction")+
  ggtitle("c)")+
  scale_colour_discrete("Min Temp")+
  xlab("Region")+
  ylab("% reproduction")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

Fig5_repro_max <- p2[[9]]+
  scale_colour_discrete("Max Temp")+
  xlab("Region")+
  ggtitle("d)")+
  ylab("% reproduction")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



all2 <- p1[[11]][[1]]+
  ylab("")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p1[[11]][[1]]$labels$subtitle))+
  ggtitle("")+
  ylim(c(0.2,0.84))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all1 <- p1[[11]][[2]]+
  ylab("% reproductive")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p1[[11]][[2]]$labels$subtitle))+
  ggtitle("a)")+
  ylim(c(0.2,0.84))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all3 <- p1[[11]][[3]]+
  ylab("")+
  xlab("")+
  ylim(c(0.2,0.84))+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p1[[11]][[3]]$labels$subtitle))+
  # scale_color_discrete("Size")+
  ggtitle("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

all2max <- p2[[11]][[1]]+
  ylab("")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p2[[11]][[1]]$labels$subtitle))+
  ggtitle("")+
  ylim(c(0.2,0.81))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all1max <- p2[[11]][[2]]+
  ylab("% reproductive")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p2[[11]][[2]]$labels$subtitle))+
  ggtitle("b)")+
  ylim(c(0.2,0.81))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all3max <- p2[[11]][[3]]+
  ylab("")+
  xlab("Region")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p2[[11]][[3]]$labels$subtitle))+
  # scale_color_discrete("Size")+╜
  ggtitle("")+
  ylim(c(0.2,0.81))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig5_percReproductive.jpg", sep=""),
       (all1 + all2 + all3)/
        (all1max + all2max + all3max)/
         (Fig4_b_reproduction  + Fig5_repro_max),
       # Fig4_a_reproduction/Fig4_b_reproduction/Fig4_b_reproduction_lm4,
width = 330, height = 210, units = 'mm', dpi=300)

```



```{r}

# Facet order
p2[[9]]$data$facet <- factor(p2[[9]]$data$facet,
                                    levels = c(levels(p2[[9]]$data$facet)[2],
                                               levels(p2[[9]]$data$facet)[1],
                                               levels(p2[[9]]$data$facet)[3]))
## Change facet labels
levels(p2[[9]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p2[[9]]$data$facet) )

Fig4_b_reproduction_lm4 <- p2[[9]]+
  # ggtitle("Predicted probablities of % reproduction")+
  ggtitle("c)")+
  scale_colour_discrete("Max Temp")+
  xlab("Region")+
  ylab("% reproduction")

p2[[8]]$data$facet <- factor(p2[[8]]$data$facet,
                                    levels = c(levels(p2[[8]]$data$facet)[2],
                                               levels(p2[[8]]$data$facet)[1],
                                               levels(p2[[8]]$data$facet)[3]))
  ## Change facet labels
levels(p2[[8]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p2[[8]]$data$facet) )

Fig4_a_reproduction_lm4 <- p2[[8]]+
  # ggtitle("Predicted probablities of % reproduction")+
  ggtitle("c)")+
  scale_colour_discrete("Size")+
  xlab("Region")+
  ylab("% reproduction")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1))


sjPlot::plot_model(lm6, type = "est", show.values = T, transform = NULL)
sjPlot::plot_model(lm4, type = "est", show.values = TRUE, transform = NULL)

## Change names of coefficients in Predictors column
sjPlot::tab_model(lm6, transform = NULL,   # estimates on linear scale
                  # pred.labels = c("Intercept", "size", "min temp","ppt",
                  #                 "region:size","region:min temp","size:Max Temp","ppt:max temp",
                  #                 "size:ppt:max temp"),
                  string.ci = "CI (95%)",
                  string.p = "p-value",
                  show.reflvl = TRUE)  # show reference level for categorical (none here)

```



Figure 3a Number of Sclerocactus glaucus
```{r Figure remove pond}

Fig3a <- ggplot(sg_sum,aes(Year, X/area, colour = Site)) +
  geom_line() +
  geom_point() +
  ggtitle("a)")+
  facet_wrap(~NS + SiteSame, ncol = 5) +
  ylab("Individuals per square meter") +
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))

```


### Figure 3b
```{r}
Fig3b <- ggplot(sg_sum,aes(Year,avgVol,colour=Site))+
  geom_line()+
  geom_point()+
  ggtitle("b)")+
  facet_wrap(~NS + SiteSame, ncol =5)+
  ylab("Average volume")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()
```


Figure 3c
```{r}
#Minis

minis <- aggregate(sg$Minis, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(minis) <- c("Site","Year","Minis")

minisXsize <- aggregate(Width.cm. ~ Site + Year,
                        data = sg[sg$Width.cm.<0.5 & sg$Width.cm.>0 & !is.na(sg$Width.cm.),], function(x) length(x))
minis <- merge(minis, minisXsize, by = c("Site","Year"), all = TRUE)

minis$TotMinis <- rowSums(minis[,3:4],na.rm = TRUE)

repro <- aggregate(sg$Fl, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(repro) <- c("Site","Year","Reproductive")
minis.p.repro <- merge(minis,repro, by = c("Site","Year"))
## Should be year1 repro to how many minis year2
minis.repro <- subset(merge(minis.p.repro,minis.p.repro, by = "Site", sort = FALSE), Year.x == Year.y-1)
minis.repro$MiniXRepro <- minis.repro$TotMinis.y/minis.repro$Reproductive.x

sg[sg$Minis>20 & !is.na(sg$Minis),]

#Minis per reproductive plant  # [!(minis.repro$Site %in% "old"),]
ggplot(minis.repro, aes(Year.y, MiniXRepro, colour = Site))+
  geom_line()+
  scale_x_continuous(breaks = min(minis.repro$Year.y):max(minis.repro$Year.y))+
  xlab("Year")+
  ylab("Recruitment per reproductive individuals")
  

sgminis <- merge(sg_sum, minis.repro[,c(1,2,5:7,10,12)], by.x = c("Site","Year"),by.y = c("Site","Year.y"))

#want average minis per adult plant per site per year

ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = Site, group = Year))+
  geom_boxplot()+
  facet_wrap(~Site)

```

##FIGURE 3c
```{r}
Fig3c <- ggplot(sgminis, aes(Year, TotMinis.x,colour= Site))+
  geom_line()+
  geom_point()+
  ggtitle("c)")+
  facet_wrap(~NS + SiteSame, ncol =5)+ # , scales = "free_y"
  ylab("Total seedlings (< 0.5cm width)")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig3.jpg", sep=""),
Fig3a/Fig3b/Fig3c,
width=250, height=350, units="mm", dpi=300)

```

```{r}

summary(lm(X/area ~ avgVol*TotMinis.y, data=sgminis))

ggplot(sgminis, aes(TotMinis.y, X/area))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(sgminis, aes(TotMinis.y, Rep))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(sgminis, aes(TotMinis.y/Rep, X/area))+
  geom_point()+
  stat_smooth(method="lm")
```



```{r}
par(cex=0.8)  
interaction.plot(sg_sum$Year, factor(sg_sum$Site), 
	as.numeric(sg_sum$X),
	ylab= expression(paste(italic("Sclerocactus glaucus")," individuals per sampling unit")), xlab="Year", 
	trace.label="Site",
	col=c(1:6,11,8:(nlevels(sg_sum$Site))))

```



### statistics
#PVA count based

```{r}
all.count <- lapply(unique(sg_sum$Site), function(x){
  CountPVA(sg_sum$Year[sg_sum$Site == x],sg_sum$X[sg_sum$Site == x])
  })

names(all.count) <- unique(sg_sum$Site)

```

# Demography survival
#how do climatic variables explain growth rates? 
cc.season.notcor are all variables not correlated 50% +
```{r}
lambdas <- do.call(rbind, lapply(all.count, '[[', 1))
lambdas$Site <- sub("\\.[0-9]","",row.names(lambdas)) #get rid of numbers following .

head(lambdas)
head(cc.season.notcor)
str(cc.season.notcor)
## Remove typo from 2021
cc.season.notcor$Site[cc.season.notcor$Site == "T-Junciton"] <- "T-Junction"

# merge the growth rate of the climatic factors of year 2 (so the climate shaping the change from Year 1 to year 2, not before year 1)
sg.pc.lambda <- merge(cc.season.notcor, lambdas, by.x = c("Site","Prev12"), by.y = c("Site","Year2"))

```

#### Demography   

```{r}

Fit.list <- lapply(all.count, '[[', 2) 

last.fit <- do.call(rbind,lapply(Fit.list, function(x){
  out <- exp(x[nrow(x),-c(1:3)])
  years <- x[nrow(x), 1:3]
  data.frame(years,out)
}))


fit.currentYr <- data.frame(Site = rownames(last.fit), last.fit)
plot.currentYr <- melt(fit.currentYr,
                  id.vars = "Site",
                  measure.vars = c("fit","upr","lwr","rsq"))

```

#Demography
#Lambdas by site
```{r}
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
plot.currentYr$NS <- "North"
plot.currentYr$NS[plot.currentYr$Site %in% grep(paste(southsites,collapse="|"),
                                                plot.currentYr$Site, value=TRUE)] <- "South"

#Average growth rate and CI for all sites
aggregate(value ~ variable, data = plot.currentYr, FUN= mean)

#Average growth rate and CI for south and north
aggregate(value ~ variable + NS, data = plot.currentYr, FUN= mean)

#Pyramid Rock growing?
plot.currentYr[plot.currentYr$Site == "Pyramid Rock",]

#Pond shrinking?
plot.currentYr[plot.currentYr$Site == "Pond",]

# Bridgeport and Powerline

plot.currentYr[plot.currentYr$Site == "Powerline",]

plot.currentYr[plot.currentYr$Site == "Bridgeport",]

plot.currentYr[plot.currentYr$Site == "Fram",]

```

#Figure 2: Lambda and 95% CI for each
```{r}
plot.noold <- plot.currentYr[!grepl("old", plot.currentYr$Site),]
plot.noold <- rbind(plot.noold, plot.currentYr[plot.currentYr$Site == "Atwell Gulch (old)",])


jpeg(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig2.jpg", sep=""), width=250, height=200, units="mm", res=300)

ggplot(plot.noold[plot.noold$variable!="rsq",], 
       aes(Site,value, color= variable, group = variable, shape=variable))+
  geom_point(aes(size = 1)) +
  theme_bw()+
  scale_shape_manual(values=c(1,6,2))+
  scale_colour_manual(values=c("black","red", "red"))+
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 0, size = 12))+
  guides(colour= FALSE, shape= FALSE, size = FALSE)+
  labs(y="Lambda")+
  facet_grid(~NS, scales="free")

dev.off()

```

Discussion, lambda patterns
```{r}

fit.currentYr[fit.currentYr$lwr>1,]

```

### Reproduction
```{r}

sum15 <- sg_sum[sg_sum$Year == currentYr,]
sum(sum15$Rep)/sum(sum15$X)

aggregate(sg_sum$Rep, list(Year = sg_sum$Year, Site = sg_sum$SiteSame), sum)
aggregate(sg_sum$X, list(Year = sg_sum$Year, Site = sg_sum$SiteSame), sum)

mean(sg_sum$Prepro)
sd(sg_sum$Prepro)
data.frame(as.table(tapply(sg_sum$Prepro, INDEX = sg_sum$Site, FUN =mean)),
           as.table(tapply(sg_sum$Prepro, INDEX = sg_sum$Site, FUN = sd)))


```


Plant size
## Figure 6
## Figure 5: Growth relationships between years for width (top) and height (bottom) for Sclerocactus glaucus individuals within demographic monitoring sites.    
6 rows of Road T-West that don't have a tag number, one row for Road T-East

```{r}
head(sg)
sg <- sg[!is.na(sg$Tag),]

sg.xy <- subset(merge(sg[,c(2:5,10:11)], sg[,c(2:5,10:11)], by=c("Site","Transect","Tag"),
                      sort=FALSE), Year.x == Year.y+1)
head(sg.xy)
sg.xy[is.na(sg.xy$Tag),]

southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.xy$NS <- "North"
sg.xy$NS[sg.xy$Site %in% grep(paste(southsites,collapse="|"),
                                                sg.xy$Site, value=TRUE)] <- "South"
```

```{r}


ggheight <- ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=glm, aes(y=Height.cm..x, x=Height.cm..y))+
  ggtitle("a)")+
  ylab(expression("Height year"[y]))+
  xlab(expression("Height year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)


ggwidth <- ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=glm, aes(y=Width.cm..x, x=Width.cm..y))+
  ggtitle("b)")+
  ylab(expression("Width year"[y]))+
  xlab(expression("Width year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)


ggsave(filename = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig5a_b.jpg", sep=""),
ggheight/ggwidth,
       width=200, height=230,units='mm', dpi=300)
  

```




# Plant Size
```{r}

summary(lm(Height.cm..x ~ Height.cm..y, data=sg.xy))
summary(lm(Width.cm..x ~ Width.cm..y, data=sg.xy))

# Too many errors, use linear model to get change in size
sg.xy$ChangeH <- sg.xy$Height.cm..x-sg.xy$Height.cm..y
sg.xy$ChangeW <- sg.xy$Width.cm..x-sg.xy$Width.cm..y

mean(sg.xy$ChangeH[abs(sg.xy$ChangeH) < 3], na.rm=TRUE) #No way something lost 11cm or 21cm! that's an error
sd(sg.xy$Height.cm..x-sg.xy$Height.cm..y, na.rm=TRUE)

mean(sg.xy$Width.cm..x-sg.xy$Width.cm..y, na.rm=TRUE)
sd(sg.xy$Width.cm..x-sg.xy$Width.cm..y, na.rm=TRUE)


summary(lm(Prepro~(avgH+avgW)^2, data=sg_sum))

```



Annual report figure for Becky - 20180123
```{r}
plotout <- aggregate(X~Year, data=sg_sum, FUN = sum)
annualppt <- aggregate(ppt~Site+Prev12, data=scgl.c.summary, FUN = sum)
#Average total precipitation over sites
annualppt.avg <- aggregate(ppt~Prev12, data=annualppt, FUN= mean)
avgppt <- mean(annualppt.avg$ppt)
plotout1 <- merge(plotout, annualppt.avg, by.x = "Year", by.y = "Prev12")
plotout1$col[plotout1$ppt<avgppt] <- "Below Average PPT"
plotout1$col[plotout1$ppt>=avgppt] <- "Above Average PPT"
plotout1$growth <- plotout1$X-plotout1$X[1]
plotout1$change <- c(0,plotout1$X[-1]-plotout1$X[-length(plotout1$X)])

ggplot(plotout1, aes(Year,X))+
  geom_bar(stat= "identity", aes(fill=col))+
  theme_classic()

ggplot(plotout1[plotout1$Year>2008,], aes(Year,change))+
  geom_bar(stat= "identity", aes(fill=col))+
  theme_classic()+
  ggtitle("Change in population size from previous year")+
  scale_x_continuous(breaks=seq(2009,currentYr,5))

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/ScGl_yr.jpg", sep=""),device="jpeg",
       ggplot(plotout1, aes(Year,X))+
         geom_line(colour="blue")+
         ylab("Total Population")+
         scale_x_continuous(breaks=seq(2008,currentYr,1))+
         theme_classic()+
         ggtitle("Sclerocactus glaucus"))

write.csv(plotout1, paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/ScGl_data.csv", sep=""))
```
