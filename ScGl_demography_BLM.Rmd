---
title: "ScGl_demography_BLM"
author: "Michelle DePrenger-Levin"
date: "Monday, October 05, 2015"
output: html_document
---

The repository is named "ScGl"   
Will need: git push ScGl master   

2015: uploaded "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Raw Data/2015 Datasheets/DataEntry2015_10.13.15.csv"
```{r}
#if I need it!
rm(list=ls())
```

```{r, echo=FALSE}
library(ggplot2)
library(plyr)
library(devtools)
#library(multcompView)
library(reshape2)
library(raster)
library(prism)
library(RCurl)
library(psych)
#Set wd for prism data if not already
options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")
library(multcompView)


#Some global variables
currentYr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))
```

Need to calculate individuals from 2008 data seperate from following due to lack of measuring hight and width. Will need to get the total tagged individuals for number alive instead of number of individuals with a heigth > 0 from 2009 on. <https://research.botanicgardens.org/admin/>      

In 2012 we switched from measuring the height and width indiviudals under 0.5 cm in width to counting them as "minis". 

2008-currentYr data  
```{r}
# 2015
#sg15 <- read.csv(path.expand("P:/hackathon/ScGl/RawData_scgl_2015_103015.csv"))
#names(sg15)

#2016
# Need to strip white space and conform to 2015 data
sg <- read.csv(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/R_code_ScGl/R_tables/RawData_scgl_", currentYr,".csv",
                     sep=""))
names(sg)

table(sg$Site,sg$Year) 

#Remove rows where Site is blank, if any
sg[which(sg$Site == ""),]
if(nrow(sg[-which(sg$Site == ""),])>0){
  sg <- sg[-which(sg$Site == ""),]
  }

# Vol calculated at pi*r^2*h
sg$Vol <- pi*((sg$Width.cm./2)^2)*sg$Height.cm.

nrow(sg[sg$Year == 2008,])
sg$Site <- factor(sg$Site)
sg[sg$Year == 2013 & sg$Site == "Atwell Gulch",]
sg$Minis[sg$Minis > 1000] <- NA

write.table(sg, file="P:/hackathon/ScGl/datasets/sg.csv", sep=",")

```


##Summarize old and new data by number of individuals    
Need to split by Site - Atwell Gulch needs to be together:  
       `Atwell Gulch_108` and `Atwell Gulch_165` are Atwell Gulch with Ycoord < 30
       Road T-West (old) vs. T-Junction
       Oil Pad and Oil Pad (old)
       Pond and Pond (old)
     
summarize 2008  
```{r}
rm(scgl08)
scgl08 <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/R_code_ScGl/R_tables/All2008.txt"),sep=",")

sg_summary08 <- ddply(scgl08,  
                    .(SiteName,Year), summarise,
                    X = sum(CountofHeight),
                    Rep = sum(SumFlowered),
                    Brs = sum(SumBrowsed),
                    avgH = NA,
                    sdH = NA,
                    avgW = NA,
                    sdW = NA,
                    avgVol = NA,
                    sdVol = NA)

```


```{r}
sg$Fl <- as.character(sg$Fl)
sg$Br <- as.character(sg$Br)

sg$Fl[sg$Fl == "n"] <- "0"
sg$Fl[sg$Fl == "y"] <- "1"

sg$Br[sg$Br == "n"] <- "0"
sg$Br[sg$Br == "y"] <- "1"

sg$Fl <- as.numeric(sg$Fl)
sg$Br <- as.numeric(sg$Br)

```


#Old and New data     
Atwell Gulch old is everything with a Y less than 30    
Atwell Gulch new is everything Atwell Gulch    
Rename Sites for Atwell old and new
```{r}
# Add a level to the Site factor field
sg$Site <- factor(sg$Site, 
                  levels = c("Atwell Gulch", "Atwell Gulch (old)",levels(sg$Site)))

# Rename all Atwell Gulch
sg[grep("Atwell", sg$Site),"Site"] <- "Atwell Gulch"

# One copy of all Atwell Gulch 2012 on for new
atwell.new <- sg[intersect(grep("Atwell",sg$Site),which(sg$Year>2011)),]

atwell.old <- sg[intersect(grep("Atwell",sg$Site),which(sg$Y.coord.m.<30)),] 
atwell.old$Site <- "Atwell Gulch (old)"

```

#2016 on    
No more "Old" versions. Need to remove these data - tags that were in both versions are still reported. 
Stop Pond old in 2015
Keep Atwell old and new
Fram no data in 2015
```{r}
#Road T-East
sg <- sg[grep("Road T-East", sg$Site, invert=TRUE),]


#No "old" 2016 on
sg <- sg[-intersect(grep("old", sg$Site),which(sg$Year>2015)),]

#No Pond in 2015
sg <- sg[-intersect(grep("Pond", sg$Site), which(sg$Year==2015)),]

#Add back Atwell duplicated for old and new
sg <- rbind(sg[grep("Atwell", sg$Site, invert = TRUE),],atwell.new,atwell.old)
sg$Site <- droplevels(sg$Site)

table(sg$Site,sg$Year)
```

#Data checks
```{r}
ggplot(sg[sg$Site == "Picnic Site",], aes(Transect,Height.cm.))+
  geom_point()

ggplot(sg[sg$Site == "Pond",], aes(Transect,Height.cm.))+
  geom_point()
```



2008 is a summary already, need to summarize rest before combining with 2008. 
```{r}
sg_summary <- ddply(sg[sg$Year>2008,],  
                    .(Site,Year), summarise,
                    X = length(Tag[Height.cm. > 0]),
                    Rep = sum(Fl, na.rm = TRUE),
                    Brs = sum(Br, na.rm = TRUE),
                    avgH = mean(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                    sdH = sd(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                    avgW = mean(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                    sdW = sd(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                    avgVol = mean(Vol, na.rm = TRUE),
                    sdVol = sd(Vol, na.rm = TRUE))

head(sg_summary)
table(sg_summary$Site,sg_summary$Year)
```

#Data summary
Combine 2008 (with no height or width data) and remaining years 
```{r}
names(sg_summary08) <- names(sg_summary)
sg_sum <- rbind(sg_summary08,sg_summary)
```

All sites 
```{r}
ggplot(sg_sum, aes(Year,X,colour=Site))+
  geom_point(size=3)+
  geom_line()
```

All sites separate plots
```{r}
ggplot(sg_sum, aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  ylab("Total individuals")
```

All the new ones
```{r}
ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  ylab("Total individuals")
```


```{r}
ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], aes(Year,X,colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg_sum$Site[grep("old",sg_sum$Site,invert=TRUE)]))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")+
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 2))
```


All the old ones
```{r}
ggplot(sg_sum[grep("old",sg_sum$Site),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_grid(~Site)+
  ylab("Total individuals")+
  theme_bw()
```

```{r}
ggplot(sg_sum[grep("old",sg_sum$Site),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```


old and new
```{r}
oldnew <- c("Oil","Pond","T-","Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")+
  theme_bw()
```


#Pond
```{r}
oldnew <- c("Pond")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") 
```

Is T-Junction missing some - should be finding more individuals
#T-Junction
```{r}
oldnew <- c("T-")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

#Oil Pad
```{r}
oldnew <- c("Oil")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

#Atwell
```{r}
oldnew <- c("Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

Report Tables_current year
Table 2: Summary data of Sclerocactus glaucus demographic monitoring in western Colorado (2008-2015).
```{r}
#save to clipboard to excel sheet in correct format ("$" says the end of the string)
new <- c("Atwell Gulch$","Oil Pad","Pond","T-Junction")
poststand <- sg_sum[sg_sum$Year == currentYr & sg_sum$Site %in% grep(paste(new,collapse="|"),
                                                        sg_sum$Site,value=TRUE),]

sg_sum[sg_sum$Year == currentYr,]

prestand <- sg_sum[sg_sum$Year == currentYr & !sg_sum$Site %in% grep(paste(new,collapse="|"),
                                                        sg_sum$Site,value=TRUE),]

write.table(poststand, "clipboard", sep="\t", row.names=FALSE)
write.table(prestand,  "clipboard", sep="\t", row.names=FALSE)
#Report Tables_20XX
```


Climate directly from PRISM   
### update only the previous year each year  
```{r, eval=FALSE}
#devtools::install_github("ropensci/prism")
library(prism)

# Set wd for prism
options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")

```


# Precip Total precipitation (rain and snow)
```{r}
#get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = 1986:currentYr)
```

#Update last year and get this year 
```{r}
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

```


```{r}
# Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)
```

Pick up any that didn't download
```{r}
get_prism_monthlys(type="ppt", mon=3, keepZip = FALSE, years = 1995)
get_prism_monthlys(type="ppt", mon=5, keepZip = FALSE, years = 1988)
get_prism_monthlys(type="ppt", mon=10, keepZip = FALSE, years = 2001)
get_prism_monthlys(type="ppt", mon=11, keepZip = FALSE, years = 2004)
get_prism_monthlys(type="ppt", mon=7, keepZip = FALSE, years = 2007)
get_prism_monthlys(type="ppt", mon=12, keepZip = FALSE, years = 2009)
```


Lat longs for 10 sites   
39.1969°N, 108.1298°W Atwell    
38.8491°N, 108.3717°W Bridgeport   
38.6593°N, 108.3466°W Escalante     
39.0612°N, 108.3799°W Fram        
39.3446°N, 108.3102°W Oil Pad    
38.6701°N, 108.3286°W Picinic    
39.3606°N, 108.3136°W Pond    
38.7291°N, 108.1770°W Powerline   
39.3069°N, 108.2755°W Pyramid Rock   
39.3544°N, 108.3286°W T-Junciton   
```{r}
latlong <- data.frame(rbind(c(39.1969, -108.1298, "Atwell Gulch"),
#                            c(39.1969, -108.1298, "Atwell Gulch (old)"),
                            c(38.8491, -108.3717, "Bridgeport"),   
                            c(38.6593, -108.3466, "Escalante Canyon"),
                            c(39.0612, -108.3799, "Fram"),
                            c(39.3446, -108.3102, "Oil Pad"),
#                            c(39.3446, -108.3102, "Oil Pad (old)"),
                            c(38.6701, -108.3286, "Picnic Site"),
                            c(39.3606, -108.3136, "Pond"),
#                            c(39.3606, -108.3136, "Pond (old)"),
                            c(38.7291, -108.1770, "Powerline"),
                            c(39.3069, -108.2755, "Pyramid Rock"),
                            c(39.3544, -108.3286, "T-Junciton")))
#,
#                            c(39.3544, -108.3286, "Road T-West (old)")))   
names(latlong) <- c("Lat","Long","Site")
latlong[,1:2] <- sapply(latlong[,1:2], function(x) as.numeric(as.character(x)))
```

# Go into folder "Q:\Research\All_Projects_by_Species\Sclerocactus SPECIES\Sclerocactus_glaucus\ScGl_climate\PRISM_ppt_provisional_4kmM3_201601_bil" and delete the provisional ones from last year   

```{r}
ppt <- grep("ppt", ls_prism_data(absPath = TRUE)[,2])
#ppt2 <- grep(paste("ppt_stable",paste("ppt_provisional_4kmM3_",currentYr,sep=""),collapse="|"),ls_prism_data(absPath = TRUE)[,2])

m.ppt <- lapply(ppt, function(x){
  rastertemps <- raster(ls_prism_data(absPath = TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlong[,c("Long","Lat")]), 
             date = ls_prism_data()[x,], Site = latlong$Site)
})
```


Max temp   
16 years 2000:currentYr
```{r}
tmax <- grep("tmax", ls_prism_data(absPath = TRUE)[,2])

m.tmax <- lapply(tmax, function(x){
  rastertemps <- raster(ls_prism_data(absPath = TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlong[,c("Long","Lat")]), 
             date = ls_prism_data()[x,], Site = latlong$Site)
})
```


Min temp   
16 years 2000:currentYr
```{r}
tmin <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])

m.tmin <- lapply(tmin, function(x){
  rastertemps <- raster(ls_prism_data(absPath = TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlong[,c("Long","Lat")]), 
             date = ls_prism_data()[x,], Site = latlong$Site)
})
```

PRISM_ppt_stable_4kmM3_201512_bil

# Combine climate data from library(prism)   

Strip off the last bit after the last underscore    

     scgl.temps$date <- sapply(scgl.temps$date, function(x){
       unlist(strsplit(x, "_\\s*(?=[^_]+$)", perl=TRUE))[[1]]
       })  
       
```{r}
scgl.climate <- rbind(do.call(rbind, m.tmin), 
                    do.call(rbind, m.tmax),
                    do.call(rbind, m.ppt))
#turn factors into characters
scgl.climate$date <- sapply(scgl.climate$date, as.character)

scgl.climate$Year <- sapply(scgl.climate$date, function(x){
  substr(x, (nchar(x)+1)-10,nchar(x)-6)
})
scgl.climate$Month <- sapply(scgl.climate$date, function(x){
  substr(x, (nchar(x)+1)-6,nchar(x)-4)
})

#Character to numeric
scgl.climate[,4:5] <- sapply(scgl.climate[,4:5], as.numeric)

scgl.climate$Prev12 <- scgl.climate$Year 
scgl.climate$Prev12[scgl.climate$Month > 5] <- scgl.climate$Year[scgl.climate$Month>5]+1

#extract the climate variable name from the prism long name
scgl.climate$date <- as.character(scgl.climate$date)
scgl.climate$Variable <- sapply(scgl.climate$date, function(x) {
  unlist(strsplit(x, split="_", fixed=TRUE))[[2]]
  })

str(scgl.climate)

#long to wide
melt.scgl <- melt(scgl.climate[,-2], id = c("Site","Prev12","Month","Year","Variable"))
head(melt.scgl)

sp.melt.scgl <- split(melt.scgl, melt.scgl$Variable)

head(sp.melt.scgl[[2]])

scgl.c.1 <- merge(sp.melt.scgl[[1]],sp.melt.scgl[[2]], by = c("Site","Prev12","Month","Year"))
scgl.c.1 <- scgl.c.1[,c("Site","Prev12","Month","Year","value.x","value.y")]
names(scgl.c.1) <- c("Site","Prev12","Month","Year","ppt","tmax")

scgl.c.2 <- merge(scgl.c.1,sp.melt.scgl[[3]], by = c("Site","Prev12","Month","Year"))
head(scgl.c.2)
scgl.c <- scgl.c.2[,c("Site","Prev12","Month","Year","ppt","tmax","value")]
names(scgl.c) <- c("Site","Prev12","Month","Year","ppt","tmax","tmin")

scgl.c$season <- "winter"
scgl.c[scgl.c$Month>5 & scgl.c$Month<9, "season"] <- "summer"
scgl.c[scgl.c$Month>8 & scgl.c$Month<12, "season"] <- "fall"
scgl.c[scgl.c$Month>2 & scgl.c$Month<6, "season"] <- "spring"
```

          Site Precip  tmin tmax Year Month Prev12 season
1 Atwell Gulch  54.37 -10.1  2.0 1895     1   1895 winter
2 Atwell Gulch  26.50 -10.0  4.0 1895     2   1895 winter
3 Atwell Gulch  23.35  -4.1 11.1 1895     3   1895 spring
4 Atwell Gulch  12.97   0.5 19.3 1895     4   1895 spring
5 Atwell Gulch  31.98   4.9 23.5 1895     5   1895 spring
6 Atwell Gulch  19.17   7.4 26.8 1895     6   1896 summer
> names(scgl.c)
[1] "Site"   "Precip" "tmin"   "tmax"   "Year"   "Month"  "Prev12" "season"


scgl.c <- scgl.climate[,c(1,3,5,7:9)]
names(scgl.c) <- c("Site","Precip","tmin","tmax","Year","Month")

####Summarize climate data
Climate of the previous 12 month to the May data collection

###PCA for climate factors
calculate seasonal climate averages    
summer: June-August (6-8)
fall: September-November (9-11)
winter: December-February (12, 1-2)
spring: March-May (3-5)
```{r}
scgl.c.summary <- aggregate(scgl.c[,c("ppt","tmax","tmin")],
                            scgl.c[,c("Site","Prev12","season")],
                            FUN = function(x) mean(x, na.rm = TRUE))

season <- reshape(scgl.c.summary[scgl.c.summary$Prev12<currentYr+1,],
                  idvar = c("Site","Prev12"),
                  timevar = "season",
                  direction = "wide")
```


summarySE function borrowed from http://www.cookbook-r.com/Manipulating_data/Summarizing_data/
```{r}
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}
```

summary statistics
```{r}
scgl_sumSE <- lapply(names(scgl.c[,c("ppt","tmin", "tmax")]), 
                     function(x){
                       summarySE(scgl.c, measurevar=x, groupvars=c("Site","Prev12"))
                       }) 

scgl_sumSE[[1]]$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_sumSE[[1]]$NS[scgl_sumSE[[1]]$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     scgl_sumSE[[1]]$Site,
                                     value=TRUE))] <- "South"

scgl_sumSE[[2]]$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_sumSE[[2]]$NS[scgl_sumSE[[2]]$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     scgl_sumSE[[2]]$Site,
                                     value=TRUE))] <- "South"

scgl_sumSE[[3]]$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_sumSE[[3]]$NS[scgl_sumSE[[3]]$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     scgl_sumSE[[3]]$Site,
                                     value=TRUE))] <- "South"

```

Precipitation per site
```{r}
ggplot(scgl_sumSE[[1]][scgl_sumSE[[1]]$Prev12>2000&
                         scgl_sumSE[[1]]$Prev12<currentYr,],
       aes(Prev12, ppt, colour=Site))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=ppt-se, ymax=ppt+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average precipitation per site") 

```
Precipitation North vs. South
```{r}
ggplot(scgl_sumSE[[1]][scgl_sumSE[[1]]$Prev12>2000&
                         scgl_sumSE[[1]]$Prev12<currentYr,],
       aes(Prev12, ppt, colour=NS, group=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=ppt-se, ymax=ppt+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average precipitation per site") 

t.test(ppt~NS, data = scgl_sumSE[[1]])
```

Minimum temperature per site (Celcius)
```{r}
ggplot(scgl_sumSE[[2]][scgl_sumSE[[2]]$Prev12>2000&
                         scgl_sumSE[[2]]$Prev12<currentYr+1,],
       aes(Prev12, tmin, colour=Site))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmin-se, ymax=tmin+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average minimum temperature per site") 

```

```{r}
ggplot(scgl_sumSE[[2]][scgl_sumSE[[2]]$Prev12>2000&
                         scgl_sumSE[[2]]$Prev12<currentYr+1,],
       aes(Prev12, tmin, colour=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmin-se, ymax=tmin+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average minimum temperature per site") 

```

Maximum temperature per site (C)
```{r}
ggplot(scgl_sumSE[[3]][scgl_sumSE[[3]]$Prev12>2000&
                         scgl_sumSE[[3]]$Prev12<currentYr+1,],
       aes(Prev12, tmax, colour=Site))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmax-se, ymax=tmax+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average maximum temperature per site") 

```
```{r}
ggplot(scgl_sumSE[[3]][scgl_sumSE[[3]]$Prev12>2000&
                         scgl_sumSE[[3]]$Prev12<currentYr+1,],
       aes(Prev12, tmax, colour=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmax-se, ymax=tmax+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average maximum temperature per site") 

t.test(tmax~NS, data= scgl_sumSE[[3]])
```

Take out missing data, Years 1986 through current year as previous 12 years to the May survey

```{r}
head(season)
tail(season)
names(season)
sort(unique(season$Prev12))

nrow(season) #310
cc.season <- season[complete.cases(season),]
str(cc.season)
nrow(cc.season) #300
unique(sort(cc.season$Prev12)) #1986:current year

cor.plot(cor(cc.season[,-c(1:2,grep("Year", names(cc.season)),
                        grep("Month", names(cc.season)))]), numbers = TRUE)
```

Ditch anything 50% or more correlated of the pair that explains less variation, get r^2 values

```{r}

#mlogit(Site~1|ppt.fall+tmax.fall+tmin.fall, cc.season)

#rsqs <- lapply(3:length(cc.season), function(x){
 # lm <- summary(glm(as.factor(cc.season$Site)~cc.season[,x]))
  #lm$adj.r.squared
#})

cor.table<-cor(cc.season[,-c(1:2,grep("Year", names(cc.season)),
                        grep("Month", names(cc.season)))])

rm(data,combins,cor.data,exclude,tomatch)
data <- as.data.frame(as.table(cor.table))
combins <- combn(colnames(cor.table),2,FUN = function(x) {paste(x,collapse="_")})
cor.data <- data[data$Var1 != data$Var2,]
data <- cor.data[paste(cor.data$Var1, cor.data$Var2, sep="_") %in% combins,]
exclude <- paste(data$Var2[abs(data$Freq)>0.49],sep=",")

tomatch <- c("Year","Month","Site","Prev12",exclude)

# Seasonal varaibles kept for the PCA
names(cc.season[,c(grep(paste(tomatch,collapse="|"),
                        names(cc.season), value=TRUE, invert = TRUE))])

# Climatic variables used in PCA 1986-current year
sort(grep(paste(tomatch,collapse="|"),names(cc.season), value=TRUE, invert = TRUE))

forpca <- cc.season[,c(grep(paste(tomatch,collapse="|"),
                            names(cc.season), value=TRUE, invert = TRUE))]

scgl.pca <- princomp(forpca,cor=TRUE)
summary(scgl.pca)
scgl.load <- loadings(scgl.pca)
write.table(scgl.load, "clipboard", sep="\t", row.names=TRUE)
scgl.pc <- predict(scgl.pca)

sg.pc <- data.frame(scgl.pc,cc.season)
# Assign genetic regions
sg.pc$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.pc$NS[sg.pc$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     sg.pc$Site,
                                     value=TRUE))] <- "South"
```

#Table 3a)    
```{r}
data[abs(data$Freq)>0.5,]
```

Site differences
#Figure 4b  
1986-2016
```{r}
ggplot(sg.pc, aes(Comp.1,Comp.2, colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg.pc$Site))+
  geom_point() +
  stat_ellipse() +
  theme_bw() 
```

North/South differences
#Figure 4a
```{r}
ggplot(sg.pc, aes(Comp.1,Comp.2, colour=NS, shape=NS))+
  geom_point() +
  stat_ellipse() +
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))+
  guides(shape=guide_legend(title="Genetic region"))
```

#Figure 4c
Use all years of data for all plots comparison?
The letters won't line up with the sites unless specified
```{r}
#doesn't like "-" in the name
levels(sg.pc$Site) <- c(as.character(unique(sg.pc$Site))[-10], "TJunction")
sg.thsd <- TukeyHSD(aov(Comp.1~Site, data=sg.pc))

lasign <- multcompLetters(extract_p(sg.thsd$Site))

SiteLetters <- data.frame(Letter = lasign$Letters,
                          Site = rownames(data.frame(lasign$Letters)))


ggplot(sg.pc, aes(Site, Comp.1, colour=NS))+
  stat_boxplot(geom='errorbar')+
  geom_boxplot()+
  annotate("text",x=1:10, y = 5,
           label = SiteLetters$Letter[c(10,1:9)])+
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))

t.test(Comp.1~NS, data=sg.pc)

```

#### Figure 4: The Principal Components Analysis (PCA) of climatic variables with loadings  by a) genetic region and b) site. c) Site distribution along PC1 is shown with Tukey Honest Significant Differences. 
```{r}
ggplot(sg.pc, aes(Comp.1,Comp.2, colour=NS))+
  geom_point() +
  stat_ellipse() +
  theme_bw() +
  theme(legend.justification=c(0,1), legend.position=c(0,1))

t.test(Comp.1~NS, data=sg.pc)
```

# PCA 2008-2015
Try for only the study period 
Prev12 is the May of the previous year through the April of the current year

```{r}
recent <- season[season$Prev12 > 2007 & season$Prev12 < currentYr+1,]
cor.plot(cor(recent[,-c(1:2,grep("Year", names(recent)),
                        grep("Month", names(recent)))]), numbers = TRUE)

```

#### 2008-2015
Ditch anything 50% or more correlated 

```{r}
cor.table.r<-cor(recent[,-c(1:2,grep("Year", names(recent)),
                        grep("Month", names(recent)))])
data.r <- as.data.frame(as.table(cor.table.r))
combins.r <- combn(colnames(cor.table.r),2,FUN = function(x) {paste(x,collapse="_")})
cor.data.r <- data.r[data.r$Var1 != data.r$Var2,]
data.r <- cor.data.r[paste(cor.data.r$Var1, cor.data.r$Var2, sep="_") %in% combins.r,]
exclude.r <- paste(data.r$Var2[abs(data.r$Freq)>0.49],sep=",")

tomatch.r <- c("Year","Month","Site","Prev12",exclude.r)

forpca.r <- recent[,c(grep(paste(tomatch.r,collapse="|"),
                            names(recent), value=TRUE, invert = TRUE))]

#Variables kept for 2007 May - current year
sort(grep(paste(tomatch.r,collapse="|"),names(recent), value=TRUE, invert = TRUE))

scgl.pca.r <- princomp(forpca.r,cor=TRUE)
summary(scgl.pca.r)
scgl.load.r <- loadings(scgl.pca.r)
scgl.pc.r <- predict(scgl.pca.r)

sg.pc.r <- data.frame(scgl.pc.r,recent)
# Assign genetic regions
sg.pc.r$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.pc.r$NS[sg.pc.r$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     sg.pc.r$Site,
                                     value=TRUE))] <- "South"
```

# Table 3b) 2008 - current year
```{r}
data.r[abs(data.r$Freq) > 0.5,]
```

In case of "Error in .Call.graphics(C_palette2, .Call..."  
use dev.off()

```{r}
ggplot(sg.pc.r, aes(Comp.1,Comp.2, colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg_sum$Site[grep("old",sg_sum$Site,invert=TRUE)]))+
  geom_point() +
  stat_ellipse() +
  theme_bw()


ggplot(sg.pc.r, aes(Comp.1,Comp.2, colour=NS, shape=NS))+
  geom_point() +
  stat_ellipse() +
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))+
  guides(shape=guide_legend(title="Genetic region")) 

t.test(Comp.1~NS, data=sg.pc.r)
t.test(Comp.2~NS, data=sg.pc.r)


```

Figure 4 f) Site distribution along PC1 is shown with Tukey Honest Significant Differences. 

```{r}
#doesn't like "-" in the name
levels(sg.pc.r$Site) <- c(as.character(unique(sg.pc.r$Site))[-(10)],"TJunction")

sg.thsd2 <- TukeyHSD(aov(Comp.2~Site, data=sg.pc.r))
lasign2 <- multcompLetters(extract_p(sg.thsd2$Site))

SiteLetters2 <- data.frame(Letter = lasign2$Letters[],
                          Site = rownames(data.frame(lasign2$Letters)))
Siteletters2 <- SiteLetters[order(SiteLetters2$Site),]

sg.thsd1 <- TukeyHSD(aov(Comp.1~Site, data=sg.pc.r))
lasign1 <- multcompLetters(extract_p(sg.thsd1$Site))

SiteLetters1 <- data.frame(Letter = lasign1$Letters[],
                          Site = rownames(data.frame(lasign1$Letters)))
Siteletters1 <- SiteLetters[order(SiteLetters1$Site),]


ggplot(sg.pc.r, aes(Site, Comp.2, colour=NS))+
  stat_boxplot(geom='errorbar')+
  geom_boxplot()+
  annotate("text",x=1:10, y = 4,
           label = SiteLetters2$Letter[c(10,1:9)])+
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))

ggplot(sg.pc.r, aes(Site, Comp.1, colour=NS))+
  stat_boxplot(geom='errorbar')+
  geom_boxplot()+
  annotate("text",x=1:10, y = 4,
           label = SiteLetters1$Letter[c(10,1:9)])+
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))
```

#### Figure 2: a) Number of Sclerocactus glaucus individuals per square meter in the northern genetic region (North) and the southern genetic region (South), and b) Average size of individuals per site. 

```{r}
sg_sum[sg_sum$Site == "",]
sg_sum <- sg_sum[sg_sum$Site != "",]
#reset levels to not include blank
sg_sum$Site <- factor(sg_sum$Site)

# total area from table 2

unique(sg_sum$Site)
sg_sum$area[sg_sum$Site == "Escalante Canyon"] <- 180
sg_sum$area[sg_sum$Site == "Bridgeport"] <- 400
sg_sum$area[sg_sum$Site == "Atwell Gulch"] <- 390
sg_sum$area[sg_sum$Site == "Atwell Gulch (old)"] <- 300
sg_sum$area[sg_sum$Site == "Fram"] <- 1300
sg_sum$area[sg_sum$Site == "Oil Pad (old)"] <- 672
sg_sum$area[sg_sum$Site == "Oil Pad"] <- 120
sg_sum$area[sg_sum$Site == "Picnic Site"] <- 160
sg_sum$area[sg_sum$Site == "Pond"] <- 36
sg_sum$area[sg_sum$Site == "Pond (old)"] <- 235.6
sg_sum$area[sg_sum$Site == "Powerline"] <- 40
sg_sum$area[sg_sum$Site == "Pyramid Rock"] <- 100
sg_sum$area[sg_sum$Site == "Road T-West (old)"] <- 2212
sg_sum$area[sg_sum$Site == "T-Junction"] <- 130

sg_sum$SiteSame <- sg_sum$Site
sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("Atwell",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "Atwell Gulch"

sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("Pond",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "Pond"

sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("Oil",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "Oil Pad"

sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("T-",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "T-Junction"

table(sg_sum$Site,sg_sum$SiteSame)

# Assign genetic regions
sg_sum$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg_sum$NS[sg_sum$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     sg_sum$Site,
                                     value=TRUE))] <- "South"

require(scales)

unique(sg_sum$Site)

sg_sum1 <- sg_sum
sg_sum1$X[which("Pond" == sg_sum1$Site)] <- sg_sum1$X[which("Pond" == sg_sum1$Site)]/2

```


#Reproduction
```{r}
#Percent Reproductive in current year (but don't repeat Atwell Gulch ones)
sum(sg_sum$Rep[sg_sum$Year==currentYr & 
                 sg_sum$Site !="Atwell Gulch (old)"])/sum(sg_sum$X[sg_sum$Year==currentYr & 
                 sg_sum$Site !="Atwell Gulch (old)"])

#average volume, height, and width explains reproductive status
sg_sum$Prepro <- sg_sum$Rep/sg_sum$X
summary(lm(Prepro~(avgH+avgW+avgVol)^2, data=sg_sum))
```


```{r}


ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], 
       aes(Year, Prepro, group = Site, colour = Site)) +
  geom_point()+
  geom_line()+
  ylab("Percent reproductive") +
  facet_wrap(~NS+Site,ncol = 5) +
  theme_bw()
```

```{r}
sg_sum[sg_sum$Site=="Pond",]

summarySEreproductive <- summarySE(sg_sum, measurevar = "Prepro", groupvars=c("Site"))


summary(lm(Prepro~(avgW+avgVol)^2, data=sg_sum))


summary(lm(Prepro~avgVol, data=sg_sum))
summary(lm(Prepro~avgW, data=sg_sum))
summary(lm(Prepro~avgH, data=sg_sum))

```


#### Table 3: Correlations stronger than 0.5 between environmental variables at all sites for the months preceding yearly May monitoring of Sclerocactus glaucus. 

```{r}

as.data.frame(as.table(cor(recent[,-c(1:2,grep("Year", names(recent)),
                        grep("Month", names(recent)))])))


cor.table<-cor(recent[,-c(1:2,grep("Year", names(recent)),
                        grep("Month", names(recent)))])
data <- as.data.frame(as.table(cor.table))
combins <- combn(colnames(cor.table),2,FUN = function(x) {paste(x,collapse="_")})
cor.data <- data[data$Var1 != data$Var2,]
data <- cor.data[paste(cor.data$Var1, cor.data$Var2, sep="_") %in% combins,]
```


Figure 3a Number of sclerocactus glaucus
```{r Figure  remove pond}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig3a.jpg", sep=""), width=250, height=125, units="mm", res=300)


ggplot(sg_sum,aes(Year, X/area, colour = Site)) +
  geom_line() +
  geom_point() +
  facet_wrap(~NS + SiteSame, ncol = 5) +
  ylab("Individuals per square meter") +
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 2))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))

dev.off()

```


### Figure 3b
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig3b.jpg", sep=""), width=250, height=125, units="mm", res=300)


ggplot(sg_sum,aes(Year,avgVol,colour=Site))+
  geom_line()+
  geom_point()+
  facet_wrap(~NS + SiteSame, ncol =5)+
  ylab("Average volume")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 2))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()

dev.off()
```


Figure 3c
```{r}
#Minis

minis <- aggregate(sg$Minis, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(minis) <- c("Site","Year","Minis")

repro <- aggregate(sg$Fl, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(repro) <- c("Site","Year","Reproductive")
minis.p.repro <- merge(minis,repro, by = c("Site","Year"))
minis.p.repro$PerM <- minis.p.repro$Minis/minis.p.repro$Reproductive

sg[sg$Minis>20 & !is.na(sg$Minis),]

#Minis per reproductive plant
ggplot(minis.p.repro, aes(Year, PerM))+
  geom_line()+
  facet_wrap(~Site)

sgminis <- merge(sg_sum, minis, by = c("Site","Year"))

#want average minis per adult plant per site per year

ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = Site, group = Year))+
  geom_boxplot()+
  facet_wrap(~Site)

ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = Site))+
  geom_point()+
  facet_wrap(~Site)

#Some die, some grow into big ones. 
ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = as.factor(Tag)))+
  geom_line()+
  facet_wrap(~Site)+
  theme(legend.position = "none")
```

```{r}

##FIGURE 3c
ggplot(sgminis[grep("old",sgminis$Site,invert=TRUE),], 
       aes(Year, Minis,colour= Site, shape = Site))+
  scale_shape_manual(values=1:10)+
  geom_point()+
  geom_line()+
  theme_bw()+
  scale_x_continuous(breaks = seq(2011, currentYr, 2))+ 
  xlim(c(2011, currentYr))
  

```


```{r}
par(cex=0.8)  
interaction.plot(sg_sum$Year, factor(sg_sum$Site), 
	as.numeric(sg_sum$X),
	ylab= expression(paste(italic("Sclerocactus glaucus")," individuals per sampling unit")), xlab="Year", 
	trace.label="Site",
	col=c(1:6,11,8:(nlevels(sg_sum$Site))))

```


####Figure 6: The plot design for four ScGl sites were changed in 2012...   
START HERE!! fix the x axis lables, not .5
```{r}
# old and new
oldnew <- c("Oil","Pond","T-","Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") +
  facet_wrap(~SiteSame)+
  theme_bw()+
  scale_x_continuous(breaks = seq(2009, currentYr, 1))

```


### statistics
count pva
```{r}
# x = Year, y = count
CountPVA <- function(x,y){
  
  LM.table <- c()
  
  for(yrs in 3:length(unique(x))){		# gives 2 transitions before the first Count PVA calculation
		rsq <- c(); PVA.lm <- list()
  
    y.count <- y[1:yrs] #Annual count for site
    x.years <- x[1:yrs] #Years of counts (can have missing years)
    ySpecies <- log10(y.count[-1]/y.count[-length(y.count)])
    yr <- sqrt(x.years[-1]-x.years[-length(x.years)])
    
		PVA.lm <- lm(ySpecies ~ -1 + yr)
		mu_sp <- predict(PVA.lm, level= 0.95,
		                 interval = "confidence",
		                 se.fit = T)$fit[1,]
    rsq <- c(rsq, R2 = summary(PVA.lm)$adj.r.squared)	# pull R squared values from each year interval 
    LM.table <- rbind(LM.table,data.frame(rsq,RangeStart=min(x),RangeEnd=x[yrs],t(mu_sp)))    
	}
	Year1 <- x.years[-length(x.years)]
	Year2 <- x.years[-1]
	PVA.table <-data.frame(yr,ySpecies,Year1,Year2)
  
  list(PVA = PVA.table,LM = LM.table)
}

```

#PVA count based

```{r}
all.count <- lapply(unique(sg_sum$Site), function(x){
  CountPVA(sg_sum$Year[sg_sum$Site == x],sg_sum$X[sg_sum$Site == x])
  })

names(all.count) <- unique(sg_sum$Site)

all.count
```

#### Demography   

```{r}
# average fit for current year over all sites
last.fit <- sapply(all.count, function(x){
  x$LM[nrow(x$LM),]
})

tlast.fit <- data.frame(t(last.fit))
apply(tlast.fit[tlast.fit$RangeEnd == currentYr,4:6], 2, 
      FUN = function(x) mean(exp(as.numeric(x)), na.rm=TRUE)) #arithmetic mean

fit.currentYr <- tlast.fit[tlast.fit$RangeEnd == currentYr,]

fit.currentYr <- transform(fit.currentYr, fit = exp(as.numeric(fit)), 
                      lwr = exp(as.numeric(lwr)), 
                      upr = exp(as.numeric(upr)))
fit.currentYr <- data.frame(Site = rownames(fit.currentYr), fit.currentYr)
plot.currentYr <- melt(fit.currentYr,
                  id.vars = "Site",
                  measure.vars = c("fit","upr","lwr"))

```

#Demography
#Lambdas by site
```{r}
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
plot.currentYr$NS <- "North"
plot.currentYr$NS[plot.currentYr$Site %in% grep(paste(southsites,collapse="|"),
                                                plot.currentYr$Site, value=TRUE)] <- "South"

#Average growth rate and CI for south and north
aggregate(value ~ variable + NS, data = plot.currentYr, FUN= mean)
#Average growth rate and CI for all sites
aggregate(value ~ variable, data = plot.currentYr, FUN= mean)
#Pyramid Rock growing?
plot.currentYr[plot.currentYr$Site == "Pyramid Rock",]
```

#Figure 2: Lambda and 95% CI for each
```{r}
ggplot(plot.currentYr, aes(Site,value, color= variable, group = variable, shape=variable))+
  geom_point(aes(size = 1)) +
  theme_bw()+
  scale_shape_manual(values=c(1,6,2))+
  scale_colour_manual(values=c("black","red", "red"))+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0, size = 12))+
  guides(colour= FALSE, shape= FALSE, size = FALSE)+
  labs(y="Lambda")+
  facet_grid(~NS, scales="free")

```

### Reproduction
```{r}

sum15 <- sg_sum[sg_sum$Year == currentYr,]
sum(sum15$Rep)/sum(sum15$X)

aggregate(sg_sum$Rep, list(Year = sg_sum$Year, Site = sg_sum$SiteSame), sum)
aggregate(sg_sum$X, list(Year = sg_sum$Year, Site = sg_sum$SiteSame), sum)

mean(sg_sum$Prepro)
sd(sg_sum$Prepro)
data.frame(as.table(tapply(sg_sum$Prepro, INDEX = sg_sum$Site, FUN =mean)),
           as.table(tapply(sg_sum$Prepro, INDEX = sg_sum$Site, FUN = sd)))


```


Plant size

## Figure 5: Growth relationships between years for width (top) and height (bottom) for Sclerocactus glaucus individuals within demographic monitoring sites.    
6 rows of Road T-West that don't have a tag number, one row for Road T-East

```{r}
head(sg)
sg <- sg[!is.na(sg$Tag),]

sg.xy <- subset(merge(sg[,c(2:5,10:11)], sg[,c(2:5,10:11)], by=c("Site","Transect","Tag"),
                      sort=FALSE), Year.x == Year.y+1)
head(sg.xy)
sg.xy[is.na(sg.xy$Tag),]

southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.xy$NS <- "North"
sg.xy$NS[sg.xy$Site %in% grep(paste(southsites,collapse="|"),
                                                sg.xy$Site, value=TRUE)] <- "South"
```

```{r}
ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=lm, aes(y=Height.cm..x, x=Height.cm..y))+
  ylab(expression("Height year"[y]))+
  xlab(expression("Height year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)
```

```{r}
ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=lm, aes(y=Width.cm..x, x=Width.cm..y))+
  ylab(expression("Width year"[y]))+
  xlab(expression("Width year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)
```

```{r}

summary(lm(Height.cm..x ~ Height.cm..y, data=sg.xy))
summary(lm(Width.cm..x ~ Width.cm..y, data=sg.xy))

# Too many errors, use linear model to get change in size
sg.xy$ChangeH <- sg.xy$Height.cm..x-sg.xy$Height.cm..y
sg.xy$ChangeW <- sg.xy$Width.cm..x-sg.xy$Width.cm..y

mean(sg.xy$ChangeH[abs(sg.xy$ChangeH) < 3], na.rm=TRUE) #No way something lost 11cm or 21cm! that's an error
sd(sg.xy$Height.cm..x-sg.xy$Height.cm..y, na.rm=TRUE)

mean(sg.xy$Width.cm..x-sg.xy$Width.cm..y, na.rm=TRUE)
sd(sg.xy$Width.cm..x-sg.xy$Width.cm..y, na.rm=TRUE)

```

