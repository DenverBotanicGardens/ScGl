---
title: "ScGl_demography_BLM"
author: "Michelle DePrenger-Levin"
date: "Monday, October 05, 2015"
output: html_document
---

The repository is named "ScGl"   
Will need: git push ScGl master   

2015: uploaded "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Raw Data/2015 Datasheets/DataEntry2015_10.13.15.csv"
```{r}
#if I need it!
rm(list=ls())
```

```{r, echo=FALSE}
library(ggplot2)
library(plyr)
library(devtools)
#library(multcompView)
library(reshape2)
library(raster)
library(prism)
library(RCurl)
library(psych)
library(Rmisc)
require(AICcmodavg)
#Set wd for prism data if not already
options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")
library(multcompView)


#Some global variables
currentYr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))

#count pva
# x = Year, y = count
CountPVA <- function(x,y){
  
  LM.table <- c()
  
  for(yrs in 3:length(unique(x))){		# gives 2 transitions before the first Count PVA calculation
		rsq <- c(); PVA.lm <- list()
  
    y.count <- y[1:yrs] #Annual count for site
    x.years <- x[1:yrs] #Years of counts (can have missing years)
    ySpecies <- log10(y.count[-1]/y.count[-length(y.count)])
    yr <- sqrt(x.years[-1]-x.years[-length(x.years)])
    
		PVA.lm <- lm(ySpecies ~ -1 + yr)
		mu_sp <- predict(PVA.lm, level= 0.95,
		                 interval = "confidence",
		                 se.fit = T)$fit[1,]
    rsq <- c(rsq, R2 = summary(PVA.lm)$adj.r.squared)	# pull R squared values from each year interval 
    LM.table <- rbind(LM.table,data.frame(rsq,RangeStart=min(x),RangeEnd=x[yrs],t(mu_sp)))    
	}
	Year1 <- x.years[-length(x.years)]
	Year2 <- x.years[-1]
	PVA.table <-data.frame(yr,ySpecies,Year1,Year2)
  
  list(PVA = PVA.table,LM = LM.table)
}

```


Need to calculate individuals from 2008 data seperate from following due to lack of measuring hight and width. Will need to get the total tagged individuals for number alive instead of number of individuals with a heigth > 0 from 2009 on. <https://research.botanicgardens.org/admin/>      

In 2012 we switched from measuring the height and width indiviudals under 0.5 cm in width to counting them as "minis". 

2008-currentYr data  
```{r}
# 2015
#sg15 <- read.csv(path.expand("P:/hackathon/ScGl/RawData_scgl_2015_103015.csv"))
#names(sg15)

#2016
# Need to strip white space and conform to 2015 data
sg <- read.csv(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/R_code_ScGl/R_tables/RawData_scgl_", currentYr,".csv",
                     sep=""))
names(sg)

table(sg$Site,sg$Year) 

#Remove rows where Site is blank, if any
sg[which(sg$Site == ""),]
if(nrow(sg[-which(sg$Site == ""),])>0){
  sg <- sg[-which(sg$Site == ""),]
  }

# Vol calculated at pi*r^2*h
sg$Vol <- pi*((sg$Width.cm./2)^2)*sg$Height.cm.

nrow(sg[sg$Year == 2008,])
sg$Site <- factor(sg$Site)
sg[sg$Year == 2013 & sg$Site == "Atwell Gulch",]
sg$Minis[sg$Minis > 1000] <- NA

# write.table(sg, file=paste("P:/hackathon/ScGl/datasets/sg",currentYr,".csv",sep=""), sep=",")
write.table(sg, file=paste("C:/Users/deprengm/OneDrive - Denver Botanic Gardens/P drive/hackathon/ScGl/datasets/sg",currentYr,".csv",sep=""), sep=",")

```


##Summarize old and new data by number of individuals    
Need to split by Site - Atwell Gulch needs to be together:  
       `Atwell Gulch_108` and `Atwell Gulch_165` are Atwell Gulch with Ycoord < 30
       Road T-West (old) vs. T-Junction
       Oil Pad and Oil Pad (old)
       Pond and Pond (old)
     
summarize 2008  
```{r}
scgl08 <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/R_code_ScGl/R_tables/All2008.txt"),sep=",")

sg_summary08 <- ddply(scgl08,  
                    .(SiteName,Year), summarise,
                    X = sum(CountofHeight),
                    Rep = sum(SumFlowered),
                    Brs = sum(SumBrowsed),
                    avgH = NA,
                    sdH = NA,
                    avgW = NA,
                    sdW = NA,
                    avgVol = NA,
                    sdVol = NA)


sg$Fl <- as.character(sg$Fl)
sg$Br <- as.character(sg$Br)

sg$Fl[sg$Fl == "n"] <- "0"
sg$Fl[sg$Fl == "y"] <- "1"

sg$Br[sg$Br == "n"] <- "0"
sg$Br[sg$Br == "y"] <- "1"

sg$Fl <- as.numeric(sg$Fl)
sg$Br <- as.numeric(sg$Br)

table(sg$Year, sg$Site)

# Pond was not finished in 2015
# Some data was entered but should be removed from the count data and trend analyses unless it is for individuals that were measured in 2015

```

# 2019 post download raw data fixes, fixed in the SQL database   
In 2019 we used the photoNumber column to track the number of flowers per plant
```{r}
sg$Height.cm.[sg$ScGl_data_id==21981] <- 0
sg$PhotoNumber <- as.character(sg$PhotoNumber)
sg$PhotoNumber[sg$ScGl_data_id==22068] <- 2

```



#Old and New data     
Atwell Gulch old is everything with a Y less than 30    
Atwell Gulch new is everything Atwell Gulch    
Rename Sites for Atwell old and new
```{r}
# Add a level to the Site factor field
sg$Site <- factor(sg$Site, 
                  levels = c("Atwell Gulch", "Atwell Gulch (old)",levels(sg$Site)))

# Rename all Atwell Gulch
sg[grep("Atwell", sg$Site),"Site"] <- "Atwell Gulch"

# One copy of all Atwell Gulch 2012 on for new
atwell.new <- sg[intersect(grep("Atwell",sg$Site),which(sg$Year>2011)),]

atwell.old <- sg[intersect(grep("Atwell",sg$Site),which(sg$Y.coord.m.<30)),] 
atwell.old$Site <- "Atwell Gulch (old)"

```

#2016 on    
No more "Old" versions. Need to remove these data - tags that were in both versions are still reported. 
Stop Pond old in 2015
Keep Atwell old and new
Fram no data in 2015
```{r}
#Road T-East
sg <- sg[grep("Road T-East", sg$Site, invert=TRUE),]


#No "old" 2016 on
sg <- sg[-intersect(grep("old", sg$Site),which(sg$Year>2015)),]

#No Pond in 2015
sg <- sg[-intersect(grep("Pond", sg$Site), which(sg$Year==2015)),]

#Add back Atwell duplicated for old and new
sg <- rbind(sg[grep("Atwell", sg$Site, invert = TRUE),],atwell.new,atwell.old)
sg$Site <- droplevels(sg$Site)

table(sg$Site,sg$Year)

sg_withPond2015 <- sg
sg.foo <- sg[!(sg$Site %in% c("Pond","Pond (old)") & sg$Year == 2015),]
table(sg.foo$Site,sg.foo$Year)

sg <- sg.foo

```

#Data checks
```{r}
ggplot(sg[sg$Site == "Picnic Site",], aes(Transect,Height.cm.))+
  geom_point()

ggplot(sg[sg$Site == "Pond",], aes(Transect,Height.cm.))+
  geom_point()
```



2008 is a summary already, need to summarize rest before combining with 2008. 
```{r}
sg_summary <- ddply(sg[sg$Year>2008,],  
                    .(Site,Year), summarise,
                    X = length(Tag[Height.cm. > 0]),
                    Rep = sum(Fl, na.rm = TRUE),
                    Brs = sum(Br, na.rm = TRUE),
                    avgH = mean(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                    sdH = sd(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                    avgW = mean(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                    sdW = sd(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                    avgVol = mean(Vol, na.rm = TRUE),
                    sdVol = sd(Vol, na.rm = TRUE))

head(sg_summary)
table(sg_summary$Site,sg_summary$Year)
```

#Data summary
Combine 2008 (with no height or width data) and remaining years 
```{r}
names(sg_summary08) <- names(sg_summary)
sg_sum <- rbind(sg_summary08,sg_summary)
```

All sites 
```{r}
ggplot(sg_sum, aes(Year,X,colour=Site))+
  geom_point(size=3)+
  geom_line()+
  theme_classic()
```




All sites separate plots
```{r}
ggplot(sg_sum, aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  ylab("Total individuals")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

All the new ones
```{r}
ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_wrap(~Site)+
  ylab("Total individuals")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_continuous(breaks = seq(2008, currentYr, 2))
```


```{r}
ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], aes(Year,X,colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg_sum$Site[grep("old",sg_sum$Site,invert=TRUE)]))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")+
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 2))
```


All the old ones
```{r}
ggplot(sg_sum[grep("old",sg_sum$Site),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  facet_grid(~Site)+
  ylab("Total individuals")+
  theme_bw()
```

```{r}
ggplot(sg_sum[grep("old",sg_sum$Site),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```


old and new
```{r}
oldnew <- c("Oil","Pond","T-","Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")+
  theme_bw()
```


#Pond
```{r}
oldnew <- c("Pond")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") 
```

Is T-Junction missing some - should be finding more individuals
#T-Junction
```{r}
oldnew <- c("T-")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

#Oil Pad
```{r}
oldnew <- c("Oil")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

#Atwell
```{r}
oldnew <- c("Atwell")

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals")
```

Report Tables_current year
Table 2: Summary data of Sclerocactus glaucus demographic monitoring in western Colorado (2008-2015).
```{r}
#save to clipboard to excel sheet in correct format ("$" says the end of the string)
new <- c("Atwell Gulch$","Oil Pad","Pond","T-Junction")
poststand <- sg_sum[sg_sum$Year == currentYr & sg_sum$Site %in% grep(paste(new,collapse="|"),
                                                        sg_sum$Site,value=TRUE),]

sg_sum[sg_sum$Year == currentYr,]

#Reproduction
rep.per <- sg_sum
rep.per$PRep <- rep.per$Rep/rep.per$X
str(rep.per)

rep.per2 <- rep.per[rep.per$Year>2008,]

#Average percentage of reproductive individuals per site over the years
# summarySE(data=rep.per[rep.per$Year>2008,], measurevar=rep.per$PRep, groupvars="Site", na.rm=TRUE)
summaryOut <- do.call(rbind,lapply(split(rep.per2, rep.per2$Site),
       function(x){
         data.frame(Count = length(x$PRep), Avg = mean(x$PRep), Std = sd(x$PRep), 
                    SE = sd(x$PRep)/sqrt(length(x$PRep)),
                    CI = sd(x$PRep)/sqrt(length(x$PRep)) * (qt(0.95/2 + 0.5, length(x$PRep)-1)))
         }))
# rep.summarySE <- summarySE(data=rep.per, measurevar="PRep", groupvars="Site")
# rep.summarySE[with(rep.summarySE, order(PRep)),]

#Reproductive individuals with average width of plants
#See also "#Reproduction" below; should match this
summary(lm(PRep~avgW, data=rep.per))

prestand <- sg_sum[sg_sum$Year == currentYr & !sg_sum$Site %in% grep(paste(new,collapse="|"),
                                                        sg_sum$Site,value=TRUE),]

write.table(poststand, file=paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Table2_poststand.csv", sep=""), 
            sep=",", row.names=FALSE, col.names = TRUE)


write.table(prestand,  file=paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Table2_prestand.csv", sep=""), 
            sep=",", row.names=FALSE, col.names = TRUE)

```


Climate directly from PRISM   
### update only the previous year each year  
```{r, eval=FALSE}
#devtools::install_github("ropensci/prism")
library(prism)

# Set wd for prism
options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")

```


# Precip Total precipitation (rain and snow)
```{r}
#get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = 1986:currentYr)
```

#Update last year and get this year 
Delete previous year from folder first, then update
```{r}
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)
```

Pick up any that didn't download
```{r}
get_prism_monthlys(type="ppt", mon=3, keepZip = FALSE, years = 1995)
get_prism_monthlys(type="ppt", mon=5, keepZip = FALSE, years = 1988)
get_prism_monthlys(type="ppt", mon=10, keepZip = FALSE, years = 2001)
get_prism_monthlys(type="ppt", mon=11, keepZip = FALSE, years = 2004)
get_prism_monthlys(type="ppt", mon=7, keepZip = FALSE, years = 2007)
get_prism_monthlys(type="ppt", mon=12, keepZip = FALSE, years = 2009)
```


Lat longs for 10 sites   
39.1969Â°N, 108.1298Â°W Atwell    
38.8491Â°N, 108.3717Â°W Bridgeport   
38.6593Â°N, 108.3466Â°W Escalante     
39.0612Â°N, 108.3799Â°W Fram        
39.3446Â°N, 108.3102Â°W Oil Pad    
38.6701Â°N, 108.3286Â°W Picinic    
39.3606Â°N, 108.3136Â°W Pond    
38.7291Â°N, 108.1770Â°W Powerline   
39.3069Â°N, 108.2755Â°W Pyramid Rock   
39.3544Â°N, 108.3286Â°W T-Junciton   
```{r}
latlong <- data.frame(rbind(c(39.1969, -108.1298, "Atwell Gulch"),
#                            c(39.1969, -108.1298, "Atwell Gulch (old)"),
                            c(38.8491, -108.3717, "Bridgeport"),   
                            c(38.6593, -108.3466, "Escalante Canyon"),
                            c(39.0612, -108.3799, "Fram"),
                            c(39.3446, -108.3102, "Oil Pad"),
#                            c(39.3446, -108.3102, "Oil Pad (old)"),
                            c(38.6701, -108.3286, "Picnic Site"),
                            c(39.3606, -108.3136, "Pond"),
#                            c(39.3606, -108.3136, "Pond (old)"),
                            c(38.7291, -108.1770, "Powerline"),
                            c(39.3069, -108.2755, "Pyramid Rock"),
                            c(39.3544, -108.3286, "T-Junciton")))
#,
#                            c(39.3544, -108.3286, "Road T-West (old)")))   
names(latlong) <- c("Lat","Long","Site")
latlong[,1:2] <- sapply(latlong[,1:2], function(x) as.numeric(as.character(x)))
```

# Go into folder "Q:\Research\All_Projects_by_Species\Sclerocactus SPECIES\Sclerocactus_glaucus\ScGl_climate\PRISM_ppt_provisional_4kmM3_201601_bil" and delete the provisional ones from last year    

Max temp   
16 years 2000:currentYr
Min temp   
16 years 2000:currentYr
```{r}
ppt <- grep("ppt", ls_prism_data(absPath = TRUE)[,2])
#ppt2 <- grep(paste("ppt_stable",paste("ppt_provisional_4kmM3_",currentYr,sep=""),collapse="|"),ls_prism_data(absPath = TRUE)[,2])

m.ppt <- lapply(ppt, function(x){
  rastertemps <- raster(ls_prism_data(absPath = TRUE)[x,2])
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]), 
             date = ls_prism_data()[x,], Site = latlong$Site)
})

tmax <- grep("tmax", ls_prism_data(absPath = TRUE)[,2])

m.tmax <- lapply(tmax, function(x){
  rastertemps <- raster(ls_prism_data(absPath = TRUE)[x,2])
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]), 
             date = ls_prism_data()[x,], Site = latlong$Site)
})

tmin <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])

m.tmin <- lapply(tmin, function(x){
  rastertemps <- raster(ls_prism_data(absPath = TRUE)[x,2])
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]), 
             date = ls_prism_data()[x,], Site = latlong$Site)
})
```

PRISM_ppt_stable_4kmM3_201512_bil

# Combine climate data from library(prism)   

Strip off the last bit after the last underscore    

     scgl.temps$date <- sapply(scgl.temps$date, function(x){
       unlist(strsplit(x, "_\\s*(?=[^_]+$)", perl=TRUE))[[1]]
       })  
       
```{r}
scgl.climate <- rbind(do.call(rbind, m.tmin), 
                    do.call(rbind, m.tmax),
                    do.call(rbind, m.ppt))
#turn factors into characters
scgl.climate$date <- sapply(scgl.climate$date, as.character)

scgl.climate$Year <- sapply(scgl.climate$date, function(x){
  substr(x, (nchar(x)+1)-10,nchar(x)-6)
})
scgl.climate$Month <- sapply(scgl.climate$date, function(x){
  substr(x, (nchar(x)+1)-6,nchar(x)-4)
})

#Character to numeric
scgl.climate[,4:5] <- sapply(scgl.climate[,4:5], as.numeric)

scgl.climate$Prev12 <- scgl.climate$Year 
scgl.climate$Prev12[scgl.climate$Month > 5] <- scgl.climate$Year[scgl.climate$Month>5]+1

#extract the climate variable name from the prism long name
scgl.climate$date <- as.character(scgl.climate$date)
scgl.climate$Variable <- sapply(scgl.climate$date, function(x) {
  unlist(strsplit(x, split="_", fixed=TRUE))[[2]]
  })

str(scgl.climate)

#long to wide
melt.scgl <- melt(scgl.climate[,-2], id = c("Site","Prev12","Month","Year","Variable"))
head(melt.scgl)
table(melt.scgl$Variable) # variable is just 'data'

sp.melt.scgl <- split(melt.scgl, melt.scgl$Variable)

head(sp.melt.scgl[[2]])

scgl.c.1 <- merge(sp.melt.scgl[[1]],sp.melt.scgl[[2]], by = c("Site","Prev12","Month","Year"))
scgl.c.1 <- scgl.c.1[,c("Site","Prev12","Month","Year","value.x","value.y")]
names(scgl.c.1) <- c("Site","Prev12","Month","Year","ppt","tmax")

scgl.c.2 <- merge(scgl.c.1,sp.melt.scgl[[3]], by = c("Site","Prev12","Month","Year"))
head(scgl.c.2)
scgl.c <- scgl.c.2[,c("Site","Prev12","Month","Year","ppt","tmax","value")]
names(scgl.c) <- c("Site","Prev12","Month","Year","ppt","tmax","tmin")

scgl.c$season <- "winter"
scgl.c[scgl.c$Month>5 & scgl.c$Month<9, "season"] <- "summer"
scgl.c[scgl.c$Month>8 & scgl.c$Month<12, "season"] <- "fall"
scgl.c[scgl.c$Month>2 & scgl.c$Month<6, "season"] <- "spring"

table(scgl.c$Year)
scgl.c[scgl.c$Year>2016,]
table(scgl.c$Year,scgl.c$Month)
```

          Site Precip  tmin tmax Year Month Prev12 season
1 Atwell Gulch  54.37 -10.1  2.0 1895     1   1895 winter
2 Atwell Gulch  26.50 -10.0  4.0 1895     2   1895 winter
3 Atwell Gulch  23.35  -4.1 11.1 1895     3   1895 spring
4 Atwell Gulch  12.97   0.5 19.3 1895     4   1895 spring
5 Atwell Gulch  31.98   4.9 23.5 1895     5   1895 spring
6 Atwell Gulch  19.17   7.4 26.8 1895     6   1896 summer
> names(scgl.c)
[1] "Site"   "Precip" "tmin"   "tmax"   "Year"   "Month"  "Prev12" "season"

```{r}
ggplot(melt.scgl[melt.scgl$Month==5,], aes(Year,value,colour=Variable))+
  geom_point()+
  stat_smooth()


```




scgl.c <- scgl.climate[,c(1,3,5,7:9)]
names(scgl.c) <- c("Site","Precip","tmin","tmax","Year","Month")

####Summarize climate data
Climate of the previous 12 month to the May data collection

###PCA for climate factors
calculate seasonal climate averages    
summer: June-August (6-8)
fall: September-November (9-11)
winter: December-February (12, 1-2)
spring: March-May (3-5)
```{r}
scgl.c.summary <- aggregate(scgl.c[,c("ppt","tmax","tmin")],
                            scgl.c[,c("Site","Prev12","season")],
                            FUN = function(x) mean(x, na.rm = TRUE))

scgl.c.summary.ppt <- aggregate(scgl.c[,"ppt"],
                            scgl.c[,c("Site","Prev12","season")],
                            FUN = function(x) sum(x, na.rm = TRUE))

# scgl.c.summary <- merge(scgl.c.summary, scgl.c.summary.ppt, by = c("Site","Prev12","season"))
# names(scgl.c.summary) <- c(names(scgl.c.summary)[-length(scgl.c.summary)],"sum.ppt")

season <- reshape(scgl.c.summary[scgl.c.summary$Prev12<currentYr+1,],
                  idvar = c("Site","Prev12"),
                  timevar = "season",
                  direction = "wide")
```


summary statistics
```{r}
scgl_sumSE <- lapply(names(scgl.c[,c("ppt","tmin", "tmax")]), 
                     function(x){
                       summarySE(scgl.c, measurevar=x, groupvars=c("Site","Prev12"))
                       }) 

# t.test for min and max temp is below, search PCA summary t.tests
# to get total annyal precipitation instead of average by month, might not be fully wet year. 
scgl_totalannualppt <- aggregate(scgl.c[,"ppt"],
                                 scgl.c[,c("Site","Prev12")],
                                 FUN = function(x) sum(x, na.rm = TRUE))

# annual total (summed) ppt and t.test between northern and southern sites
scgl_totalannualppt_SE <- summarySE(scgl_totalannualppt,measurevar = "x",
                                    groupvars = c("Site"))

scgl_totalannualppt_SE$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_totalannualppt_SE$NS[scgl_totalannualppt_SE$Site %in%
                            unique(grep(paste(southsites,collapse="|"),
                                     scgl_totalannualppt_SE$Site,
                                     value=TRUE))] <- "South"
scgl_totalannualppt$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_totalannualppt$NS[scgl_totalannualppt$Site %in%
                            unique(grep(paste(southsites,collapse="|"),
                                     scgl_totalannualppt$Site,
                                     value=TRUE))] <- "South"

# t.test for north compared to south
# t.test(x~NS, data = scgl_totalannualppt[scgl_totalannualppt$Prev12>1999,]) # don't know why I had 2000 before
t.test(x~NS, data = scgl_totalannualppt)

scgl_sumSE[[1]]$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_sumSE[[1]]$NS[scgl_sumSE[[1]]$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     scgl_sumSE[[1]]$Site,
                                     value=TRUE))] <- "South"

scgl_sumSE[[2]]$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_sumSE[[2]]$NS[scgl_sumSE[[2]]$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     scgl_sumSE[[2]]$Site,
                                     value=TRUE))] <- "South"

scgl_sumSE[[3]]$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
scgl_sumSE[[3]]$NS[scgl_sumSE[[3]]$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     scgl_sumSE[[3]]$Site,
                                     value=TRUE))] <- "South"

```

Precipitation per site
```{r}
ggplot(scgl_sumSE[[1]][scgl_sumSE[[1]]$Prev12>2000&
                         scgl_sumSE[[1]]$Prev12<currentYr,],
       aes(Prev12, ppt, colour=Site))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=ppt-se, ymax=ppt+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average precipitation per site") 

```
Precipitation North vs. South  
swtich to total instead of monthly average?
```{r}
ggplot(scgl_sumSE[[1]][scgl_sumSE[[1]]$Prev12>2000&
                         scgl_sumSE[[1]]$Prev12<currentYr,],
       aes(Prev12, ppt, colour=NS, group=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=ppt-se, ymax=ppt+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average precipitation per site") 

t.test(ppt~NS, data = scgl_sumSE[[1]])
```

Minimum temperature per site (Celcius)
```{r}
ggplot(scgl_sumSE[[2]][scgl_sumSE[[2]]$Prev12>2000&
                         scgl_sumSE[[2]]$Prev12<currentYr+1,],
       aes(Prev12, tmin, colour=NS, group=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmin-se, ymax=tmin+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average monthly minimum temperature") 

```

```{r}
ggplot(scgl_sumSE[[2]][scgl_sumSE[[2]]$Prev12>2000&
                         scgl_sumSE[[2]]$Prev12<currentYr+1,],
       aes(Prev12, tmin, colour=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmin-se, ymax=tmin+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average minimum temperature per site") 

```

Maximum temperature per site (C)
```{r}
ggplot(scgl_sumSE[[3]][scgl_sumSE[[3]]$Prev12>2000&
                         scgl_sumSE[[3]]$Prev12<currentYr+1,],
       aes(Prev12, tmax, colour=Site))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmax-se, ymax=tmax+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average maximum temperature per site") 

```

# PCA summary t.tests
```{r}
ggplot(scgl_sumSE[[3]][scgl_sumSE[[3]]$Prev12>=2000&
                         scgl_sumSE[[3]]$Prev12<currentYr+1,],
       aes(Prev12, tmax, colour=NS))+
  geom_point(position=position_dodge(0.1), shape=21, fill="white") +
  stat_summary(fun.y = function(x) mean(x, na.rm = TRUE), geom="line") +
  geom_errorbar(aes(ymin=tmax-se, ymax=tmax+se),width=1, position = position_dodge(0.1)) +
  theme_bw() +
  ylab("Average maximum temperature per site") 

t.test(tmax~NS, data= scgl_sumSE[[3]])
t.test(tmin~NS, data= scgl_sumSE[[2]])
# t.test(ppt~NS, data= scgl_sumSE[[1]])
```

Take out missing data, Years 1986 through current year as previous 12 years to the May survey

```{r}
nrow(season) #320
cc.season <- season[complete.cases(season),]
nrow(cc.season) #310♦
unique(sort(cc.season$Prev12)) #1986:current year

cor.plot(cor(cc.season[,-c(1:2,grep("Year", names(cc.season)),
                        grep("Month", names(cc.season)))]), numbers = TRUE)
```

Ditch anything 50% or more correlated of the pair that explains less variation, get r^2 values
## PCA for 1986 through current year
```{r}

#mlogit(Site~1|ppt.fall+tmax.fall+tmin.fall, cc.season)

rsqs <- do.call(rbind,lapply(3:length(cc.season), function(x){
  lm <- summary(lm(cc.season$Prev12~cc.season[,x]))
  data.frame(var=names(cc.season[x]),r2=lm$adj.r.squared)
}))


#keep the one with bigger r2 from var1 and var2 when Freq is > 50% 
cor.level <- .5 

cor.table86.current<-cor(cc.season[,-c(1:2)])
data86.current <- as.data.frame(as.table(cor.table86.current))
colexclude <- c(1:2)


#New way to find the variable that has the better r2 between the two correlated varaiables
data86.currentrsqs1 <- merge(rsqs,data86.current, by.x = "var", by.y = "Var1")
names(data86.currentrsqs1) <- c("var_Var1", "r2", "Var2","PCorr")
data86.currentrsqs2 <- merge(rsqs, data86.currentrsqs1, by.x = "var", by.y = "Var2")
apply(data86.currentrsqs2, 1, function(x) x[1])

keepvars <- apply(data86.currentrsqs2, 1, function(x){
  if(abs(as.numeric(x[5]))>cor.level & as.numeric(x[5])<1){
    if(as.numeric(x[2])>as.numeric(x[4])){
      out <- x[1]   # The first variable that would have a higher r square value
    } else {
      out <- x[3]   # The second varaiable that would have the higher r sq
    }
    out
  }
})

tokeep <- unique(do.call(rbind,keepvars[!unlist(lapply(keepvars, is.null))]))
colexclude <- which(!names(cc.season) %in% tokeep)

# Climatic variables used in PCA 1986-current year
names(cc.season[,-colexclude])

forpca86.current <- cc.season[,-colexclude]

scgl.pca86current <- princomp(forpca86.current,cor=TRUE)
summary(scgl.pca86current)
scgl.load86current <- loadings(scgl.pca86current)
write.table(scgl.load86current, "clipboard", sep="\t", row.names=TRUE)
scgl.pc86current <- predict(scgl.pca86current)

sg.pc86current <- data.frame(scgl.pc86current,cc.season)
# Assign genetic regions
sg.pc86current$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.pc86current$NS[sg.pc86current$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     sg.pc86current$Site,
                                     value=TRUE))] <- "South"
```

#Table 3a)    
```{r}

Table3acor <-cor(cc.season[,-c(1:2)])
Table3a <- as.data.frame(as.table(Table3acor))

Table3a <- Table3a[abs(Table3a$Freq)>cor.level&Table3a$Freq<1,]

# To get rid of duplicated correlations
write.table(Table3a[!duplicated(Table3a$Freq),], file=paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Table3a.csv", sep=""), 
            sep=",", row.names=FALSE, col.names = TRUE)
# write.table(Table3a[with(Table3a, order(Table3a$Freq)),], "clipboard", sep="\t", row.names = FALSE)


```

Site differences
#Figure 4b  
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig4b.jpg", sep=""), width=175, height=125, units="mm", res=300)


ggplot(sg.pc86current, aes(Comp.1,Comp.2, colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg.pc86current$Site))+
  geom_point() +
  stat_ellipse() +
  theme_bw()

dev.off()
```

North/South differences
#Figure 4a
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig4a.jpg", sep=""), width=125, height=125, units="mm", res=300)


ggplot(sg.pc86current, aes(Comp.1,Comp.2, colour=NS, shape=NS))+
  geom_point() +
  stat_ellipse() +
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))+
  guides(shape=guide_legend(title="Genetic region")) +
  theme(legend.position="bottom")

dev.off()
```

#Figure 4c
Use all years of data for all plots comparison?
The letters won't line up with the sites unless specified
```{r}
#doesn't like "-" in the name
levels(sg.pc86current$Site) <- c(as.character(unique(sg.pc86current$Site))[-10], "TJunction")
sg.thsd <- TukeyHSD(aov(Comp.1~Site, data=sg.pc86current))

lasign <- multcompLetters(extract_p(sg.thsd$Site))
tomerge <- lasign$Letters
names(tomerge) <- c(names(tomerge)[1:8],"T-Junction",names(tomerge)[10])


SiteLetters <- data.frame(Letter = lasign$Letters,
                          Site = names(tomerge))
SiteLetters<-SiteLetters[with(SiteLetters, order(Site)),]

match(levels(sg.pc86current$Site),
levels(SiteLetters$Site))

jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig4c.jpg", sep=""), width=275, height=125, units="mm", res=300)



ggplot(sg.pc86current, aes(Site, Comp.1, colour=NS))+
  stat_boxplot(geom='errorbar')+
  geom_boxplot()+
  annotate("text",x=1:10, y = 5,
           label = SiteLetters$Letter)+
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))
# +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))

dev.off()

# 1986 to current year t.test
t.test(Comp.1~NS, data=sg.pc86current)

```

#### Figure 4: The Principal Components Analysis (PCA) of climatic variables with loadings  by a) genetic region and b) site. c) Site distribution along PC1 is shown with Tukey Honest Significant Differences. 
sg.pc86current is 1986 to current year
```{r}

ggplot(sg.pc86current, aes(Comp.1,Comp.2, colour=NS))+
  geom_point() +
  stat_ellipse() +
  theme_bw() +
  theme(legend.justification=c(0,1), legend.position=c(0,1))

t.test(Comp.1~NS, data=sg.pc86current)
```

Results of first PCA  
```{r}
ggplot(sg.pc86current, aes(tmax.fall, tmax.spring, colour = NS))+
  geom_point()+
  stat_ellipse()

ggplot(sg.pc86current, aes(ppt.spring, ppt.fall, colour=NS))+
  geom_point()+
  stat_ellipse()
```



# PCA 2008-currentYr
Try for only the study period 
Prev12 is the May of the previous year through the April of the current year
#### 2008-currentYr
Ditch anything 50% or more correlated 

```{r}

recent08current <- cc.season[cc.season$Prev12 > 2007 & cc.season$Prev12 < currentYr+1,]
rsqs08 <- do.call(rbind,lapply(3:length(recent08current), function(x){
  lm <- summary(lm(recent08current$Prev12~recent08current[,x]))
  data.frame(var=names(recent08current)[x],r2=lm$adj.r.squared)
}))

cor.table.r<-cor(recent08current[,-c(1:2)])
data.r <- as.data.frame(as.table(cor.table.r))

#New way to find the variable that has the better r2 between the two correlated varaiables
data.rrsqs1 <- merge(rsqs08,data.r, by.x = "var", by.y = "Var1")
names(data.rrsqs1) <- c("var_Var1", "r2", "Var2","PCorr")
data.rrsqs2 <- merge(rsqs08, data.rrsqs1, by.x = "var", by.y = "Var2")
apply(data.rrsqs2, 1, function(x) x[1])
keepvars08 <- apply(data.rrsqs2, 1, function(x){
  if(abs(as.numeric(x[5]))>cor.level & as.numeric(x[5])<1){
    if(as.numeric(x[2])>as.numeric(x[4])){
      out <- x[1]   # The first variable that would have a higher r square value
    } else {
      out <- x[3]   # The second varaiable that would have the higher r sq
    }
    out
  }
})
tokeep08 <- unique(do.call(rbind,keepvars[!unlist(lapply(keepvars, is.null))]))

colexclude08 <- which(!names(recent08current) %in% tokeep08)

#Variables kept for 2007 May - current year
unique(names(recent08current[,-colexclude08]))

scgl.pca.r <- princomp(recent08current[,-colexclude08],cor=TRUE)
summary(scgl.pca.r)
scgl.load.r <- loadings(scgl.pca.r)
write.table(scgl.load.r, "clipboard", sep="\t", row.names=TRUE)

scgl.pc.r <- predict(scgl.pca.r)

sg.pc.r <- data.frame(scgl.pc.r,recent08current)
# Assign genetic regions
sg.pc.r$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.pc.r$NS[sg.pc.r$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     sg.pc.r$Site,
                                     value=TRUE))] <- "South"

```

# Table 3b) 2008 - current year
```{r}
Table3bcor <- cor(recent08current[,-c(1:2)])
Table3b <- as.data.frame(as.table(Table3bcor))

Table3b <- Table3b[abs(Table3b$Freq)>cor.level&Table3b$Freq<1,]
Table3b <- Table3b[with(Table3b, order(Table3b$Freq)),]
write.table(Table3b[!duplicated(Table3b$Freq),], file = paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Table3b.csv", sep=""), 
            sep=",", row.names=FALSE, col.names = TRUE)

```

In case of "Error in .Call.graphics(C_palette2, .Call..."  
use dev.off()
Figure 4

```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig4e.jpg", sep=""), width=175, height=125, units="mm", res=300)

ggplot(sg.pc.r, aes(Comp.1,Comp.2, colour=Site, shape=Site))+
  scale_shape_manual(values=1:nlevels(sg_sum$Site[grep("old",sg_sum$Site,invert=TRUE)]))+
  geom_point() +
  stat_ellipse() +
  theme_bw()

dev.off()


jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig4d.jpg", sep=""), width=175, height=125, units="mm", res=300)

ggplot(sg.pc.r, aes(Comp.1,Comp.2, colour=NS, shape=NS))+
  geom_point() +
  stat_ellipse() +
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))+
  guides(shape=guide_legend(title="Genetic region")) 

dev.off()


#T-test for the 2008 to current year time
t.test(Comp.1~NS, data=sg.pc.r)
t.test(Comp.2~NS, data=sg.pc.r)


```


Figure 4 f) Site distribution along PC1 is shown with Tukey Honest Significant Differences. 

```{r}
#doesn't like "-" in the name
levels(sg.pc.r$Site) <- c(as.character(unique(sg.pc.r$Site))[-(10)],"TJunction")


#Comp.2
sg.thsd2 <- TukeyHSD(aov(Comp.2~Site, data=sg.pc.r))
lasign2 <- multcompLetters(extract_p(sg.thsd2$Site))
tomerge2 <- lasign2$Letters
names(tomerge2) <- c(names(tomerge2)[1:8],"T-Junction",names(tomerge2)[10])


SiteLetters2 <- data.frame(Letter = lasign2$Letters,
                          Site = names(tomerge2))
Siteletters2 <- SiteLetters2[order(SiteLetters2$Site),]

ggplot(sg.pc.r, aes(Site, Comp.2, colour=NS))+
  stat_boxplot(geom='errorbar')+
  geom_boxplot()+
  annotate("text",x=1:10, y = 4,
           label = SiteLetters2$Letter)+
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))



#Comp.1
sg.thsd1 <- TukeyHSD(aov(Comp.1~Site, data=sg.pc.r))
lasign1 <- multcompLetters(extract_p(sg.thsd1$Site))

tomerge1 <- lasign1$Letters
names(tomerge1) <- c(names(tomerge1)[1:8],"T-Junction",names(tomerge1)[10])

SiteLetters1 <- data.frame(Letter = lasign1$Letters,
                          Site = names(tomerge1))
SiteLetters1 <- SiteLetters1[order(SiteLetters1$Site),]

levels(sg.pc.r$Site)
levels(SiteLetters1$Site)

jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig4f.jpg", sep=""), width=275, height=125, units="mm", res=300)


ggplot(sg.pc.r, aes(Site, Comp.1, colour=NS))+
  stat_boxplot(geom='errorbar')+
  geom_boxplot()+
  annotate("text",x=1:10, y = 4,
           label = SiteLetters1$Letter)+
  theme_bw()+
  guides(colour=guide_legend(title="Genetic region"))
# +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

dev.off()
```

#### Figure 2: a) Number of Sclerocactus glaucus individuals per square meter in the northern genetic region (North) and the southern genetic region (South), and b) Average size of individuals per site. 

```{r}
sg_sum[sg_sum$Site == "",]
sg_sum <- sg_sum[sg_sum$Site != "",]
#reset levels to not include blank
sg_sum$Site <- factor(sg_sum$Site)

# total area from table 2

unique(sg_sum$Site)
sg_sum$area[sg_sum$Site == "Escalante Canyon"] <- 180
sg_sum$area[sg_sum$Site == "Bridgeport"] <- 400
sg_sum$area[sg_sum$Site == "Atwell Gulch"] <- 390
sg_sum$area[sg_sum$Site == "Atwell Gulch (old)"] <- 300
sg_sum$area[sg_sum$Site == "Fram"] <- 1300
sg_sum$area[sg_sum$Site == "Oil Pad (old)"] <- 672
sg_sum$area[sg_sum$Site == "Oil Pad"] <- 120
sg_sum$area[sg_sum$Site == "Picnic Site"] <- 160
sg_sum$area[sg_sum$Site == "Pond"] <- 36
sg_sum$area[sg_sum$Site == "Pond (old)"] <- 235.6
sg_sum$area[sg_sum$Site == "Powerline"] <- 40
sg_sum$area[sg_sum$Site == "Pyramid Rock"] <- 100
sg_sum$area[sg_sum$Site == "Road T-West (old)"] <- 2212
sg_sum$area[sg_sum$Site == "T-Junction"] <- 130

sg_sum$SiteSame <- sg_sum$Site
sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("Atwell",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "Atwell Gulch"

sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("Pond",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "Pond"

sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("Oil",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "Oil Pad"

sg_sum$SiteSame[sg_sum$Site %in% unique(grep(paste("T-",collapse="|"),
                                        sg_sum$Site,
                                        value=TRUE))] <- "T-Junction"

table(sg_sum$Site,sg_sum$SiteSame)

# Assign genetic regions
sg_sum$NS <- "North"
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg_sum$NS[sg_sum$Site %in% unique(grep(paste(southsites,collapse="|"),
                                     sg_sum$Site,
                                     value=TRUE))] <- "South"

require(scales)

unique(sg_sum$Site)

sg_sum1 <- sg_sum
sg_sum1$X[which("Pond" == sg_sum1$Site)] <- sg_sum1$X[which("Pond" == sg_sum1$Site)]/2

# Reproduction section
updatedsites <- c("Atwell Gulch", "T-Junction", "Pond", "Oil Pad")

matchingsites <- data.frame(table(sg_sum$Site,sg_sum$SiteSame))
matchingsites[matchingsites$Freq>0,] # Number of years with data on that site. 

# Site summary with percent reproductive
sg_spr <-sg_sum
sg_spr$PercentReprod <- sg_spr$Rep/sg_spr$X

diffs <- lapply(split(sg_spr[sg_spr$SiteSame %in% updatedsites,], sg_spr$SiteSame[sg_spr$SiteSame %in% updatedsites]), function(x){
  Sites <- unique(x$Site)
  if(length(Sites==2)){
    diffout <- lapply(2012:2015, function(y){
      x$PercentReprod[x$Site==Sites[1]&x$Year==y]-x$PercentReprod[x$Site==Sites[2]&x$Year==y]
      })
    diffout
    }
  })

 mean(unlist(diffs$`Atwell Gulch`))
 sd(unlist(diffs$`Atwell Gulch`))
 
 mean(unlist(diffs$`T-Junction`))
 sd(unlist(diffs$`T-Junction`))
 
 mean(unlist(diffs$Pond))
 sd(unlist(diffs$Pond))
 
 mean(unlist(diffs$`Oil Pad`))
 sd(unlist(diffs$`Oil Pad`))
 
 
PercentReproOverStudy <- do.call(rbind,lapply(split(sg_spr, sg_spr$Site), function(x){
  out <- data.frame(Site = unique(x$SiteSame), Avg = mean(x$PercentReprod), SD = sd(x$PercentReprod),
                    MinYr = min(x$Year), MaxYr = max(x$Year))
}))

PercentReproOverStudy[order(PercentReproOverStudy$Avg),]
```


#Reproduction   
Follow AsMi to look at probability of being reproductive as a function of width or height or both
```{r}
mean(sg_sum$Rep[sg_sum$Year==currentYr &
                  sg_sum$Site %in% unique(grep("old",sg_sum$Site,
                                        invert=TRUE, value=TRUE))]/sg_sum$X[sg_sum$Year==currentYr&
                  sg_sum$Site %in% unique(grep("old",sg_sum$Site,
                                        invert=TRUE, value=TRUE))])

#AVerage and SD over all years (not 'old')
mean(sg_sum$Rep[sg_sum$Site %in% unique(grep("old",sg_sum$Site,
          invert=TRUE, value=TRUE))]/sg_sum$X[sg_sum$Site %in% 
          unique(grep("old",sg_sum$Site,invert=TRUE, value=TRUE))])
sd(sg_sum$Rep[sg_sum$Site %in% unique(grep("old",sg_sum$Site,
          invert=TRUE, value=TRUE))]/sg_sum$X[sg_sum$Site %in% 
          unique(grep("old",sg_sum$Site,invert=TRUE, value=TRUE))])

#Percent Reproductive in current year (but don't repeat Atwell Gulch ones)
sum(sg_sum$Rep[sg_sum$Year==currentYr & 
                 sg_sum$Site !="Atwell Gulch (old)"])/sum(sg_sum$X[sg_sum$Year==currentYr & 
                 sg_sum$Site !="Atwell Gulch (old)"])

#average volume, height, and width explains reproductive status
sg_sum$Prepro <- sg_sum$Rep/sg_sum$X
summary(lm(Prepro~(avgH+avgW)^2, data=sg_sum))

summary(lm(Prepro~avgW, data=sg_sum))

ggplot(sg_sum, aes(avgW,Prepro))+
  geom_point()+
  stat_smooth()
```


```{r}


ggplot(sg_sum[grep("old",sg_sum$Site,invert=TRUE),], 
       aes(Year, Prepro, group = Site, colour = Site)) +
  geom_point()+
  geom_line()+
  ylab("Percent reproductive") +
  facet_wrap(~NS+Site,ncol = 5) +
  theme_bw()
```

Largest proportion of reproductive individuals over all years
```{r}
sg_sum[sg_sum$Site=="Pond",]

summarySEreproductive <- summarySE(sg_sum, measurevar = "Prepro", groupvars=c("Site"))

summarySEreproductive[with(summarySEreproductive, order(Prepro)),]


#Is percent reproductive explained by width, height, or both: volume?
summary(lm(Prepro~(avgW+avgVol)^2, data=sg_sum))

# Which is the better predictor of percent reproductive
summary(lm(Prepro~avgVol, data=sg_sum))
summary(lm(Prepro~avgW, data=sg_sum))
summary(lm(Prepro~avgH, data=sg_sum))


lm1 <- lm(Prepro~avgVol, sg_sum)
lm2 <- lm(Prepro~avgW, sg_sum)
lm3 <- lm(Prepro~avgH, sg_sum) 

lm.list <- list(lm1,lm2, lm3)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

```


#### Table 3: Correlations stronger than 0.5 between environmental variables at all sites for the months preceding yearly May monitoring of Sclerocactus glaucus. 

```{r}

as.data.frame(as.table(cor(recent08current[,-c(1:2,grep("Year", names(recent08current)),
                        grep("Month", names(recent08current)))])))


cor.table<-cor(recent08current[,-c(1:2,grep("Year", names(recent08current)),
                        grep("Month", names(recent08current)))])
data <- as.data.frame(as.table(cor.table))
combins <- combn(colnames(cor.table),2,FUN = function(x) {paste(x,collapse="_")})
cor.data <- data[data$Var1 != data$Var2,]
data <- cor.data[paste(cor.data$Var1, cor.data$Var2, sep="_") %in% combins,]
```


Figure 3a Number of sclerocactus glaucus
```{r Figure  remove pond}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig3a.jpg", sep=""), width=250, height=125, units="mm", res=300)


ggplot(sg_sum,aes(Year, X/area, colour = Site)) +
  geom_line() +
  geom_point() +
  ggtitle("a)")+
  facet_wrap(~NS + SiteSame, ncol = 5) +
  ylab("Individuals per square meter") +
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))

dev.off()

```


### Figure 3b
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig3b.jpg", sep=""), width=250, height=125, units="mm", res=300)


ggplot(sg_sum,aes(Year,avgVol,colour=Site))+
  geom_line()+
  geom_point()+
  ggtitle("b)")+
  facet_wrap(~NS + SiteSame, ncol =5)+
  ylab("Average volume")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()

dev.off()
```


Figure 3c
```{r}
#Minis

minis <- aggregate(sg$Minis, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(minis) <- c("Site","Year","Minis")

repro <- aggregate(sg$Fl, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(repro) <- c("Site","Year","Reproductive")
minis.p.repro <- merge(minis,repro, by = c("Site","Year"))
minis.p.repro$PerM <- minis.p.repro$Minis/minis.p.repro$Reproductive

sg[sg$Minis>20 & !is.na(sg$Minis),]

#Minis per reproductive plant
ggplot(minis.p.repro, aes(Year, PerM))+
  geom_line()+
  facet_wrap(~Site)

sgminis <- merge(sg_sum, minis, by = c("Site","Year"))

#want average minis per adult plant per site per year

ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = Site, group = Year))+
  geom_boxplot()+
  facet_wrap(~Site)

ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = Site))+
  geom_point()+
  facet_wrap(~Site)

#Some die, some grow into big ones. 
ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = as.factor(Tag)))+
  geom_line()+
  facet_wrap(~Site)+
  theme(legend.position = "none")
```

##FIGURE 3c
```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig3c.jpg", sep=""), width=250, height=125, units="mm", res=300)

ggplot(sgminis, aes(Year, Minis,colour= Site))+
  geom_line()+
  geom_point()+
  ggtitle("c)")+
  facet_wrap(~NS + SiteSame, ncol =5)+
  ylab("Total seedlings (< 0.5cm width)")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()

  
dev.off()
```

```{r}

summary(lm(X/area ~ avgVol*Minis, data=sgminis))

ggplot(sgminis, aes(Minis, X/area))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(sgminis, aes(Minis, Rep))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(sgminis, aes(Minis/Rep, X/area))+
  geom_point()+
  stat_smooth(method="lm")
```



```{r}
par(cex=0.8)  
interaction.plot(sg_sum$Year, factor(sg_sum$Site), 
	as.numeric(sg_sum$X),
	ylab= expression(paste(italic("Sclerocactus glaucus")," individuals per sampling unit")), xlab="Year", 
	trace.label="Site",
	col=c(1:6,11,8:(nlevels(sg_sum$Site))))

```


####Figure 6: The plot design for four ScGl sites were changed in 2012...   
```{r}
# old and new
oldnew <- c("Oil","Pond","T-","Atwell")

jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig6.jpg", sep=""), width=250, height=125, units="mm", res=300)


ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") +
  facet_wrap(~SiteSame)+
  theme_bw()+
  scale_x_continuous(breaks = seq(2009, currentYr, 1))

dev.off()

```


### statistics
#PVA count based

```{r}
all.count <- lapply(unique(sg_sum$Site), function(x){
  CountPVA(sg_sum$Year[sg_sum$Site == x],sg_sum$X[sg_sum$Site == x])
  })

names(all.count) <- unique(sg_sum$Site)

```


#how do climatic variables explain growth rates?   
```{r}
lambdas <- do.call(rbind, lapply(all.count, '[[', 1))
lambdas$Site <- sub("\\.[0-9]","",row.names(lambdas)) #get rid of numbers following .

head(lambdas)
head(sg.pc86current)

# merge the growth rate of the climatic factors of year 2 (so the climate shaping the change from Year 1 to year 2, not before year 1)
sg.pc.lambda <- merge(sg.pc86current, lambdas, by.x = c("Site","Prev12"), by.y = c("Site","Year2"))


ggplot(sg.pc.lambda, aes(tmax.spring, ySpecies))+
  geom_point()+
  stat_smooth(method="lm")



ggplot(sg.pc.lambda, aes(tmax.spring, ySpecies))+
  geom_point()+
  stat_smooth(method="lm")
```


#Should come back and test the different 3 hightest PCA loading variables
```{r}

lm1 <- lm(ySpecies ~ Prev12, sg.pc.lambda)
lm2 <- lm(ySpecies ~ ppt.winter, sg.pc.lambda)
lm3 <- lm(ySpecies ~ NS, sg.pc.lambda) 
lm4 <- lm(ySpecies ~ tmin.winter*ppt.winter, sg.pc.lambda)
lm5 <- lm(ySpecies ~ (ppt.spring+tmax.spring+tmin.winter+ppt.winter+NS)^2, sg.pc.lambda)
lm6 <- lm(ySpecies ~ (tmin.winter+ppt.winter+tmax.summer+ppt.summer+NS)^2, sg.pc.lambda)
lm7 <- lm(ySpecies ~ (tmin.summer+ppt.summer+NS)^2, sg.pc.lambda)
lm9 <- lm(ySpecies ~ (tmin.winter+NS)^2, sg.pc.lambda)
lm8 <- lm(ySpecies ~ ppt.summer, sg.pc.lambda)


lm.list <- list(lm1,lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}


```


#### Demography   

```{r}

Fit.list <- lapply(all.count, '[[', 2) 

last.fit <- do.call(rbind,lapply(Fit.list, function(x){
  out <- exp(x[nrow(x),-c(1:3)])
  years <- x[nrow(x), 1:3]
  data.frame(years,out)
}))


fit.currentYr <- data.frame(Site = rownames(last.fit), last.fit)
plot.currentYr <- melt(fit.currentYr,
                  id.vars = "Site",
                  measure.vars = c("fit","upr","lwr","rsq"))

```

#Demography
#Lambdas by site
```{r}
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
plot.currentYr$NS <- "North"
plot.currentYr$NS[plot.currentYr$Site %in% grep(paste(southsites,collapse="|"),
                                                plot.currentYr$Site, value=TRUE)] <- "South"

#Average growth rate and CI for all sites
aggregate(value ~ variable, data = plot.currentYr, FUN= mean)

#Average growth rate and CI for south and north
aggregate(value ~ variable + NS, data = plot.currentYr, FUN= mean)

#Pyramid Rock growing?
plot.currentYr[plot.currentYr$Site == "Pyramid Rock",]

#Pond shrinking?
plot.currentYr[plot.currentYr$Site == "Pond",]
```

#Figure 2: Lambda and 95% CI for each
```{r}
plot.noold <- plot.currentYr[!grepl("old", plot.currentYr$Site),]
plot.noold <- rbind(plot.noold, plot.currentYr[plot.currentYr$Site == "Atwell Gulch (old)",])


jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig2.jpg", sep=""), width=250, height=200, units="mm", res=300)

ggplot(plot.noold[plot.noold$variable!="rsq",], 
       aes(Site,value, color= variable, group = variable, shape=variable))+
  geom_point(aes(size = 1)) +
  theme_bw()+
  scale_shape_manual(values=c(1,6,2))+
  scale_colour_manual(values=c("black","red", "red"))+
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 0, size = 12))+
  guides(colour= FALSE, shape= FALSE, size = FALSE)+
  labs(y="Lambda")+
  facet_grid(~NS, scales="free")

dev.off()

```

Discussion, lambda patterns
```{r}

fit.currentYr[fit.currentYr$lwr>1,]

```

### Reproduction
```{r}

sum15 <- sg_sum[sg_sum$Year == currentYr,]
sum(sum15$Rep)/sum(sum15$X)

aggregate(sg_sum$Rep, list(Year = sg_sum$Year, Site = sg_sum$SiteSame), sum)
aggregate(sg_sum$X, list(Year = sg_sum$Year, Site = sg_sum$SiteSame), sum)

mean(sg_sum$Prepro)
sd(sg_sum$Prepro)
data.frame(as.table(tapply(sg_sum$Prepro, INDEX = sg_sum$Site, FUN =mean)),
           as.table(tapply(sg_sum$Prepro, INDEX = sg_sum$Site, FUN = sd)))


```


Plant size

## Figure 5: Growth relationships between years for width (top) and height (bottom) for Sclerocactus glaucus individuals within demographic monitoring sites.    
6 rows of Road T-West that don't have a tag number, one row for Road T-East

```{r}
head(sg)
sg <- sg[!is.na(sg$Tag),]

sg.xy <- subset(merge(sg[,c(2:5,10:11)], sg[,c(2:5,10:11)], by=c("Site","Transect","Tag"),
                      sort=FALSE), Year.x == Year.y+1)
head(sg.xy)
sg.xy[is.na(sg.xy$Tag),]

southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.xy$NS <- "North"
sg.xy$NS[sg.xy$Site %in% grep(paste(southsites,collapse="|"),
                                                sg.xy$Site, value=TRUE)] <- "South"
```

```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig5a.jpg", sep=""), width=200, height=125, units="mm", res=300)

ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=lm, aes(y=Height.cm..x, x=Height.cm..y))+
  ggtitle("a)")+
  ylab(expression("Height year"[y]))+
  xlab(expression("Height year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)

dev.off()
```

```{r}
jpeg(paste("Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Word/ScGl ",currentYr,"/Fig5b.jpg", sep=""), width=200, height=125, units="mm", res=300)


ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=lm, aes(y=Width.cm..x, x=Width.cm..y))+
  ggtitle("b)")+
  ylab(expression("Width year"[y]))+
  xlab(expression("Width year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)

dev.off()
```


# Plant Size
```{r}

summary(lm(Height.cm..x ~ Height.cm..y, data=sg.xy))
summary(lm(Width.cm..x ~ Width.cm..y, data=sg.xy))

# Too many errors, use linear model to get change in size
sg.xy$ChangeH <- sg.xy$Height.cm..x-sg.xy$Height.cm..y
sg.xy$ChangeW <- sg.xy$Width.cm..x-sg.xy$Width.cm..y

mean(sg.xy$ChangeH[abs(sg.xy$ChangeH) < 3], na.rm=TRUE) #No way something lost 11cm or 21cm! that's an error
sd(sg.xy$Height.cm..x-sg.xy$Height.cm..y, na.rm=TRUE)

mean(sg.xy$Width.cm..x-sg.xy$Width.cm..y, na.rm=TRUE)
sd(sg.xy$Width.cm..x-sg.xy$Width.cm..y, na.rm=TRUE)


summary(lm(Prepro~(avgH+avgW)^2, data=sg_sum))

```



Annual report figure for Becky - 20180123
```{r}
plotout <- aggregate(X~Year, data=sg_sum, FUN = sum)
annualppt <- aggregate(ppt~Site+Prev12, data=scgl.c.summary, FUN = sum)
#Average total precipitation over sites
annualppt.avg <- aggregate(ppt~Prev12, data=annualppt, FUN= mean)
avgppt <- mean(annualppt.avg$ppt)
plotout1 <- merge(plotout, annualppt.avg, by.x = "Year", by.y = "Prev12")
plotout1$col[plotout1$ppt<avgppt] <- "Below Average PPT"
plotout1$col[plotout1$ppt>=avgppt] <- "Above Average PPT"
plotout1$growth <- plotout1$X-plotout1$X[1]
plotout1$change <- c(0,plotout1$X[-1]-plotout1$X[-length(plotout1$X)])

ggplot(plotout1, aes(Year,X))+
  geom_bar(stat= "identity", aes(fill=col))+
  theme_classic()

ggplot(plotout1[plotout1$Year>2008,], aes(Year,change))+
  geom_bar(stat= "identity", aes(fill=col))+
  theme_classic()+
  ggtitle("Change in population size from previous year")+
  scale_x_continuous(breaks=seq(2009,2017,1))

ggsave("Q:/Research/MEDL_folder/ScGl_yr.jpg",device="jpeg",
       ggplot(plotout1, aes(Year,X))+
         geom_line(colour="blue")+
         ylab("Total Population")+
         scale_x_continuous(breaks=seq(2008,2018,1))+
         theme_classic()+
         ggtitle("Sclerocactus glaucus"))

write.csv(plotout1, "Q:/Research/MEDL_folder/ScGl_data.csv")
```
