---
title: "ScGl_demography_BLM"
author: "Michelle DePrenger-Levin"
date: "Monday, October 05, 2015"
output: html_document
---

*** Are you not Michelle DePrenger-Levin?? -->   
    Set userpath to "C:/Users/<yourname>/" in the first chunk to run code as is. 
The repository is named "ScGl"   
Will need: git push ScGl master   

2015: uploaded "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/Raw Data/2015 Datasheets/DataEntry2015_10.13.15.csv"
```{r}
#if I need it!
rm(list=ls())
```

```{r, echo=FALSE}
library(ggplot2)
library(patchwork)
# library(plyr)
library(dplyr)
library(tidyr)
library(devtools)
#library(multcompView)
# library(reshape2)
library(raster)
library(prism)
library(RCurl)
# library(Rmisc)
require(AICcmodavg)
#Set wd for prism data if not already
# options(prism.path = "Q:/Research/All_Projects_by_Species/Sclerocactus SPECIES/Sclerocactus_glaucus/ScGl_climate")
# library(multcompView)
library(magrittr)
library(scales)
library(lme4)

## Highest density interval
library(HDInterval)


library(RMark)

```


```{r}
#Some global variables
currentYr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))

#count pva
# x = Year, y = count
CountPVA <- function(x,y){
  
  LM.table <- c()
  
  for(yrs in 3:length(unique(x))){		# gives 2 transitions before the first Count PVA calculation
		rsq <- c(); PVA.lm <- list()
  
    y.count <- y[1:yrs] #Annual count for site
    x.years <- x[1:yrs] #Years of counts (can have missing years)
    ySpecies <- log10(y.count[-1]/y.count[-length(y.count)])
    yr <- sqrt(x.years[-1]-x.years[-length(x.years)])
    
		PVA.lm <- lm(ySpecies ~ -1 + yr)
		mu_sp <- predict(PVA.lm, level= 0.95,
		                 interval = "confidence",
		                 se.fit = T)$fit[1,]
    rsq <- c(rsq, R2 = summary(PVA.lm)$adj.r.squared)	# pull R squared values from each year interval 
    LM.table <- rbind(LM.table,data.frame(rsq,RangeStart=min(x),RangeEnd=x[yrs],t(mu_sp)))    
	}
	Year1 <- x.years[-length(x.years)]
	Year2 <- x.years[-1]
	PVA.table <-data.frame(yr,ySpecies,Year1,Year2)
  
  list(PVA = PVA.table,LM = LM.table)
}

userpath <-"C:/Users/deprengm/" 
```


Need to calculate individuals from 2008 data seperate from following due to lack of measuring hight and width. Will need to get the total tagged individuals for number alive instead of number of individuals with a heigth > 0 from 2009 on. <https://research.botanicgardens.org/admin/>      

In 2012 we switched from measuring the height and width individuals under 0.5 cm in width to counting them as "minis". 

2008-currentYr data  
```{r}

sg <- read.csv(paste(userpath,"Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/2008-currentyr_Sclerocactus_glaucus_R_tables/RawData_scgl_", currentYr, ".csv", sep=""))
names(sg)

## Didn't get to Fram or Powerline in 2023
sg <- sg %>%
  filter(!(Site %in% c("Fram","Powerline") & Year == 2023))

table(sg$Site,sg$Year)
sg[which(sg$Width.cm. > 15),]
sg$Width.cm.[which(sg$Width.cm. > 18)] <- sg$Width.cm.[which(sg$Width.cm. > 18)]/10


#Remove rows where Site is blank, if any
sg[which(sg$Site == ""),]
if(nrow(sg[-which(sg$Site == ""),])>0){
  sg <- sg[-which(sg$Site == ""),]
  }

# Vol calculated at pi*r^2*h
sg$Vol <- pi*((sg$Width.cm./2)^2)*sg$Height.cm.

nrow(sg[sg$Year == 2008,]) ## 185
sg$Site <- factor(sg$Site) ## 15 levels with (old)
sg$Minis[sg$Minis > 1000 & !is.na(sg$Minis)] <- NA ## two have photo numbers instead of mini number


## Will only work for Michelle DePrenger-Levin - set to my OneDrive
if(grepl("deprengm",userpath)){
  write.table(sg, file=paste(userpath,"OneDrive - Denver Botanic Gardens/P drive/hackathon/ScGl/datasets/sg",currentYr,".csv",sep=""), sep=",")
}

```


##Summarize old and new data by number of individuals    
Need to split by Site - Atwell Gulch needs to be together:  
       `Atwell Gulch_108` and `Atwell Gulch_165` are Atwell Gulch with Ycoord < 30
       Road T-West (old) vs. T-Junction
       Oil Pad and Oil Pad (old)
       Pond and Pond (old)
     
summarize 2008  
```{r}
scgl08 <- read.delim(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/2008-currentyr_Sclerocactus_glaucus_R_tables/All2008.txt", sep=""),sep=",")

sg_summary08 <- scgl08 %>%
  dplyr::select(Year:SumOfMinis) %>% # exclude monthly climate data
  group_by(SiteName, Year) %>%
  rename(Site = SiteName) %>%
  dplyr::summarise(X = sum(CountofHeight),
                   Rep = sum(SumFlowered),
                   Brs = sum(SumBrowsed),
                   avgH = NA,
                   sdH = NA,
                   avgW = NA,
                   sdW = NA,
                   avgVol = NA,
                   sdVol = NA, .groups = "keep")
  
sg$Fl <- as.character(sg$Fl)
sg$Br <- as.character(sg$Br)

sg$Fl[sg$Fl == "n"] <- "0"
sg$Fl[sg$Fl == "y"] <- "1"

sg$Br[sg$Br == "n"] <- "0"
sg$Br[sg$Br == "y"] <- "1"

sg$Fl <- as.numeric(sg$Fl)
sg$Br <- as.numeric(sg$Br)

table(sg$Year, sg$Site)

# Pond was not finished in 2015
# Some data was entered but should be removed from the count data and trend analyses unless it is for individuals that were measured in 2015
# No data was collected in 2020 due to COVID-19, SARS-CoV-2

```


 
Starting in 2019 we use the photoNumber column to track the number of flowers per plant
```{r}

sg$FlNum <- ifelse(sg$Year >= 2019, as.numeric(sg$PhotoNumber), NA)

ggplot(sg[sg$Year > 2018,], aes(FlNum, Site, fill = Site, group = Site))+
  geom_point(position = position_jitterdodge())+
  geom_boxplot()+ 
  # scale_y_discrete(labels = label_wrap(3))+
  facet_wrap(~Year)

```



#Old and New data     
Atwell Gulch old is everything with a Y less than 30    
Atwell Gulch new is everything Atwell Gulch    
Rename Sites for Atwell old and new
```{r}
# Add a level to the Site factor field
sg$Site <- factor(sg$Site, 
                  levels = c("Atwell Gulch", "Atwell Gulch (old)",levels(sg$Site)))

# Rename all Atwell Gulch
sg[grep("Atwell", sg$Site),"Site"] <- "Atwell Gulch"

sg[sg$X.coord.m. > 1.1 & !is.na(sg$X.coord.m.) & sg$Site == "Atwell Gulch",]
sg$X.coord.m.[sg$Tag == 251 & sg$Site == "Atwell Gulch"] <- 0

```

#2016 on    
No more "Old" versions. Need to remove these data - tags that were in both versions are still reported. 
Stop Pond old in 2015
Keep Atwell old and new
Fram no data in 2015
```{r}
#Road T-East
sg <- sg[grep("Road T-East", sg$Site, invert=TRUE),]


#No "old" 2016 on
sg <- sg[-intersect(grep("old", sg$Site),which(sg$Year>2015)),]

#No Pond in 2015â•£
sg <- sg[-intersect(grep("Pond", sg$Site), which(sg$Year==2015)),]

# Assign genetic regions; now new species, still have not seen the publication 2022
sg$NS <- "S. dawsonii"
southsites <- c("Bridgeport","Escalante Canyon","Picnic Site","Powerline","Fram")
sg$NS[sg$Site %in% southsites] <- "S. glaucus"



sg$SiteSame <- sg$Site
sg$SiteSame[sg$Site %in% unique(grep(paste("Atwell",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "Atwell Gulch"

sg$SiteSame[sg$Site %in% unique(grep(paste("Pond",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "Pond"

sg$SiteSame[sg$Site %in% unique(grep(paste("Oil",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "Oil Pad"

sg$SiteSame[sg$Site %in% unique(grep(paste("T-",collapse="|"),
                                        sg$Site,
                                        value=TRUE))] <- "T-Junction"


## 2008 has Escalante Canyon, Picnic Site, Powerline, and Pyramid Rock
sg_summary08$SiteSame <- sg_summary08$Site

# Assign genetic regions
sg_summary08$NS <- "S. dawsonii"
southsites <- c("Bridgeport","Escalante Canyon","Picnic Site","Powerline","Fram")
sg_summary08$NS[sg_summary08$Site %in% southsites] <- "S. glaucus"

# One copy of all Atwell Gulch 2012 on for new (after three transects were extended)
atwell.new <- sg[intersect(grep("Atwell",sg$Site),which(sg$Year>2011)),]
# One copy of all Atwell Gulch for all years but transects not extended
atwell.old <- sg[intersect(grep("Atwell",sg$Site),which(sg$Y.coord.m.<30)),] 
atwell.old$Site <- "Atwell Gulch (old)"

ggplot(atwell.old, aes(X.coord.m., Y.coord.m., color = as.factor(Year)))+
  geom_point(position = position_dodge(width = 0.05), pch="|",size = 2)+
  facet_wrap(~ Transect, nrow = 2)+
  theme_bw()

#Add back Atwell duplicated for old and new
sg <- do.call(rbind,list(sg[grep("Atwell", sg$Site, invert = TRUE),],atwell.new,atwell.old))
length(levels(sg$Site))
sg$Site <- droplevels(sg$Site)
levels(sg$Site)


# to match sg_summary later
sg_summary08 <- sg_summary08[,c(1,12:13,2:11)]
```

#Data checks
```{r}

sg[which(sg$Height.cm. > 7.5 & sg$Site == "Picnic Site"),]
unique(sg$Comments[sg$Site == "Picnic Site" & is.na(sg$Height.cm.)]) ## Some are dead, some might be seedlings <0.5cm

sg[which(sg$Height.cm. > 7.5 & sg$Site == "Pond"),] 
unique(sg$Comments[sg$Site == "Pond" & is.na(sg$Height.cm.)])

```


Merge for size changes year to year by location
```{r}
southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg$NS <- "S. dawsonii"
sg$NS[sg$SiteSame %in% grep(paste(southsites,collapse="|"),
                                                sg$SiteSame, value=TRUE)] <- "S. glaucus"


sg %>%
  filter(Width.cm. > 20)



sg.new <- sg %>%
  dplyr::select(Site:Y.coord.m., Width.cm.:Minis, SiteSame, NS) %>%
  filter(!grepl("old",Site)) 

sg.merged <- sg.new %>%
  group_by(Site, SiteSame, NS, Transect, Tag, X.coord.m., Y.coord.m.) %>%
  left_join(sg.new, by = c("Site","SiteSame","NS","Tag","Transect",
                           "X.coord.m.","Y.coord.m.")) %>%
  dplyr::select(Site:Y.coord.m., Width.cm..x:Minis.x, Year.y, Width.cm..y:Minis.y) %>%
  filter(Year.x == Year.y-1) %>%
  filter(Width.cm..x != 0) %>%
  mutate(surv = ifelse(Width.cm..y ==0, 0,1))

ggplot(sg.merged, aes(Width.cm..x, surv, color = as.factor(Br.x)))+
    geom_point(pch="|")+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  facet_grid(~NS)

ggplot(sg.merged, aes(Width.cm..x, Width.cm..y, colour = as.factor(Transect)))+
  geom_point()+
  stat_smooth(se=FALSE)+
  facet_wrap(~NS)+
  scale_color_discrete(guide = "none")

save(sg.merged,  file=paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_Projects/2022_DoakPortfolioEffectNSFProposal/",currentYr,"sgSizeMerged.Rdata", sep=""))
```

2008 is a summary already, need to summarize rest before combining with 2008. 
```{r}

## remove atwell and add in later
sg_summary <- sg %>%
  filter(Year > 2008,
         !(Site %in% c("Atwell Gulch","Atwell Gulch (old)"))) %>%
  group_by(Site,SiteSame,NS,Year) %>%
  dplyr::summarise(.groups = "keep",
                   ## the number of individuals should include minis
                   X = length(Tag[Height.cm. >0]) + sum(Minis, na.rm = TRUE),
                   Rep = sum(Fl, na.rm = TRUE),
                   Brs = sum(Br, na.rm = TRUE),
                   medianH = median(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                   Height95HDIlwr = hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[1],
                   Height95HDIupr = hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[2],
                   medianW = median(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                   Width95HDIlwr = hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[1],
                   Width95HDIupr = hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[2],
                   avgVol = mean(Vol, na.rm = TRUE),
                   sdVol = sd(Vol, na.rm = TRUE))


atwell_summary <- bind_rows(atwell.old, atwell.new) %>%
  group_by(Site,SiteSame,NS,Year) %>%
  dplyr::summarise(.groups = "keep",
                   X = length(Tag[Height.cm. >0] + sum(Minis, na.rm = TRUE)),
                   Rep = sum(Fl, na.rm = TRUE),
                   Brs = sum(Br, na.rm = TRUE),
                   medianH = median(Height.cm.[Height.cm. > 0], na.rm = TRUE),
                   Height95HDIlwr = hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[1],
                   Height95HDIupr = hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[2],
                   medianW = median(Width.cm.[Width.cm. > 0], na.rm = TRUE),
                   Width95HDIlwr = hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[1],
                   Width95HDIupr = hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[2],
                    avgVol = mean(Vol, na.rm = TRUE),
                    sdVol = sd(Vol, na.rm = TRUE))

                           
```

#Data summary
Combine 2008 (with no height or width data) and remaining years 
```{r}

## Now sg_summary has a lower and upper HDI where sg_summary08 only has SD for height and width. 
sg_summary08 <- sg_summary08 %>%
  dplyr::mutate(# dplyr::rename(Height95HDIlwr = sdH),
                # dplyr::rename(Width95HDIlwr = sdW),
                Height95HDIupr = NA, Width95HDIupr = NA) %>%
  # select(Site:Height95HDIlwr,Height95HDIupr,avgW:Width95HDIlwr, Width95HDIupr, avgVol:sdVol )
  dplyr::select(Site:sdH, Height95HDIupr, avgW:sdW, Width95HDIupr, avgVol:sdVol)
names(sg_summary08) <- names(sg_summary)
sg_sum <- do.call(rbind, list(sg_summary08,sg_summary, atwell_summary))
```

Report Tables_current year
Table 2: Summary data of Sclerocactus glaucus demographic monitoring in western Colorado (2008-2015).
```{r}

# total area from table 2
## Should be total meter2 surveyed (not the entire size of the macroplot)
unique(sg_sum$Site)
sg_sum$area <- NA
sg_sum$area[sg_sum$Site == "Escalante Canyon"] <- 180
sg_sum$area[sg_sum$Site == "Bridgeport"] <- 200 # 400 is wrong, is four 1 x 50m
sg_sum$area[sg_sum$Site == "Atwell Gulch"] <- 390 # correct, 2012 and beyond is 390, but the macroplot area == 1270
sg_sum$area[sg_sum$Site == "Atwell Gulch (old)"] <- 300
sg_sum$area[sg_sum$Site == "Fram"] <- 1300 # 1300, not adjacent, treat them as if they're within 2600m2
sg_sum$area[sg_sum$Site == "Oil Pad (old)"] <- 672
sg_sum$area[sg_sum$Site == "Oil Pad"] <- 120 # correct 2012 forward
sg_sum$area[sg_sum$Site == "Picnic Site"] <- 100 ## what is this?! 160. There are five 1 X 20 meters
sg_sum$area[sg_sum$Site == "Pond"] <- 36
sg_sum$area[sg_sum$Site == "Pond (old)"] <- 235.6
sg_sum$area[sg_sum$Site == "Powerline"] <- 100 # 40 is wrong, is two 1 x 50
sg_sum$area[sg_sum$Site == "Pyramid Rock"] <- 100
sg_sum$area[sg_sum$Site == "Road T-West (old)"] <- 2212
sg_sum$area[sg_sum$Site == "T-Junction"] <- 130

sg_sum$Density <- sg_sum$X/sg_sum$area
```


All sites   
Add baseline for each facet
```{r}
# baselineScGl <- 0.26
# baselineScDa <- 0.57

## "From 2023 monitoring summary report_BLM"
baselineScGl <- 0.27
baselineScDa <- 0.68

baselineDF <- data.frame(NS = c("S. dawsonii","S. glaucus"), 
                         Y = c(baselineScDa,baselineScGl))

plot1 <- filter(sg_sum, !grepl("old", Site)) %>%
  ggplot(  aes(Year,Density,colour=Site))+
    geom_point(size=2)+
    geom_line()+
    theme_bw()+
    ggtitle("a)")+
    xlim(c(2008, 2024))+
    ylab(expression("Density ( plants/m"^{2}~")")) +
    scale_color_brewer(palette = "Set3")+ #, guide = "none")+
    facet_wrap(~NS, nrow = 2, scales = "free")+
    geom_hline(data = baselineDF, aes(yintercept = Y), linetype = "longdash")


```

Density changing from year to year and from the baseline?   
```{r}

sg_density <- sg_sum %>%
  mutate(Change.Density = if_else(NS == "S. glaucus", (Density - baselineScGl )/baselineScGl, 
                 (Density - baselineScDa )/baselineScDa)) # %>%
  # filter(!(Site == Fram))

sg_density %>%
  filter(Year == 2023) %>%
  write.csv(file = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/2023_Sclerocactus-glaucus_AnnualReport/density_",currentYr,".csv", sep=""), row.names = FALSE)

plot2 <- filter(sg_density, !grepl("old", Site)) %>%
      ggplot(  aes(Year, Change.Density, color = Site))+
        geom_point(size=2)+
        geom_line()+
        theme_bw()+
        facet_wrap(~NS, nrow = 2, scales = "free")+
        scale_color_brewer(palette = "Set3")+
        scale_y_continuous(labels = scales::percent)+
        ylab("Density: percent of baseline")+
        geom_hline(yintercept = -0.2, linetype = "longdash")


plot3 <- filter(sg_density, !grepl("old", Site)) %>%
  ggplot(  aes(Year, Change.Density, color = NS))+
    geom_point(size=2)+
    geom_line()+
    theme_bw()+
    ggtitle("b)")+
    facet_wrap(~Site, nrow = 5, scales = "free_y")+
    scale_colour_manual(values = c("cadetblue","goldenrod"))+
    scale_y_continuous(labels = scales::percent)+
    ylab("Density: percent change from baseline")+
    geom_hline(yintercept = -0.2, linetype = "longdash")

## Average change in density from baseline
sg_density %>%
  group_by(NS) %>%
  dplyr::summarise(MeanChange = mean(Change.Density[Year == currentYr]))

## Change in density from previous to current year
sg_density %>%
  group_by(NS) %>%
  dplyr::summarise(VarChange = sd(Change.Density[Year == currentYr]))


sg_density %>%
  group_by(NS) %>%
  dplyr::summarise(Change = 
                     mean((Density[Year == currentYr] - Density[Year == currentYr-1])/Density[Year == currentYr-1]))
sg_density %>%
  group_by(NS) %>%
  dplyr::summarise(Change = 
                     sd((Density[Year == currentYr] - Density[Year == currentYr-1])/Density[Year == currentYr-1]))
```

```{r}
# ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"density_corrected.jpg", sep=""),
ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"density.jpg", sep=""),

  plot1 + plot3 + plot_layout(widths = c(2,5)),


width = 305, height = 200, units = 'mm', dpi=300)

```

Mark-recapture with missing surveys   
Simple open Jolly-Seber  
```{r}

table(sg$SiteSame,sg$Year)
table(sg$Site, sg$Year)

## Need to get rid of duplicates! Old and new design
sg.newold <- sg %>%
  distinct(SiteSame, Tag, Year, .keep_all = TRUE)
  
table(sg.newold$Site, sg.newold$Year)
  
table(sg.newold$SiteSame)

sg.JS <- sg.newold %>%
  mutate(SiteSame = droplevels(SiteSame)) %>%
  mutate(NS = gsub(" ", "", NS)) %>%
  mutate(NS = gsub("\\.","",NS)) %>%
  mutate(Site = gsub(" ", "", SiteSame)) %>%
  mutate(Site = gsub("-", "", Site)) %>%
  mutate(NS = as.factor(NS)) %>%
  mutate(capture = if_else(Width.cm. > 0, "1", "0")) %>%
  tidyr::complete(nesting(Site,Transect,Tag, Year, NS), fill = list(capture = "0")) %>%
  arrange(Year, .by_group = TRUE) %>%
  pivot_wider(names_from = Year, values_from = capture, id_cols = c(Site, Transect, Tag, NS), 
              names_prefix = "Year", values_fill = "0") %>%
  unite(ch, Year2008:Year2023, sep="") %>%
  filter(grepl("1",ch))

dmPlot <- model.matrix(~ -1 + Site, sg.JS)
# dmSpecies <- model.matrix(~ -1 + Site + NS, sg.JS)
# ## Add S.dawsonii column
# dmSpecies <- dmSpecies %>%
#   as.data.frame(.) %>%
#   mutate(NSSdawsonii = if_else(NSSglaucus == 0, 1, 0))

sg.JSPlot <- sg.JS %>%
  # dplyr::select(ch, NS) %>%
  dplyr::select(ch, NS) %>%
  # bind_cols(dmSpecies) %>%
  bind_cols(dmPlot) %>%
  mutate(SiteTJunction = paste(SiteTJunction, ";", sep = ""))
  # mutate(NSSdawsonii =  paste(NSSdawsonii, ";", sep = ""))

sg.JSPlot %>%
  write.table(file=paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"CJS_scgl.inp", sep=""), 
              sep = "   ", quote=FALSE, col.names = FALSE, row.names = FALSE)

```



```{r}
# 1. Goodness of fit test for most parameterized, general model

plotdf <- sg.JS %>%
  distinct(Site) %>%
  mutate(Site = as.factor(Site))
speciesdf <- sg.JS %>%
  distinct(Site,NS) %>%
  mutate(NS = as.factor(NS)) 

scgl.inp <- convert.inp(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"CJS_scgl.inp", sep=""),
                        # group.df = speciesdf,
                        group.df = plotdf,
                        covariates = "NS",
                        use.comments = FALSE)

scglproc <- process.data(scgl.inp, model = "Pradrec", groups = c("Site","NS"), begin.time = 2008)
scglddl <- make.design.data(scglproc)

## Fix p to zero when no survey
pindex <- scglddl$p
## Just the expanded new version of Atwell Gulch
p.SSR <- pindex %>%
  mutate(time = as.numeric(as.character(time))) %>%
  filter(group %in% c("AtwellGulch","TJuction","OilPad","Pond")) %>%
  filter(time < 2012)

p.Bridgeport <- pindex %>%
  mutate(time = as.numeric(as.character(time))) %>%
  filter(group %in% c("Bridgeport")) %>%
  filter(time < 2011)

p.Fram <- pindex %>%
  mutate(time = as.numeric(as.character(time))) %>%
  filter(group %in% c("Fram")) %>%
  filter(time < 2013 | time %in% c(2015,2023))

p.2015 <- pindex %>%
  mutate(time = as.numeric(as.character(time))) %>%
  filter(group %in% c("Pond","Fram")) %>%
  filter(time == 2015)

## No Powerline (fence) or Fram (wet roads) in 2023
p.2023 <- pindex %>%
  mutate(time = as.numeric(as.character(time))) %>%
  filter(group %in% c("Fram","Powerline")) %>%
  filter(time == 2023)

p.indices <- c(p.SSR$par.index,p.Bridgeport$par.index,p.Fram$par.index,p.2015$par.index,p.2023$par.index)
p.values <- rep(0, length(p.indices))
```

"LinkBarkRan"   
Link-Barker Survival and Recruitment with Random Effect    
    Assumptions:
       1. can enter on any occasion. Saturated model computed with parameter estimated as number of individuals with an encounter history divided by all individuals encountered
       2. Tags are not lost, read properly
       3. sampling instantaneous   
       4. Survival probabilities same for marked and unmarked individuals
       5. Study area remains constant
       6. Conditions on the individual being seen somewhere in the experiment
Parameters: 
sigmaphi: individual heterogeneity         
Phi: survival     
sigmap: individual heterogeneity of p    
p: detection    
sigmaf: individual heterogeneity of f      
f: net recruitment probability (the per capita number of new between i and i+1)   


```{r}
run.scgl <- function(){
  Phi.dot = list(formula =  ~ 1)
  Phi.time = list(formula =  ~ time)
  Phi.Plot = list(formula =  ~ Site)  ## so each plot is offset
  Phi.timePlot = list(formula =  ~ time + Site)
  
  p.dot = list(formula =  ~ 1, fixed = list(index = p.indices, value = p.values))

  f.dot = list(formula =  ~ 1)
  f.time = list(formula = ~ time)
  f.Plot = list(formula = ~ Site)
  f.timePlot = list(formula = ~ time + Site)
  
  scgl.model.list <- create.model.list("Pradrec")
  
  scgl.results <- mark.wrapper(scgl.model.list, data = scglproc, ddl = scglddl)
  
  return(scgl.results)
}

scgl.models <- run.scgl()
save(scgl.models, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"PradelScGl.Rdata", sep=""))


## Estimate constant population growth rate across each study site but setting apparent survival constant.  Constant survival

scgl.constant <- mark(data = scglproc, ddl = scglddl, model = "Pradrec",
                      model.parameters = list(p = list(formula = ~ Site, fixed = list(index = p.indices, value = p.values)),
                                              Phi = list(formula = ~ Site),
                                              f = list(formula = ~ time + Site)),
                      begin.time = 2008,
                      groups = "Site")

summary(scgl.constant)

estimates <- scgl.constant$results$real %>%
  mutate(params = row.names(.)) %>%
  separate(params, into = c("Parameter","group","age","time"))

estimates %>%
  filter(Parameter == "p")

  

scgl.constant$results$derived$`Lambda Population Change`

## lambda = f + survival, estimate with all values within the range of uncertainty for f and Phi
# skip the first year, estimates are crazy for per capita recruitment
x <- unique(estimates$group)[1]
sitelambdas <- do.call(rbind, lapply(unique(estimates$group), function(x){
  group <- estimates[estimates$group == x,]
  Phirange <- seq(from = group$lcl[group$Parameter == "Phi"],
                  to = group$ucl[group$Parameter == "Phi"], length.out = 10)
  frange <- c()
  for(yr in 2:14){
    frange <- cbind(frange, fvalues = seq(from = group$lcl[group$Parameter == "f"][yr],
                                          to = group$ucl[group$Parameter == "f"][yr], length.out = 10))
  }
  frange <- data.frame(frange)
  colnames(frange) <- paste("Year",2009:2021, sep="")
  # For each year, need all combinations of 
  combos <- do.call(rbind,lapply(1:nrow(frange), function(yr) {
    out <- data.frame(group = x, Year = yr)
    params <- expand.grid(Phirange, frange[,yr])
    colnames(params) <- c("Phi","f")
    params$lambda <- params$Phi + params$f
    data.frame(out,params)
  }))
  }))

SiteSpecies <- sg %>%
  distinct(Site, NS) %>%
  mutate(Site = gsub(" ", "", Site)) %>%
  mutate(Site = gsub("-", "", Site)) 

Fig2b <- sitelambdas %>%
  mutate(group = sub("g","",group)) %>%
  left_join(SiteSpecies, by = c("group" = "Site")) %>%
  group_by(group, NS) %>%
  dplyr::summarise(hdilwl = HDInterval::hdi(lambda)[1],
                   hdiupl = HDInterval::hdi(lambda)[2],
                   median = median(lambda)) %>%
  ggplot(  aes(group, median))+
    geom_point()+
    geom_errorbar(aes(ymin = hdilwl, ymax = hdiupl), width = 0.5)+
    theme_bw() +
    geom_hline(yintercept = 1, color = "grey50", linetype = "dashed")+
    theme(strip.text = element_text(face = "italic")) +
    facet_wrap(~NS, scales = "free_x") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
    ylab(expression(lambda))+
    xlab("")+
    ggtitle("b)")

## See far below for Fig2a, count based growth rate
    
```

```{r}
library(bayestestR)

params <- scgl.models$Phi.timePlot.p.dot.f.timePlot$results$real %>%
  mutate(params = row.names(.)) %>%
  tidyr::separate(params, into = c("parameter","group","age","time")) %>%
  filter(parameter == "Phi") %>%
  dplyr::select(parameter,group,time)

SpeciesSites <- sg %>%
  distinct(SiteSame, NS) %>%
  mutate(Site = gsub(" ", "", SiteSame)) %>%
  mutate(Site = gsub("-", "", Site)) 
  
## May want to exclude the first and last
scgl.models$Phi.Plot.p.dot.f.Plot$results$derived$`log(Lambda) Population Change` %>%
  bind_cols(params) %>%
  distinct(estimate,se,lcl,ucl) 

scgl.models$Phi.Plot.p.dot.f.Plot$results$derived$`Lambda Population Change` %>%
  bind_cols(params) %>%
  distinct(estimate,se,lcl,ucl)


scgl.models$Phi.timePlot.p.dot.f.timePlot$results$real %>%
  mutate(params = row.names(.)) %>%
  tidyr::separate(params, into = c("parameter","group","age","time")) %>%
  group_by(parameter, group) %>%
  mutate(estimate = if_else(parameter == "f", log(estimate), estimate)) %>%
  dplyr::summarise(median = median(estimate),
                   HDIucl = bayestestR::hdi(estimate)$CI_high,
                   HDIlcl = bayestestR::hdi(estimate)$CI_low) %>%
  print(n=21)

```


Summary tables pre and post
```{r}

tableout <- sg_sum %>%
  dplyr::select(Year, Site, X:area) %>%
  group_by(Year,Site) %>%
  mutate(TotInd = X, IndSqM = round(X/area,2), PercRepro = paste0(round(100*Rep/X, 1), "%"),
         MedianHeight = paste(round(medianH,2), " (", round(Height95HDIlwr,2), "-", round(Height95HDIupr,2),"cm)", sep=""),
         MedianWidth = paste(round(medianH,2), " (", round(Width95HDIlwr,2), "-",round(Width95HDIupr,2), "cm)", sep = ""),
         PercBr = paste0(round(100*Brs/X, 2), "%")) %>%
  dplyr::select(Site:Year, area, TotInd, IndSqM, Rep, PercRepro, MedianHeight, MedianWidth, Brs, PercBr)

new <- c("Atwell Gulch","Oil Pad","Pond","T-Junction")

tablesummaryout <- sg_sum %>%
  dplyr::mutate(Group = case_when(Site %in% new ~ "post",
                           !(Site %in% new) ~ "pre")) %>%
  # dplyr::select(Year, Site, X:area, Group) %>%
  group_by(Group, Year) %>%
  dplyr::summarise(area = sum(area), TotInd = sum(X), IndSqM = round(sum(X)/area,2), 
                   TotRep = sum(Rep),
                   PercRepro = paste0(round(100*sum(Rep)/sum(X), 1), "%"),
         Brs = sum(Brs), PercBr = paste0(round(100*sum(Brs)/sum(X), 2), "%")) %>%
  arrange(Year,Group)



### summary of average size and SD of size across all sites within the pre and post set up
sizesummary <- bind_rows(atwell.old, atwell.new, sg) %>%
  dplyr::mutate(Group = case_when(Site %in% new ~ "post",
                           !(Site %in% new) ~ "pre")) %>%
  # dplyr::select(Year, Site, Group, Height.cm.:Width.cm., Group) %>%
  group_by(Group, Year) %>%
  dplyr::summarise(
         MedianHeight = paste(round(median(Height.cm.[Height.cm. > 0], na.rm = TRUE),2), " (", 
                              round(HDInterval::hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[1],2), "-", 
                              round(HDInterval::hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[2],2),"cm)", sep=""),
         MedianWidth = paste(round(median(Width.cm.[Width.cm. > 0], na.rm = TRUE),2), " (", 
                             round(HDInterval::hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[1],2), "-",
                             round(HDInterval::hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[2],2), "cm)", sep = "")) %>%
  arrange(Year,Group)


```


### 2016 on only Atwell Gulch repeats, should drop Atwell Gulch pre since all of these are included in post   
Should report the means and differences among ScGl and ScDa plots in 2016 onward. 
Summary tables pre and post
```{r}

tableoutNS <- sg_sum %>%
  filter(Year > 2015, !grepl("old",Site) ) %>%
  dplyr::select(Year, Site, NS, X:area) %>%
  group_by(Year,NS,Site) %>%
  mutate(TotInd = X, IndSqM = round(X/area,2), PercRepro = paste0(round(100*Rep/X, 1), "%"),
         MedianHeight = paste(round(medianH,2), " (", round(Height95HDIlwr,2), "-", round(Height95HDIupr,2),"cm)", sep=""),
         MedianWidth = paste(round(medianH,2), " (", round(Width95HDIlwr,2), "-",round(Width95HDIupr,2), "cm)", sep = ""),
         PercBr = paste0(round(100*Brs/X, 2), "%")) %>%
  dplyr::select(Year,NS,Site, area, TotInd, IndSqM, Rep, PercRepro, MedianHeight, MedianWidth, Brs, PercBr) %>%
  arrange(Year,NS,Site)


tablesummaryoutNS <- sg_sum %>%
  dplyr::select(Year, Site, X:area, NS) %>%
  filter(Year > 2015, !grepl("old",Site) ) %>%
  group_by(Year, NS) %>%
  dplyr::summarise(area = sum(area), TotInd = sum(X), IndSqM = round(sum(X)/area,2),
                   TotRep = sum(Rep),
                   PercRepro = paste0(round(100*sum(Rep)/sum(X), 1), "%"),
         Brs = sum(Brs), PercBr = paste0(round(100*sum(Brs)/sum(X), 2), "%")) 


### summary of average size and SD of size across all sites within the pre and post set up  
## report the median and the highest density interval of 95%
sizesummaryNS <- bind_rows(atwell.new, sg) %>%
  filter(Year > 2015, !grepl("old",Site), Height.cm. > 0 ) %>%
  dplyr::select(Year, Site, NS, Height.cm.:Width.cm.) %>%
  group_by(Year,NS) %>%
  dplyr::summarise(
         MedianHeight = paste(round(median(Height.cm.[Height.cm. > 0], na.rm = TRUE),2), " (", 
                              round(HDInterval:: hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[1],2), "-", 
                              round(HDInterval::hdi(Height.cm.[Height.cm. > 0], credMass = 0.95)[2],2),"cm)", sep=""),
         MedianWidth = paste(round(median(Width.cm.[Width.cm. > 0], na.rm = TRUE),2), " (", 
                             round(HDInterval::hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[1],2), "-",
                             round(HDInterval::hdi(Width.cm.[Width.cm. > 0], credMass = 0.95)[2],2), "cm)", sep = ""))

```



```{r}


## All years with minis added to count
poststand <- tableout %>%
  filter(Site %in% new) %>%
  arrange(Year,Site)

prestand <- tableout %>%
  filter(!Site %in% new) %>%
  arrange(Year,Site)

write.table(poststand, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_poststand.csv", sep=""), sep=",", row.names=FALSE, col.names = TRUE)


write.table(prestand, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_prestand.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)

write.table(tableoutNS, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_ScGl_ScDa.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)

## Demography: reproduction
tableoutNS %>%
  mutate(PercRepro = gsub("%","",PercRepro)) %>%
  mutate(PercRepro = as.numeric(PercRepro)) %>%
  mutate(PercRepro = PercRepro/100) %>%
  filter(Year == currentYr) %>%
  group_by(NS) %>%
  dplyr::summarise(mean = mean(PercRepro),
                   sd = sd(PercRepro))

### For 2008-2015 to compare the old and new designs
## Summary for each year and pre or post; average of the mean size and average of the SDs
write.table(tablesummaryout, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_yearlysummary.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)

## Size summary of average size and SD across all individuals in a group
write.table(sizesummary, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_yearlySIZEsummary.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)


### For 2016-currentYr to compare ScGl and ScDa
## Summary for each year and species; average of the mean size and average of the SDs but the rest are good summaries
write.table(tablesummaryoutNS, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_yearlysummary_ScGl_ScDa.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)

## Size summary of average size and SD across all individuals in a species
write.table(sizesummaryNS, file = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/Table2_yearlySIZEsummary_ScDa.csv", sep=""),
            sep=",", row.names=FALSE, col.names = TRUE)
```

# Results: Reproduction
```{r}

## Size at reproduction
## don't double up the individuals that are in both old and new designs
sizeRep <- sg %>%
  drop_na(Width.cm.,Fl) %>%
  distinct(Tag, SiteSame, .keep_all = TRUE) %>%
  dplyr::group_by(NS,Site, Fl) %>%
  dplyr::summarise(.groups = "keep", 
                   SizeMin = min(Width.cm., na.rm = TRUE), 
                   SizeMean = mean(Width.cm., na.rm = TRUE),
                   SizeMedian = median(Width.cm., na.rm = TRUE),
                   SizeMax = max(Width.cm., na.rm = TRUE))

as.data.frame(sizeRep)
sizeRep %>%
  filter(Fl == 1) %>%
  group_by(NS) %>%
  dplyr::summarise(minSz = mean(SizeMin), meanSz = mean(SizeMean), medianSz = median(SizeMedian),
                   .groups = "keep")

ggplot(sg[which(sg$Width.cm. > 0 & !duplicated(sg[,c("Tag","SiteSame")])),], aes(Site,Width.cm., color = as.factor(Fl)))+
  geom_boxplot()+
  ylim(c(0,17))+
  geom_point(position = position_jitterdodge(jitter.height = 0))+
  facet_wrap(~NS,nrow = 2, scales = "free")+
  scale_x_discrete(labels = label_wrap(5))

## all sites
### Double counting the Atwell Gulch ones and some Pond, Oil Pad, and T-Junction ones
rep_site.all <- sg_sum %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "all")


## Pre-standardized after 2012, NOT the new ones, the Old ones 
# [1] "Atwell Gulch" "Oil Pad"      "Pond"         "T-Junction"
sg_sum %>%
  filter(Year >= 2012) %>%
  filter(!(Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  summarise(Mean = mean(MeanRep), SD = sd(SDRep)) %>%
  mutate(Group = "pre2012on")

## all years
rep_site <- sg_sum %>%
  filter(!(Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "pre")


whichsites <- sg_sum %>%
  filter(!(Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep")
table(whichsites$Site, whichsites$Year)

ggplot(rep_site, aes(Year, MeanRep))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin = MeanRep - SDRep, ymax = MeanRep + SDRep), width = 0.2)

##Average percent repro >= 2012 pre-standard
rep_site %>% 
  summarise(Mean = mean(MeanRep), SD = sd(SDRep))



# the ones that changed 
rep_site.post <- sg_sum %>%
  filter(Year >= 2012) %>%
  filter((Site %in% new)) %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Year) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "post")

rep_site.post %>%
  summarise(Mean = mean(MeanRep), SD = sd(SDRep))

compareall <- bind_rows(rep_site,rep_site.all, rep_site.post)
ggplot(compareall, aes(Year, MeanRep, color = Group))+
  geom_point(position = position_dodge(width = 0.5))+
  geom_line(position = position_dodge(width = 0.5))+
  geom_errorbar(aes(ymin = MeanRep - SDRep, ymax = MeanRep + SDRep), width = 0.2,
                position = position_dodge(width = 0.5))

### Are larger non-reproductive individuals dying?
table(sg$Comments[which(sg$Width.cm. > 6.5 & sg$Fl == 0)])

# Average reproduction of each site
sg_sum %>%
  group_by(Year, Site) %>%
  dplyr::summarise(PR = Rep/X, .groups = "keep") %>%
  group_by(Site) %>%
  dplyr::summarise(MeanRep = mean(PR), SDRep = stats::sd(PR), 
                   SE = sd(PR)/sqrt(length(PR)),
                    CI = sd(PR)/sqrt(length(PR)) * (qt(0.95/2 + 0.5, length(PR)-1))) %>%
  mutate(Group = "all") %>%

sg_sum <- sg_sum %>%
  mutate(PRep = Rep/X)

```

AIC for reproduction below after loading climate


Climate directly from PRISM   
### update only the previous year each year  
```{r}
#devtools::install_github("ropensci/prism")

prism_set_dl_dir("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")

```


# Precip Total precipitation (rain and snow)
```{r}
#get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = 1986:currentYr)
```

#Update last year and get this year 
Delete previous year from folder first, then update    
       search for previous year in File Explorer         
       select all (provisional and stable) and delete     
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Maximum temperature (average)
get_prism_monthlys(type="scalevalue_tmax", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)

# Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentYr-1):currentYr)
```

Pick up any that didn't download
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", mon=3, keepZip = FALSE, years = 1995)
get_prism_monthlys(type="ppt", mon=5, keepZip = FALSE, years = 1988)
get_prism_monthlys(type="ppt", mon=10, keepZip = FALSE, years = 2001)
get_prism_monthlys(type="ppt", mon=11, keepZip = FALSE, years = 2004)
get_prism_monthlys(type="ppt", mon=7, keepZip = FALSE, years = 2007)
get_prism_monthlys(type="ppt", mon=12, keepZip = FALSE, years = 2009)
```


Lat longs for 10 sites   
39.1969Ã‚Â°N, 108.1298Ã‚Â°W Atwell    
38.8491Ã‚Â°N, 108.3717Ã‚Â°W Bridgeport   
38.6593Ã‚Â°N, 108.3466Ã‚Â°W Escalante     
39.0612Ã‚Â°N, 108.3799Ã‚Â°W Fram        
39.3446Ã‚Â°N, 108.3102Ã‚Â°W Oil Pad    
38.6701Ã‚Â°N, 108.3286Ã‚Â°W Picinic    
39.3606Ã‚Â°N, 108.3136Ã‚Â°W Pond    
38.7291Ã‚Â°N, 108.1770Ã‚Â°W Powerline   
39.3069Ã‚Â°N, 108.2755Ã‚Â°W Pyramid Rock   
39.3544Ã‚Â°N, 108.3286Ã‚Â°W T-Junciton   
```{r}
latlong <- data.frame(rbind(c(39.1969, -108.1298, "Atwell Gulch"),
                           # c(39.1969, -108.1298, "Atwell Gulch (old)"),
                            c(38.8491, -108.3717, "Bridgeport"),   
                            c(38.6593, -108.3466, "Escalante Canyon"),
                            c(39.0612, -108.3799, "Fram"),
                            c(39.3446, -108.3102, "Oil Pad"),
#                            c(39.3446, -108.3102, "Oil Pad (old)"),
                            c(38.6701, -108.3286, "Picnic Site"),
                            c(39.3606, -108.3136, "Pond"),
#                            c(39.3606, -108.3136, "Pond (old)"),
                            c(38.7291, -108.1770, "Powerline"),
                            c(39.3069, -108.2755, "Pyramid Rock"),
                            c(39.3544, -108.3286, "T-Junction")))
#,
#                            c(39.3544, -108.3286, "Road T-West (old)")))   
names(latlong) <- c("Lat","Long","Site")
latlong[,1:2] <- sapply(latlong[,1:2], function(x) as.numeric(as.character(x)))
```

# Go into folder "Q:\Research\All_Projects_by_Species\Sclerocactus SPECIES\Sclerocactus_glaucus\ScGl_climate\PRISM_ppt_provisional_4kmM3_201601_bil" and delete the provisional ones from last year    
Put into scgl instead so only one copy of everything climate

Max temp   
16 years 2000:currentYr
Min temp   
16 years 2000:currentYr
```{r, eval=FALSE}

m.ppt <- prism_archive_subset("ppt", "monthly", years = 1986:currentYr)
m.ppt2 <- lapply(m.ppt, function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]),
             date = x, Site = latlong$Site)
})


m.scalevalue_tmax <- lapply(prism_archive_subset("scalevalue_tmax","monthly",years = 1986:currentYr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]),
             date = x, Site = latlong$Site)
})

m.tmin <- lapply(prism_archive_subset("tmin","monthly",years = 1986:currentYr), function(x){
  x_rast <- pd_to_file(x)
  rastertemps <- raster(x_rast)
  data.frame(data = raster::extract(rastertemps, latlong[,c("Long","Lat")]),
             date = x, Site = latlong$Site)
})
```

PRISM_ppt_stable_4kmM3_201512_bil

# Combine climate data from library(prism)   

Strip off the last bit after the last underscore    

     scgl.temps$date <- sapply(scgl.temps$date, function(x){
       unlist(strsplit(x, "_\\s*(?=[^_]+$)", perl=TRUE))[[1]]
       })  
       
```{r, eval=FALSE}
scgl.climate <- rbind(do.call(rbind, m.tmin), 
                    do.call(rbind, m.scalevalue_tmax),
                    do.call(rbind, m.ppt2))

save(scgl.climate, file=paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"climate.Rdata", sep=""))

```



###### Load once made
```{r}
load(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"climate.Rdata", sep=""))


scgl.climate$NS <- "S. dawsonii"
southsites <- c("Bridgeport","Escalante Canyon","Picnic Site","Powerline","Fram")
scgl.climate$NS[scgl.climate$Site %in% southsites] <- "S. glaucus"

scgl.climate.monthly <- scgl.climate %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to May survey)
         Prev12 = ifelse(Month > 5, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1,2,12) ~ "winter",
                            Month>5 & Month<9 ~ "summer",
                            Month>8 & Month<12 ~ "fall",
                            Month>2 & Month<6 ~ "spring"))

scgl.c <- scgl.climate.monthly %>%
  pivot_wider(names_from = Variable, values_from = data)

scgl.climate.season.ppt <- scgl.climate.monthly %>%
  filter(Variable == "ppt") %>%
  group_by(Variable, Site, NS, season, Prev12) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep") 
  

scgl.climate.season.temp <- scgl.climate.monthly %>%
  filter(Variable != "ppt") %>%
  group_by(Variable, Site, NS, season, Prev12) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")
  
scgl.season <- bind_rows(list(scgl.climate.season.ppt, scgl.climate.season.temp))
scgl.season.wide <- scgl.season %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value)

scgl.annual.ppt <- scgl.climate.monthly %>%
  filter(Variable == "ppt") %>%
  group_by(Variable, Site, NS, Prev12) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")
  
scgl.annual.temp <- scgl.climate.monthly %>%
  filter(Variable != "ppt") %>%
  group_by(Variable, Site, NS, Prev12) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")

scgl.annual <- scgl.annual.ppt %>%
  bind_rows(scgl.annual.temp)
# do.call(rbind, list(as.data.frame(scgl.annual.ppt),
#                     as.data.frame(scgl.annual.temp)))

scgl.annual %>%
  filter(Prev12 < (currentYr + 1)) %>%
  group_by(Variable) %>%
  mutate(scalevalue = scale(Value)) %>%
ggplot(  aes(Prev12, scalevalue, colour = Site))+
  geom_point(position = position_dodge(width = 0.05))+
  stat_smooth(method = "lm", se = TRUE, position = position_dodge(width = 0.05))+
  facet_grid(Variable ~ NS, scales = "free")+
  theme_bw()

## a column for each variable instead of long
scgl.annual.wide <- scgl.annual %>%
  filter(Prev12 < (currentYr + 1)) %>%
  group_by(Variable) %>%
  mutate(scalevalue = scale(Value)[,1]) %>%
  pivot_wider(names_from = Variable, values_from = c(Value,scalevalue)) 
```

scgl.c is now:
> scgl.c
# A tibble: 4,370 x 8
   Site              Year Month Prev12 season  tmin  scalevalue_tmax   ppt
   <chr>            <dbl> <dbl>  <dbl> <chr>  <dbl> <dbl> <dbl>
 1 Atwell Gulch      2021    12   2022 winter -5.86  5.79  37.3
 2 Bridgeport        2021    12   2022 winter -5.45  6.85  31.5
 3 Escalante Canyon  2021    12   2022 winter -4.90  6.13  28.5
 4 Fram              2021    12   2022 winter -4.38  6.59  30.2
 5 Oil Pad           2021    12   2022 winter -4.68  5.34  39.2
 6 Picnic Site       2021    12   2022 winter -4.90  6.13  28.5
 7 Pond              2021    12   2022 winter -5.69  5.08  47.8
 8 Powerline         2021    12   2022 winter -6.19  7.32  15.3
 9 Pyramid Rock      2021    12   2022 winter -5.19  5.83  29.4

Pre 2022 dplyr/tidyr version:
          Site Precip  tmin scalevalue_tmax Year Month Prev12 season
1 Atwell Gulch  54.37 -10.1  2.0 1895     1   1895 winter
2 Atwell Gulch  26.50 -10.0  4.0 1895     2   1895 winter
3 Atwell Gulch  23.35  -4.1 11.1 1895     3   1895 spring
4 Atwell Gulch  12.97   0.5 19.3 1895     4   1895 spring
5 Atwell Gulch  31.98   4.9 23.5 1895     5   1895 spring
6 Atwell Gulch  19.17   7.4 26.8 1895     6   1896 summer
> names(scgl.c)
[1] "Site"   "Precip" "tmin"   "scalevalue_tmax"   "Year"   "Month"  "Prev12" "season"

####Summarize climate data
Climate of the previous 12 month to the May data collection

###PCA for climate factors
calculate seasonal climate averages    
summer: June-August (6-8)
fall: September-November (9-11)
winter: December-February (12, 1-2)
spring: March-May (3-5)

#### Figure 2: a) Number of Sclerocactus glaucus individuals per square meter in the northern genetic region (North) and the southern genetic region (South), and b) Average size of individuals per site. 

# Results: Reproduction
```{r}
sg_season <- merge(sg, scgl.season.wide, by.x = c("Year","Site","NS"), by.y = c("Prev12","Site","NS"))
sg_annual <- merge(sg, scgl.annual.wide, by.x = c("Year","Site","NS"), by.y = c("Prev12","Site","NS"))
scgl_season <- merge(sg_sum, scgl.season.wide, 
                     by.x = c("Year","Site","NS"), by.y = c("Prev12","Site","NS")) %>%
  filter(!is.na(medianH))


#Reproductive individuals with average width of plants
#See also "#Reproduction" below; should match this
summary(lm(PRep~medianW * NS, data=scgl_season))
ggplot(scgl_season, aes(medianW, PRep, color = NS)) +
  geom_point()+
  stat_smooth(method = "lm") +
  theme_bw()

summary(glm(Fl~Width.cm. * NS, data = sg_season, family = binomial(link = "logit")))
ggplot(sg_season, aes(Width.cm., Fl, color = NS))+
  geom_point()+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  theme_bw()


```



# AICc climate and width on Reproduction Y/N
```{r}
head(sg_season)
head(sg_annual)

sg_season_scaled <- sg_season %>%
  dplyr::mutate(across(ppt_fall:tmin_winter, scale)) %>%
  mutate(Br = as.factor(Br),
         NS = as.factor(NS))

## Alredy scaled: scalevalue_ppt, scalevalue_tmax, and tmin
# sg_annual_scaled <- sg_annual %>%
#   dplyr::mutate(across(ppt:tmin, scale)) %>%
#   mutate(Br = as.factor(Br),
#          NS = as.factor(NS))

## If browsed, need to be larger to flower
brflowered <- sg_season %>%
  filter(!is.na(Fl)) %>%
  ggplot(   aes(Width.cm., as.numeric(Fl), colour = as.factor(Br)))+
  geom_point()+
  facet_wrap(~NS)+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  theme_bw()+
  ylab("Vegetative (0) or Reproductive (1)")+
  xlab("Size (width cm)")+
  scale_color_manual("Browsed", values = c("dodgerblue3","goldenrod2"))

## if browsed then more likely to flower as more precipitation in previous winter
sg_season %>%
  filter(!is.na(Fl)) %>%
  mutate(Br = as.factor(Br)) %>%
ggplot(    aes(ppt_winter, as.numeric(Fl), colour = Br))+
  geom_point()+
  facet_wrap(~NS)+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  theme_bw()+
  ylab("Vegetative (0) or Reproductive (1)")+
  xlab("Winter precipitation")+
  scale_color_manual("Browsed", values = c("dodgerblue3","goldenrod2"))

sg_season %>%
  filter(!is.na(Fl)) %>%
  mutate(Br = as.factor(Br)) %>%
ggplot(  aes(ppt_winter, Fl, colour = NS))+
  geom_point()+
  theme_bw()+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)

sg_annual %>%
  filter(!is.na(Fl)) %>%
  mutate(Br = as.factor(Br)) %>%
ggplot(  aes(scalevalue_ppt, Fl, colour = NS))+
  geom_point()+
  theme_bw()+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)

sg_season %>%
  filter(!is.na(Fl)) %>%
  mutate(Br = as.factor(Br)) %>%
ggplot(  aes(tmin_spring, Fl, colour = NS))+
  geom_point()+
  theme_bw()+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)

sg_annual %>%
  filter(!is.na(Fl)) %>%
  mutate(Br = as.factor(Br)) %>%
ggplot(  aes(scalevalue_tmin, Fl, colour = NS))+
  geom_point()+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE) +
  theme_bw()
```  

Survival - need merge year to year like what I made for Dan Doak but add a survived or not
```{r}
sg_annual_scaled_merged <- sg_annual %>%
  group_by(Site, SiteSame, NS, Transect, Tag, Year) %>%
  left_join(sg.new, by = c("Site","SiteSame","NS","Tag","Transect")) %>%
  dplyr::select(Year.x:Transect, Width.cm..x:Minis.x, FlNum:Year.y, Width.cm..y:Minis.y) %>%
  filter(Year.x == Year.y-1) %>%
  filter(Width.cm..x != 0) %>%
  mutate(surv = ifelse(Width.cm..y ==0, 0,1))%>%
  mutate(Br.x = as.factor(Br.x))


ggplot(sg_annual_scaled_merged ,  aes(Width.cm..x, surv, color = Br.x))+
  geom_point(pch="|")+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  facet_grid(~NS)+
  theme_light()+
  scale_color_manual("Browsed", values = c("dodgerblue3","goldenrod2"))

## too much precip decreases survival, but only among not browsed
ggplot(sg_annual_scaled_merged, aes(scalevalue_ppt, surv, color = Br.x))+
  geom_point(pch="|")+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  facet_grid(~NS)+
  theme_light()+
  scale_color_manual("Browsed", values = c("dodgerblue3","goldenrod2"))

ggplot(sg_annual_scaled_merged, aes(scalevalue_scalevalue_tmax, surv, color = Br.x))+
  geom_point(pch="|")+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  facet_grid(~NS)+
  theme_light()+
  scale_color_manual("Browsed", values = c("dodgerblue3","goldenrod2"))

ggplot(sg_annual_scaled_merged, aes(scalevalue_tmin, surv, color = Br.x))+
  geom_point(pch="|")+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  facet_grid(~NS)+
  theme_light()+
  scale_color_manual("Browsed", values = c("dodgerblue3","goldenrod2"))

```


```{r}

## The effect of browsing is strongly correlated with width (-0,939) from the correlation of fixed effects. 
lm1 <- glmer(surv~ Width.cm..x * Br.x + scalevalue_ppt + scalevalue_tmin + (1|NS), data = sg_annual_scaled_merged,
             family = binomial) 
lm2 <- glmer(surv~ Width.cm..x * Br.x + (1|NS), data = sg_annual_scaled_merged,
             family = binomial) 
lm3 <- glmer(surv~ (Width.cm..x + Br.x + scalevalue_tmin)^2 + (1|NS), data = sg_annual_scaled_merged,
             family = binomial) 
lm4 <- glmer(surv~ Width.cm..x + Br.x + scalevalue_ppt + (1|NS), data = sg_annual_scaled_merged,
             family = binomial) 
lm5 <- glmer(surv~ Width.cm..x + Br.x + scalevalue_ppt + scalevalue_tmin +
             (1|NS), data = sg_annual_scaled_merged,
             family = binomial) 
lm6 <- glmer(surv~ Width.cm..x + scalevalue_ppt + (1|NS), data = sg_annual_scaled_merged,
             family = binomial)  
lm7 <- glmer(surv~ Width.cm..x + scalevalue_tmin + (1|NS), data = sg_annual_scaled_merged,
             family = binomial)  
lm8 <- glmer(surv~ Br.x + scalevalue_ppt + (1|NS), data = sg_annual_scaled_merged,
             family = binomial) 
lm9 <- glmer(surv ~ Width.cm..x + (1|NS), data = sg_annual_scaled_merged,
             family = binomial)
lm10 <- glmer(surv ~ 1 + (1|NS), data = sg_annual_scaled_merged,
             family = binomial)

lm.list <- list(lm1,lm2, #lm3, 
                lm4, lm5, lm6, # lm7, 
                lm9, lm10) #, lm10)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

### color = Br, x = size, y = prob flower, facet for scalevalue_tmin and scalevalue_ppt ~ NS 
p1a <- sg_annual_scaled_merged %>%
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
  dplyr::mutate(scalevalue_pptbin = cut(scalevalue_ppt, 
                              breaks = c(min(scalevalue_ppt)-0.1, mean(scalevalue_ppt), max(scalevalue_ppt)+0.1),
                              labels = FALSE)) %>%
  ggplot(  aes(Width.cm..x,surv, color = as.factor(Br.x)))+
     geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
    facet_grid(NS~tempbin+scalevalue_pptbin, 
               labeller = labeller(tempbin = as_labeller(c("1" = "<= mean min temp",
                                "2" = "> mean min temp")),
                    scalevalue_pptbin = as_labeller(c("1" = "<= mean scalevalue_ppt", "2" = "> mean scalevalue_ppt")),
                    NS = as_labeller(c("S. glaucus" = expression(italic(S.~glaucus)),
                                       "S. dawsonii" = expression(italic(S.~dawsonii))))))+
    theme_light()+
    scale_color_manual("Browse/\nDamage", values = c("deepskyblue","deeppink4"),
                         labels = c("Unbrowsed","Browsed"))+
    ylab("Survival")+
    xlab("Size (width cm)")+
  ggtitle("a)")

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig_Survival.jpg", sep=""),p1a, width = 200, height = 110, units = 'mm', dpi=300)

```

```{r}
p1 <- sg_annual_scaled_merged %>%
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
  dplyr::mutate(pptbin = cut(ppt, 
                              breaks = c(min(ppt)-0.1, mean(ppt), max(ppt)+0.1),
                              labels = FALSE)) %>%
  ggplot(  aes(ppt,surv, color = as.factor(tempbin)))+
     geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
  facet_wrap(~NS)+
    theme_light()+
    scale_color_manual("Temperature", values = c("deepskyblue","deeppink4"),  # Minimum\nTemperature
                         labels = c("1" = "<= mean\nmin temp", "2" = "> mean\nmin temp"))+
    ylab("Survival")+
    xlab("Precipitation")+
  ggtitle("b)")

p2 <- sg_annual_scaled_merged %>%
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
  dplyr::mutate(pptbin = cut(ppt, 
                              breaks = c(min(ppt)-0.1, mean(ppt), max(ppt)+0.1),
                              labels = FALSE)) %>%
  ggplot(  aes(scalevalue_tmin,surv, color = as.factor(pptbin)))+
     geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
  facet_wrap(~NS)+
    theme_light()+
    scale_color_manual("Precipitation", values = c("deepskyblue","deeppink4"),
                         labels = c("1" = "<= mean\nppt", "2" = "> mean\nppt"))+
    ylab("Survival")+
    xlab("Minimum Temperature")+
  ggtitle("c)")

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig4_SurvBrscalevalue_tminPPT.jpg", sep=""),
       p1a  /(p1 + p2), width = 300, height = 200, units = 'mm', dpi=300) 
     
```



Annual instead of seasonal
```{r}
## If used weights should be scaled such that sum(weights) corresponds to number of independent observations
sg_annual <- sg_annual %>%
  mutate(Br = as.factor(Br))

lm1 <- glmer(Fl~ Width.cm. * Br + scalevalue_ppt +scalevalue_tmin + (1|NS), data = sg_annual,
             family = binomial) 
lm2 <- glmer(Fl~ Width.cm. * Br + (1|NS), data = sg_annual,
             family = binomial) 
lm3 <- glmer(Fl~ (Width.cm. + Br + scalevalue_tmin)^2 + (1|NS), data = sg_annual,
             family = binomial) 
lm4 <- glmer(Fl~ Width.cm. + Br + scalevalue_ppt + (1|NS), data = sg_annual,
             family = binomial) 
lm5 <- glmer(Fl~ Width.cm. + Br + scalevalue_ppt + scalevalue_tmin +
             (1|NS), data = sg_annual,
             family = binomial)
lm6 <- glmer(Fl~ Width.cm. + scalevalue_ppt + (1|NS), data = sg_annual,
             family = binomial)  
lm7 <- glmer(Fl~ Width.cm. + scalevalue_tmin + (1|NS), data = sg_annual,
             family = binomial)  
lm8 <- glmer(Fl~ (Width.cm. + Br + scalevalue_ppt)^2 + (1|NS), data = sg_annual,
             family = binomial)
lm9 <- glmer(Fl ~ Width.cm. + (1|NS), data = sg_annual,
             family = binomial)
lm10 <- glmer(Fl ~ 1 + (1|NS), data = sg_annual,
             family = binomial)

lm.list <- list(lm1,lm2, #lm3, 
                lm4, lm5, lm6, lm7, lm9) #, lm10)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

# more percent reproductive with avg width
summary(lm1)
# sjPlot::plot_model(lm1, type = "est", show.data = T)

sg_annual %>%
  mutate(Br = as.numeric(Br)-1) %>%
  filter(!is.na(Fl)) %>%
ggplot( aes(Width.cm., Br, colour = as.factor(Fl)))+
  geom_point()+ 
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE)

sg_annual %>%
  filter(!is.na(Fl)) %>%
ggplot(aes(Width.cm., Fl, colour = as.factor(Br)))+
  geom_point() +
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = FALSE) +
  facet_wrap(~ NS)

sg_annual %>%
  filter(!is.na(Fl)) %>%
  filter(!is.na(Width.cm.)) %>%
  filter(Width.cm. != 0) %>% # dead
  group_by(NS) %>%
  # based on the minimum size when the species typically can become reproductive
  mutate(SizeClass = ifelse(NS == "S. dawsonii",
                            cut(Width.cm., breaks=c(0,3.04,max(Width.cm.))),
                            cut(Width.cm., breaks=c(0,2.28,max(Width.cm.))))) %>%
  filter(SizeClass == 2) %>%
ggplot(aes(scalevalue_tmin, Fl, colour = Br))+
  geom_point(pch="|") +
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"), 
    se = TRUE)+
  facet_grid(~NS, scales = "free")+
  theme_light()+
  scale_color_manual("Browse/\nDamage", values = c("deepskyblue","deeppink4"))+
  ylab("Probability of Reproduction")+
  xlab("Minimum annual temperature")

scalevalue_tminlabs <- c("0" = "No browse/damage",
              "1" = "Browse/damage")

sg_annual %>%
  filter(!is.na(Fl)) %>% # not dead
  filter(!is.na(Width.cm.)) %>%
  filter(Width.cm. != 0) %>% # dead
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
    ggplot(  aes(Width.cm., Fl, color = as.factor(tempbin)))+
      geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
      facet_grid(NS~Br, labeller = labeller(Br = as_labeller(c("0" = "No browse/damage",
                                                       "1" = "Browse/damage")),
                      NS = as_labeller(c("S. glaucus" = expression(italic(S.~glaucus)),
                                         "S. dawsonii" = expression(italic(S.~dawsonii))))))+
      theme_light()+
      # scale_color_manual("Browse/\nDamage", values = c("deepskyblue","deeppink4"))+
      scale_color_manual("Min Temp", values = c("deepskyblue","deeppink4"),
                         labels = c("< mean","> mean"))+
  ylab("Probability of Reproduction")+
  xlab("Size (width cm)")


### color = Br, x = size, y = prob flower, facet for scalevalue_tmin and ppt ~ NS 
flpl1 <- sg_annual %>%
  filter(!is.na(Fl)) %>% # not dead
  filter(!is.na(Width.cm.)) %>%
  filter(Width.cm. != 0) %>% # dead
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
  dplyr::mutate(pptbin = cut(scalevalue_ppt, 
                              breaks = c(min(scalevalue_ppt)-0.1, mean(scalevalue_ppt), max(scalevalue_ppt)+0.1),
                              labels = FALSE)) %>%
  ggplot(  aes(Width.cm.,Fl, color = as.factor(Br)))+
     geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
    facet_grid(NS~tempbin+pptbin, 
               labeller = labeller(tempbin = as_labeller(c("1" = "<= mean min temp",
                                "2" = "> mean min temp")),
                    pptbin = as_labeller(c("1" = "<= mean ppt", "2" = "> mean ppt")),
                    NS = as_labeller(c("S. glaucus" = expression(italic(S.~glaucus)),
                                       "S. dawsonii" = expression(italic(S.~dawsonii))))))+
    theme_light()+
    scale_color_manual("Browse/\nDamage", values = c("deepskyblue","deeppink4"),
                         labels = c("Unbrowsed","Browsed"))+
    ylab("Probability of Reproduction")+
    xlab("Size (width cm)")+
  ggtitle("a)")


flp1 <- sg_annual %>%
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
  dplyr::mutate(pptbin = cut(scalevalue_ppt, 
                              breaks = c(min(scalevalue_ppt)-0.1, mean(scalevalue_ppt), max(scalevalue_ppt)+0.1),
                              labels = FALSE)) %>%
  ggplot(  aes(Width.cm.,Fl, color = as.factor(tempbin)))+
     geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
  facet_grid(NS~pptbin, labeller = labeller(pptbin = as_labeller(c("1"= "<= mean ppt",
                                                                   "2" = "> mean ppt"))))+
    theme_light()+
    scale_color_manual("Temperature", values = c("deepskyblue","deeppink4"),
                         labels = c("1" = "<= mean\nmin temp", "2" = "> mean\nmin temp"))+
    ylab("Probability of Reproduction")+
    xlab("Size (width cm)")+
  ggtitle("b)")

flp2 <- sg_annual %>%
  group_by(NS) %>%
  dplyr::mutate(tempbin = cut(scalevalue_tmin, 
                              breaks = c(min(scalevalue_tmin)-0.1, mean(scalevalue_tmin), max(scalevalue_tmin)+0.1),
                              labels = FALSE)) %>%
  dplyr::mutate(pptbin = cut(scalevalue_ppt, 
                              breaks = c(min(scalevalue_ppt)-0.1, mean(scalevalue_ppt), max(scalevalue_ppt)+0.1),
                              labels = FALSE)) %>%
  ggplot(  aes(Width.cm.,Fl, color = as.factor(pptbin)))+
     geom_point(pch = "|")+ ## mimic a rug plot
      geom_smooth(method = "glm",
                  method.args = list(family = "binomial"), se=TRUE)+
  facet_grid(NS~tempbin, labeller = labeller(tempbin = as_labeller(c("1"= "<= mean min temp",
                                                                   "2" = "> mean min temp"))))+
    theme_light()+
    scale_color_manual("Precipitation", values = c("deepskyblue","deeppink4"),
                         labels = c("1" = "<= mean\nppt", "2" = "> mean\nppt"))+
    ylab("Probability of Reproduction")+
    xlab("Minimum Temperature")+
  ggtitle("c)")

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig5_ProbofReproductive.jpg", sep=""),
       flpl1 / (flp1 + flp2), width = 300, height = 200, units = 'mm', dpi=300)

# sjPlot::plot_model(lm1, type = "est")
# sjplot1 <- sjPlot::plot_model(lm1, type = "pred",
#                               title = "",
#                             # axis.labels = c("Size (width cm)","Probability of Reproduction"),
#                               # mdrt.values = "meansd",
#                    terms = c("Width.cm.[all]","Br[all]","ppt[meansd]","scalevalue_tmin[meansd]"))
# 
# sjplot1
```

# What describes reproduction
### Is percent reproductive explained by climate variables?   
Figure 5 (was figure 4 before adding survival interaction plots)   
```{r, eval=FALSE}
# +ppt.spring +scalevalue_tmax.spring +ppt.summer+ ppt.winter+ scalevalue_tmax.winter

# lm10 <- glm(Prepro~medianW*data.ppt,
#             family = "binomial", sg_sum, weights = X)
# lm11 <- glm(Prepro~medianW*data.ppt*data.scalevalue_tmax,
#             family = "binomial", sg_sum, weights = X)
# lm12 <- glm(Prepro~medianW*data.scalevalue_tmin,
#             family = "binomial", sg_sum, weights = X)
# lm13 <- glm(Prepro~medianW*data.scalevalue_tmin*data.ppt,
#             family = "binomial", sg_sum, weights = X)
#   # lm1 <- glm(Prepro~medianW*data.scalevalue_tmin*data.scalevalue_tmax*data.ppt,
#   #          family = "binomial", sg_sum, weights = X)
# lm2 <- glm(Prepro~medianW*data.scalevalue_tmax, 
#            family = "binomial",sg_sum, weights = X)
# lm3 <- glm(Prepro~NS*medianW*data.ppt,
#             family = "binomial", sg_sum, weights = X)
# 
# #######################################################
# lm4 <- glm(Prepro~NS*medianW*data.scalevalue_tmax*data.ppt,
#             family = "binomial", sg_sum, weights = X)
# lm6 <- glm(Prepro~NS*medianW*data.scalevalue_tmin*data.ppt,
#             family = "binomial", sg_sum, weights = X)
# #######################################################
# 
# lm5 <- glm(Prepro~NS*medianW*data.scalevalue_tmin,
#             family = "binomial", sg_sum, weights = X)
#   # lm7 <- glm(Prepro~NS*medianW*data.scalevalue_tmin*data.scalevalue_tmax*data.ppt,
#   #          family = "binomial", sg_sum, weights = X)
# lm8 <- glm(Prepro~NS*medianW*data.scalevalue_tmax, 
#            family = "binomial",sg_sum, weights = X)
# 
# # lm1,lm7,
# lm.list <- list(lm2,lm3,lm4,lm5,lm6,lm8, lm10,lm11,lm12,lm13)
# lm.names <- as.character(unlist(lapply(lm.list,formula)))
# (lm.results <- aictab(lm.list, modnames=lm.names))
# print(evidence(aic.table = lm.results),
#       digits = 2)
# #evidence ratio 
# for(i in 2:length(lm.list)){
#   print(exp(0.5*lm.results$Delta_AICc[i]))
# }
# 
# # more percent reproductive with avg width
# ### Best are 4 and 6
# effectsize::standardize(lm6) %>% summary()
# effectsize::standardize(lm4) %>% summary()
# 
# sjPlot::plot_model(lm6, type = "eff", show.data = T) 
## meansd : mean value +/- one SD
# "int" for continuous variables the min and max are chosen as grouping levels
```

```{r}

sjPlot::set_theme(base = theme_bw())


p2 <- sjPlot::plot_model(lm4, type = "int", mdrt.values = "meansd")
 # sjPlot::plot_model(lm4, type = "int",  mdrt.values = "meansd")
                    # terms = c("medianW [all]", "data.ppt [meansd]","data.scalevalue_tmax [meansd]")) 
p1 <- sjPlot::plot_model(lm6, type = "int", mdrt.values = "meansd")
## Change facet order to mean-SD, mean, mean+SD
for(i in 1:3){
  p1[[11]][[i]]$data$facet <- factor(p1[[11]][[i]]$data$facet,
                                      levels = c(levels(p1[[11]][[i]]$data$facet)[2],
                                                 levels(p1[[11]][[i]]$data$facet)[1],
                                                 levels(p1[[11]][[i]]$data$facet)[3]))
  ## Change facet labels
  levels(p1[[11]][[i]]$data$facet) <- gsub(pattern = "data.scalevalue_tmin", 
                                            replacement = "Min Temp",
                                            levels(p1[[11]][[i]]$data$facet) )
}

p1[[11]][[1]]$labels$title <- gsub("Prepro", "\n% reproduction", p1[[11]][[1]]$labels$title)

for(i in 1:3){
  p1[[11]][[i]]$labels$subtitle <- gsub("data.ppt","ppt", p1[[11]][[i]]$labels$subtitle)
}

p1[[11]][[1]]$labels$y <- "Probability of Reproduction"
for(i in 2:3){
  p1[[11]][[i]]$labels$y <- ""
}


# No size but region, ppt, and scalevalue_tmin
# Facet order
p1[[9]]$data$facet <- factor(p1[[9]]$data$facet,
                                    levels = c(levels(p1[[9]]$data$facet)[2],
                                               levels(p1[[9]]$data$facet)[1],
                                               levels(p1[[9]]$data$facet)[3]))
## Change facet labels
levels(p1[[9]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p1[[9]]$data$facet) )

p2[[9]]$data$facet <- factor(p2[[9]]$data$facet,
                                    levels = c(levels(p2[[9]]$data$facet)[2],
                                               levels(p2[[9]]$data$facet)[1],
                                               levels(p2[[9]]$data$facet)[3]))
## Change facet labels
levels(p2[[9]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p2[[9]]$data$facet) )


p1[[8]]$data$facet <- factor(p1[[8]]$data$facet,
                                    levels = c(levels(p1[[8]]$data$facet)[2],
                                               levels(p1[[8]]$data$facet)[1],
                                               levels(p1[[8]]$data$facet)[3]))
## Change facet labels
levels(p1[[8]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p1[[8]]$data$facet) )

# Fig4_a_reproduction <- p1[[8]]+
#   # ggtitle("Predicted probablities of % reproduction")+
#   ggtitle("a)")+
#   scale_colour_discrete("Size")+
#   xlab("Region")+
#   ylab("% reproduction")+
#   theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1))
## For other competitive model lm4
## Change facet order to mean-SD, mean, mean+SD
for(i in 1:3){
  p2[[11]][[i]]$data$facet <- factor(p2[[11]][[i]]$data$facet,
                                      levels = c(levels(p2[[11]][[i]]$data$facet)[2],
                                                 levels(p2[[11]][[i]]$data$facet)[1],
                                                 levels(p2[[11]][[i]]$data$facet)[3]))
## Change facet labels
  levels(p2[[11]][[i]]$data$facet) <- gsub(pattern = "data.scalevalue_tmax", 
                                            replacement = "Max Temp",
                                            levels(p2[[11]][[i]]$data$facet) )
}

p2[[11]][[1]]$labels$title <- gsub("Prepro", "\n% reproduction", p2[[11]][[1]]$labels$title)

for(i in 1:3){
  p2[[11]][[i]]$labels$subtitle <- gsub("data.ppt","ppt", p2[[11]][[i]]$labels$subtitle)
}

p2[[11]][[1]]$labels$y <- "Probability of Reproduction"
for(i in 2:3){
  p2[[11]][[i]]$labels$y <- ""
}

  
```

```{r, eval=FALSE}
## Break it down into parts lm6 tmin
p1[[11]]$labels$colour <- "Size"
p2[[11]]$labels$colour <- "Size"

Fig4_b_reproduction <- p1[[9]]+
  # ggtitle("Predicted probablities of % reproduction")+
  ggtitle("c)")+
  scale_colour_discrete("Min Temp")+
  xlab("Region")+
  ylab("% reproduction")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

Fig5_repro_max <- p2[[9]]+
  scale_colour_discrete("Max Temp")+
  xlab("Region")+
  ggtitle("d)")+
  ylab("% reproduction")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



all2 <- p1[[11]][[1]]+
  ylab("")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p1[[11]][[1]]$labels$subtitle))+
  ggtitle("")+
  ylim(c(0.2,0.84))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all1 <- p1[[11]][[2]]+
  ylab("% reproductive")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p1[[11]][[2]]$labels$subtitle))+
  ggtitle("a)")+
  ylim(c(0.2,0.84))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all3 <- p1[[11]][[3]]+
  ylab("")+
  xlab("")+
  ylim(c(0.2,0.84))+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p1[[11]][[3]]$labels$subtitle))+
  # scale_color_discrete("Size")+
  ggtitle("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

all2max <- p2[[11]][[1]]+
  ylab("")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p2[[11]][[1]]$labels$subtitle))+
  ggtitle("")+
  ylim(c(0.2,0.81))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all1max <- p2[[11]][[2]]+
  ylab("% reproductive")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p2[[11]][[2]]$labels$subtitle))+
  ggtitle("b)")+
  ylim(c(0.2,0.81))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
all3max <- p2[[11]][[3]]+
  ylab("")+
  xlab("Region")+
  labs(title = "", subtitle = gsub("ppt","Annual precipitation",p2[[11]][[3]]$labels$subtitle))+
  # scale_color_discrete("Size")+â•œ
  ggtitle("")+
  ylim(c(0.2,0.81))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig5_percReproductive.jpg", sep=""),
       (all1 + all2 + all3)/
        (all1max + all2max + all3max)/
         (Fig4_b_reproduction  + Fig5_repro_max),
       # Fig4_a_reproduction/Fig4_b_reproduction/Fig4_b_reproduction_lm4,
width = 330, height = 210, units = 'mm', dpi=300)

```



```{r}

# Facet order
p2[[9]]$data$facet <- factor(p2[[9]]$data$facet,
                                    levels = c(levels(p2[[9]]$data$facet)[2],
                                               levels(p2[[9]]$data$facet)[1],
                                               levels(p2[[9]]$data$facet)[3]))
## Change facet labels
levels(p2[[9]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p2[[9]]$data$facet) )

Fig4_b_reproduction_lm4 <- p2[[9]]+
  # ggtitle("Predicted probablities of % reproduction")+
  ggtitle("c)")+
  scale_colour_discrete("Max Temp")+
  xlab("Region")+
  ylab("% reproduction")

p2[[8]]$data$facet <- factor(p2[[8]]$data$facet,
                                    levels = c(levels(p2[[8]]$data$facet)[2],
                                               levels(p2[[8]]$data$facet)[1],
                                               levels(p2[[8]]$data$facet)[3]))
  ## Change facet labels
levels(p2[[8]]$data$facet) <- gsub(pattern = "data.ppt", 
                                          replacement = "ppt",
                                          levels(p2[[8]]$data$facet) )

Fig4_a_reproduction_lm4 <- p2[[8]]+
  # ggtitle("Predicted probablities of % reproduction")+
  ggtitle("c)")+
  scale_colour_discrete("Size")+
  xlab("Region")+
  ylab("% reproduction")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1))


sjPlot::plot_model(lm6, type = "est", show.values = T, transform = NULL)
sjPlot::plot_model(lm4, type = "est", show.values = TRUE, transform = NULL)

## Change names of coefficients in Predictors column
sjPlot::tab_model(lm6, transform = NULL,   # estimates on linear scale
                  # pred.labels = c("Intercept", "size", "min temp","ppt",
                  #                 "region:size","region:min temp","size:Max Temp","ppt:max temp",
                  #                 "size:ppt:max temp"),
                  string.ci = "CI (95%)",
                  string.p = "p-value",
                  show.reflvl = TRUE)  # show reference level for categorical (none here)

```



Figure 3a Number of Sclerocactus glaucus
```{r Figure remove pond}

Fig3a <- ggplot(sg_sum,aes(Year, X/area, colour = Site)) +
  geom_line() +
  geom_point() +
  ggtitle("a)")+
  facet_wrap(~NS + SiteSame, ncol = 5, scales = "free_y") +
  # ggh4x::facet_grid2(NS ~ SiteSame, scales = "free_y", independent = "y")+ ## not quite, don't need ggh4x
  ylab("Individuals per square meter") +
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  theme_bw()+
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))

```


######################################################################################

# 2021 ESA SSA delisting recommendation. Density across south and north for BLM
```{r}

ggplot(sg_sum, aes(Density, SiteSame, fill = NS))+
  geom_boxplot() 

write.csv(sg_sum, paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/ScGl_density.csv", sep=""))
```



####Figure 6: The plot design for four ScGl sites were changed in 2012...   
```{r}
# old and new
oldnew <- c("Oil","Pond","T-","Atwell")

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig6.jpg", sep=""),

ggplot(sg_sum[sg_sum$Site %in% unique(grep(paste(oldnew,collapse="|"),
                   sg_sum$Site, value=TRUE)),], aes(Year,X,colour=Site))+
  geom_point()+
  geom_line()+
  ylab("Total individuals") +
  facet_wrap(~SiteSame)+
  theme_bw()+
  scale_x_continuous(breaks = seq(2009, currentYr, 2)),

 width=200, height=125, units="mm", dpi=300)


```

#Reproduction   

Density dependence? 
```{r}
## t = y, t+1 = x
sg_lagged <- subset(merge(sg_sum, sg_sum, by = c("Site")), Year.x == Year.y + 1)

## Really want growth rate on Y as a function of density
ggplot(sg_lagged, aes(X.y, X.x))+
  geom_point()+
  stat_smooth()

```



### Figure 3b
```{r}
Fig3b <- ggplot(sg_sum,aes(Year,avgVol,colour=Site))+
  geom_line()+
  geom_point()+
  ggtitle("b)")+
  facet_wrap(~NS + SiteSame, ncol =5)+
  ylab("Average volume")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()
```


Figure 3c
```{r}
#Minis

minis <- aggregate(sg$Minis, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(minis) <- c("Site","Year","Minis")

minisXsize <- aggregate(Width.cm. ~ Site + Year,
                        data = sg[sg$Width.cm.<0.5 & sg$Width.cm.>0 & !is.na(sg$Width.cm.),], function(x) length(x))
minis <- merge(minis, minisXsize, by = c("Site","Year"), all = TRUE)

minis$TotMinis <- rowSums(minis[,3:4],na.rm = TRUE)

repro <- aggregate(sg$Fl, by = list(sg$Site, sg$Year), function(x) sum(x, na.rm = TRUE))
names(repro) <- c("Site","Year","Reproductive")
minis.p.repro <- merge(minis,repro, by = c("Site","Year"))
## Should be year1 repro to how many minis year2
minis.repro <- subset(merge(minis.p.repro,minis.p.repro, by = "Site", sort = FALSE), Year.x == Year.y-1)
minis.repro$MiniXRepro <- minis.repro$TotMinis.y/minis.repro$Reproductive.x

sg[sg$Minis>20 & !is.na(sg$Minis),]

#Minis per reproductive plant  # [!(minis.repro$Site %in% "old"),]
ggplot(minis.repro, aes(Year.y, MiniXRepro, colour = Site))+
  geom_line()+
  scale_x_continuous(breaks = min(minis.repro$Year.y):max(minis.repro$Year.y))+
  xlab("Year")+
  ylab("Recruitment per reproductive individuals")
  

sgminis <- merge(sg_sum, minis.repro[,c(1,2,5:7,10,12)], by.x = c("Site","Year"),by.y = c("Site","Year.y"))

#want average minis per adult plant per site per year

ggplot(sg[sg$Minis>0,], aes(Year, Minis, colour = Site, group = Year))+
  geom_boxplot()+
  facet_wrap(~Site)

```

##FIGURE 3c
```{r}
Fig3c <- ggplot(sgminis, aes(Year, TotMinis.x,colour= Site))+
  geom_line()+
  geom_point()+
  ggtitle("c)")+
  facet_wrap(~NS + SiteSame, ncol =5)+ # , scales = "free_y"
  ylab("Total seedlings (< 0.5cm width)")+
  theme(axis.text.x = element_text(angle = -90, vjust = .5, hjust = 1)) +
  scale_x_continuous(breaks = seq(2008, currentYr, 4))+
  scale_color_manual(values = c("#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#7171C6",
                                "#C67171","#C5C1AA","#8E8E38",
                                "#71C671","#388E8E","#7D9EC0","#8B0000"))+
  theme_bw()

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig3.jpg", sep=""),
Fig3a/Fig3b/Fig3c,
width=250, height=350, units="mm", dpi=300)

```

```{r}

summary(lm(X/area ~ avgVol*TotMinis.y, data=sgminis))

ggplot(sgminis, aes(TotMinis.y, X/area))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(sgminis, aes(Rep,TotMinis.y))+
  geom_point()+
  stat_smooth()

ggplot(sgminis, aes( (X/area),(TotMinis.y/Rep)))+
  geom_point()+
  stat_smooth(method="lm")
```



```{r}
par(cex=0.8)  
interaction.plot(sg_sum$Year, factor(sg_sum$Site), 
	as.numeric(sg_sum$X),
	ylab= expression(paste(italic("Sclerocactus glaucus")," individuals per sampling unit")), xlab="Year", 
	trace.label="Site",
	col=c(1:6,11,8:(nlevels(sg_sum$Site))))

```



### statistics
#PVA count based

```{r}
all.count <- lapply(unique(sg_sum$Site), function(x){
  CountPVA(sg_sum$Year[sg_sum$Site == x],sg_sum$X[sg_sum$Site == x])
  })

names(all.count) <- unique(sg_sum$Site)

```

# Demography survival
#how do climatic variables explain growth rates? 
cc.season.notcor are all variables not correlated 50% +
```{r}
lambdas <- do.call(rbind, lapply(all.count, '[[', 1))
lambdas$Site <- sub("\\.[0-9]","",row.names(lambdas)) #get rid of numbers following .

head(lambdas)
```

#### Demography   

```{r}

Fit.list <- lapply(all.count, '[[', 2) 

last.fit <- do.call(rbind,lapply(Fit.list, function(x){
  out <- exp(x[nrow(x),-c(1:3)])
  years <- x[nrow(x), 1:3]
  data.frame(years,out)
}))


fit.currentYr <- data.frame(Site = rownames(last.fit), last.fit)
plot.currentYr <- fit.currentYr %>%
  pivot_longer(cols = c(2,5:7), names_to = "variable", values_to = "value")

```

#Demography
#Lambdas by site
```{r}

southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
plot.currentYr$NS <- "S. dawsonii"
plot.currentYr$NS[plot.currentYr$Site %in% grep(paste(southsites,collapse="|"),
                                                plot.currentYr$Site, value=TRUE)] <- "S. glaucus"

#Average growth rate and CI for all sites
aggregate(value ~ variable, data = plot.currentYr, FUN= mean)

#Average growth rate and CI for south and north
aggregate(value ~ variable + NS, data = plot.currentYr, FUN= mean)

#Pyramid Rock growing?
plot.currentYr[plot.currentYr$Site == "Pyramid Rock",]

#Pond shrinking?
plot.currentYr[plot.currentYr$Site == "Pond",]

# Bridgeport and Powerline

plot.currentYr[plot.currentYr$Site == "Powerline",]

plot.currentYr[plot.currentYr$Site == "Bridgeport",]

plot.currentYr[plot.currentYr$Site == "Fram",]

```

#Figure 2: Lambda and 95% CI for each
```{r}
plot.noold <- plot.currentYr[!grepl("old", plot.currentYr$Site),]
plot.noold <- rbind(plot.noold, plot.currentYr[plot.currentYr$Site == "Atwell Gulch (old)",])

plot.countlambda <- plot.noold %>%
  pivot_wider(names_from = variable, values_from = value)

Fig2a <- ggplot(plot.countlambda, aes(Site, fit))+
  geom_hline(yintercept = 1, color = "grey50", linetype = "dashed")+
  geom_point() +
  theme_bw()+
  # scale_shape_manual(values = c("*","-","-"))+
  # scale_colour_manual(values=c("black","red", "red"))+
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = .5) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  guides(colour= "none", shape= "none", size = "none")+
  ylab(expression(lambda))+
  facet_grid(~NS, scales="free")+
  theme(strip.text = element_text(face = "italic"))+
  ggtitle("a)")


ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig2ab.jpg", sep=""),
       Fig2a/Fig2b,
width=200, height=250, units="mm", dpi=300)

```

Discussion, lambda patterns
```{r}
SiteSpecies <- sg %>%
  distinct(Site, NS)

fit.currentYr %>%
  left_join(SiteSpecies) %>%
  filter(RangeEnd %in% c(2022, currentYr)) %>%
  group_by(NS) %>%
  dplyr::summarise(mean = mean(fit),
                   sd = sd(fit),
                   hdi = )

fit.currentYr[fit.currentYr$lwr>1,]
fit.currentYr[fit.currentYr$upr<1,]

```


Plant size
## Figure 6
## Figure 5: Growth relationships between years for width (top) and height (bottom) for Sclerocactus glaucus individuals within demographic monitoring sites.    
6 rows of Road T-West that don't have a tag number, one row for Road T-East

```{r}
head(sg)
sg <- sg[!is.na(sg$Tag),]

sg.xy <- subset(merge(sg[,c(2:5,10:11)], sg[,c(2:5,10:11)], by=c("Site","Transect","Tag"),
                      sort=FALSE), Year.x == Year.y+1)
head(sg.xy)
sg.xy[is.na(sg.xy$Tag),]

southsites <- c("Bridgeport","Escalante","Picnic","Powerline","Fram")
sg.xy$NS <- "S. dawsonii"
sg.xy$NS[sg.xy$Site %in% grep(paste(southsites,collapse="|"),
                                                sg.xy$Site, value=TRUE)] <- "S. glaucus"
```

```{r}


ggheight <- ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=glm, aes(y=Height.cm..x, x=Height.cm..y))+
  ggtitle("a)")+
  ylab(expression("Height year"[y]))+
  xlab(expression("Height year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)


ggwidth <- ggplot(sg.xy[grep("old",sg.xy$Site,invert = TRUE), ], aes(colour = Site))+
  stat_smooth(method=glm, aes(y=Width.cm..x, x=Width.cm..y))+
  ggtitle("b)")+
  ylab(expression("Width year"[y]))+
  xlab(expression("Width year"[y-1]))+
  theme_bw() +
  facet_grid(~NS)


ggsave(filename = paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Fig5a_b.jpg", sep=""),
ggheight/ggwidth,
       width=200, height=230,units='mm', dpi=300)
  

```




# Plant Size
```{r}

summary(lm(Height.cm..x ~ Height.cm..y*NS, data=sg.xy[sg.xy$Height.cm..x != 0 & 
                                                        sg.xy$Height.cm..y != 0,]))
0.930089 + 0.004730
0.927771 + 0.004654
summary(lm(Width.cm..x ~ Width.cm..y*NS, data=sg.xy[sg.xy$Width.cm..x != 0 & 
                                                        sg.xy$Width.cm..y != 0,]))
0.956704 + -0.069552 
0.955013 + -0.063365

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/",currentYr,"Figure6HeigthWidthScGlScDa.jpg", sep=""),
sg.xy %>%
  filter(Height.cm..x != 0 & Height.cm..y != 0) %>%
ggplot(  aes(Height.cm..y, Height.cm..x, color = NS))+
  geom_point(alpha = 0.5, pch = 16)+
  stat_smooth(method = "lm")+
  ylab(expression("Height cm year"[t+1])) +
	xlab(expression("Height cm year"[t]))+
  theme_bw()+
  ggtitle("a)")
+
sg.xy %>%
  filter(Width.cm..x != 0 & Width.cm..y != 0) %>%
ggplot(  aes(Width.cm..y, Width.cm..x, color = NS))+
  geom_point(alpha = 0.5, pch = 16)+
  stat_smooth(method = "lm")+
  ylab(expression("Width cm year"[t+1])) +
	xlab(expression("Width cm year"[t]))+
  theme_bw()+
  ggtitle("b)")
,
width = 200, height = 80, units = 'mm', dpi=300)

summary(lm(Prepro~(avgH+medianW)^2, data=sg_sum))
```



Annual report figure for Becky - 20180123
```{r}
scgl.c.summary <- aggregate(scgl.c[,c("ppt","tmax","tmin")],
                            scgl.c[,c("Site","Prev12","season")],
                            FUN = function(x) mean(x, na.rm = TRUE))
scgl.c.summary.ppt <- aggregate(scgl.c[,"ppt"],
                            scgl.c[,c("Site","Prev12","season")],
                            FUN = function(x) sum(x, na.rm = TRUE))


plotout <- aggregate(X~Year+Site, data=sg_sum, FUN = sum)
annualppt <- aggregate(ppt~Site+Prev12, data=scgl.c.summary, FUN = sum)
#Average total precipitation over sites
annualppt.avg <- aggregate(ppt~Prev12, data=annualppt, FUN= mean)
avgppt <- mean(annualppt.avg$ppt)
plotout1 <- merge(plotout, annualppt.avg, by.x = "Year", by.y = "Prev12")
plotout1$col[plotout1$ppt<avgppt] <- "Below Average PPT"
plotout1$col[plotout1$ppt>=avgppt] <- "Above Average PPT"
plotout1$growth <- plotout1$X-plotout1$X[1]
plotout1$change <- c(0,plotout1$X[-1]-plotout1$X[-length(plotout1$X)])

ggplot(plotout1, aes(Year,X))+
  geom_bar(stat= "identity", aes(fill=col))+
  theme_classic()+
  facet_wrap(~Site)

## But that is because we added sites in 2008, 2010, 2012, and 2013
ggplot(plotout1[plotout1$Year>2008,], aes(Year,change))+
  geom_bar(stat= "identity", aes(fill=col))+
  theme_classic()+
  ggtitle("Change in population size from previous year")+
  scale_x_continuous(breaks=seq(2009,currentYr,5)) +
  facet_wrap(~Site)

ggsave(paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/ScGl_yr.jpg", sep=""),device="jpeg",
       ggplot(plotout1, aes(Year,X, color=as.factor(Site)))+
         # geom_line(colour="blue")+
         geom_line()+
         ylab("Total Population")+
         scale_x_continuous(breaks=seq(2008,currentYr,1))+
         theme_classic()+
         ggtitle("Sclerocactus glaucus"))

write.csv(plotout1, paste(userpath, "Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Sclerocactus-glaucus/Sclerocactus-glaucus_AnnualReports/",currentYr,"_Sclerocactus-glaucus_AnnualReport/ScGl_data.csv", sep=""))
```
